<?php
if (!defined('ABSPATH')) exit;

/**
 * MCO Data Engine: Provides structured JSON configuration for the React App.
 */

if (!function_exists('mco_get_exam_app_url')) {
    function mco_get_exam_app_url() {
        $urls = get_option('mco_exam_app_url', '');
        $url_list = preg_split('/\r\n|\r|\n/', $urls);
        return trim($url_list[0] ?? '');
    }
}

if (!function_exists('mco_get_default_certificate_templates')) {
    function mco_get_default_certificate_templates() { 
        return [
            'cert-practice' => [
                'id' => 'cert-practice', 'name' => 'Default Practice Certificate', 
                'title' => 'Certificate of Proficiency', 
                'body' => "This certifies that <strong>{candidateName}</strong> has successfully demonstrated proficiency in the <strong>{examName}</strong> practice exam, achieving a score of <strong>{finalScore}%</strong>.",
                'signature1Name' => 'Amelia Reed', 'signature1Title' => 'Program Director', 'signature1ImageUrl' => ''
            ],
            'cert-completion' => [
                'id' => 'cert-completion', 'name' => 'Default Completion Certificate', 
                'title' => 'Certificate of Achievement', 
                'body' => "This is to certify that <strong>{candidateName}</strong> has successfully completed the rigorous requirements of the <strong>{examName}</strong> and is hereby awarded this certificate upon achieving a passing score of <strong>{finalScore}%</strong>.",
                'signature1Name' => 'Amelia Reed', 'signature1Title' => 'Program Director', 'signature1ImageUrl' => '',
                'signature2Name' => 'John Doe', 'signature2Title' => 'Lead Instructor', 'signature2ImageUrl' => ''
            ]
        ]; 
    }
}

if (!function_exists('mco_get_full_snapshot_data')) {
    function mco_get_full_snapshot_data($is_blueprint = false) {
        $dynamic_data_raw = mco_fetch_and_process_dynamic_app_data();
        $logo_url = (string)get_option('mco_custom_logo_url', '');
        if (empty($logo_url)) {
            $custom_logo_id = get_theme_mod('custom_logo');
            $image = $custom_logo_id ? wp_get_attachment_image_src($custom_logo_id, 'full') : false;
            $logo_url = (string)($image[0] ?? '');
        }

        $host = (string)parse_url(get_bloginfo('url'), PHP_URL_HOST);
        $org_id = 'org-' . sanitize_title($host);

        $snapshot = [
            "version" => (string)get_option('mco_config_version', current_time('YmdHis')),
            "organizations" => [[
                "id" => $org_id,
                "name" => (string)get_bloginfo('name'),
                "website" => $host,
                "address" => (string)get_option('mco_organization_address', ''),
                "logoUrl" => $logo_url,
                "introVideoUrl" => (string)get_option('mco_intro_video_url', ''),
                "availableThemes" => mco_get_available_themes(),
                "activeThemeId" => (string)get_option('mco_active_theme_id', 'default'),
                "certificateThemeId" => (string)get_option('mco_certificate_theme_id', 'classic'),
                "subscriptionsEnabled" => get_option('mco_subscriptions_enabled', '1') === '1',
                "bundlesEnabled" => get_option('mco_bundles_enabled', '1') === '1',
                "purchaseNotifierEnabled" => get_option('mco_purchase_notifier_enabled', '1') === '1',
                "purchaseNotifierDelay" => (int)get_option('mco_purchase_notifier_delay', '7'),
                "purchaseNotifierMinGap" => (int)get_option('mco_purchase_notifier_min_gap', '8'),
                "purchaseNotifierMaxGap" => (int)get_option('mco_purchase_notifier_max_gap', '23'),
                "disclaimerText" => (string)get_option('mco_disclaimer_text', ''),
                "exams" => (array)($dynamic_data_raw['exams'] ?? []),
                "examProductCategories" => (array)($dynamic_data_raw['examProductCategories'] ?? []),
                "suggestedBooks" => (array)($dynamic_data_raw['suggestedBooks'] ?? []),
                "certificateTemplates" => array_values(get_option('mco_certificate_templates', mco_get_default_certificate_templates()))
            ]],
            "examPrices" => (array)($dynamic_data_raw['examPrices'] ?? [])
        ];

        if ($is_blueprint) {
            $snapshot['organizations'][0]['exams'] = [];
            $snapshot['organizations'][0]['examProductCategories'] = [];
            $snapshot['organizations'][0]['suggestedBooks'] = [];
            $snapshot['examPrices'] = [];
        }
        return $snapshot;
    }
}

if (!function_exists('mco_fetch_and_process_dynamic_app_data')) {
    function mco_fetch_and_process_dynamic_app_data() {
        $exams = []; $cats = []; $prices = []; $books = [];
        if (!class_exists('WooCommerce')) return ['exams'=>[], 'examProductCategories'=>[], 'examPrices'=>[], 'suggestedBooks'=>[]];

        // INCLUSIVE QUERY: Fetch everything so admins see all content
        $program_posts = get_posts([
            'post_type' => 'mco_exam_program', 
            'posts_per_page' => -1, 
            'post_status' => ['publish', 'draft', 'private', 'future', 'pending']
        ]);

        foreach ($program_posts as $p) {
            $sku = (string)get_post_meta($p->ID, '_mco_certification_exam_sku', true);
            $addon_sku = (string)get_post_meta($p->ID, '_mco_addon_sku', true);
            $question_source_url = (string)get_post_meta($p->ID, '_mco_question_source_url', true);
            $practice_exam_id = 'prac-'.$p->ID;

            // 1. PRACTICE EXAM (ALWAYS EXISTS PER PROGRAM)
            $exams[] = [
                'id' => $practice_exam_id, 
                'name' => (string)(get_post_meta($p->ID, '_mco_practice_exam_title_override', true) ?: $p->post_title . ' Practice'),
                'description' => wp_kses_post((string)$p->post_content),
                'numberOfQuestions' => (int)get_post_meta($p->ID, '_mco_practice_questions', true) ?: 20,
                'durationMinutes' => (int)get_post_meta($p->ID, '_mco_practice_duration', true) ?: 30,
                'passScore' => 70, 
                'isPractice' => true, 
                'productSku' => '',
                'questionSourceUrl' => esc_url_raw($question_source_url),
                'certificateEnabled' => get_post_meta($p->ID, '_mco_practice_certificate_enabled', true) === '1',
                'recommendedBookIds' => []
            ];

            // 2. CERTIFICATION EXAM (ONLY IF SKU IS PRESENT)
            if ($sku) {
                $product_id = wc_get_product_id_by_sku($sku);
                $product = $product_id ? wc_get_product($product_id) : null;
                
                $exams[] = [
                    'id' => $sku, 
                    'name' => (string)(get_post_meta($p->ID, '_mco_cert_exam_title_override', true) ?: $p->post_title),
                    'description' => wp_kses_post((string)$p->post_content),
                    'numberOfQuestions' => (int)get_post_meta($p->ID, '_mco_cert_questions', true) ?: 50,
                    'durationMinutes' => (int)get_post_meta($p->ID, '_mco_cert_duration', true) ?: 90,
                    'passScore' => (int)get_post_meta($p->ID, '_mco_pass_score', true) ?: 70, 
                    'isPractice' => false, 
                    'productSku' => $sku,
                    'addonSku' => $addon_sku,
                    'price' => $product ? (float)$product->get_price() : 0, 
                    'regularPrice' => $product ? (float)$product->get_regular_price() : 0,
                    'certificateEnabled' => get_post_meta($p->ID, '_mco_certificate_enabled', true) === '1',
                    'isProctored' => get_post_meta($p->ID, '_mco_is_proctored', true) === '1',
                    'questionSourceUrl' => esc_url_raw($question_source_url),
                    'productSlug' => $product ? (string)$product->get_slug() : ''
                ];
            }

            // 3. PROGRAM CATEGORY MAPPING
            $cats[] = [
                'id' => 'prod-'.$p->ID, 
                'name' => (string)$p->post_title, 
                'description' => wp_kses_post((string)$p->post_content), 
                'practiceExamId' => $practice_exam_id, 
                'certificationExamId' => $sku ?: '',
                'questionSourceUrl' => esc_url_raw($question_source_url)
            ];
        }

        // PRICE INDEXING
        $product_query = new WC_Product_Query(['status' => ['publish', 'draft', 'private'], 'limit' => -1]);
        $all_products = $product_query->get_products();
        foreach ($all_products as $product) {
            $psku = $product->get_sku();
            if (!$psku) continue;
            $prices[$psku] = [
                'productId' => (string)$product->get_id(), 
                'sku' => $psku, 
                'price' => (float)$product->get_price(), 
                'regularPrice' => (float)$product->get_regular_price(), 
                'name' => (string)$product->get_name(), 
                'type' => (string)$product->get_type(), 
                'isBundle' => (get_post_meta($product->get_id(), '_mco_is_bundle', true) === 'yes' || $product->is_type('bundle')), 
                'status' => $product->get_status(), 
                'bundledSkus' => (array)get_post_meta($product->get_id(), '_mco_bundled_skus', true) ?: []
            ];
        }

        // BOOKS
        $book_posts = get_posts(['post_type' => 'mco_recommended_book', 'posts_per_page' => -1, 'post_status' => 'any']);
        foreach ($book_posts as $bp) {
            $books[] = [
                'id' => (string)get_post_meta($bp->ID, '_mco_book_id', true), 
                'title' => (string)$bp->post_title, 
                'description' => wp_kses_post((string)$bp->post_content), 
                'thumbnailUrl' => (string)get_post_meta($bp->ID, '_mco_thumbnail_url', true), 
                'affiliateLinks' => [
                    'com' => (string)get_post_meta($bp->ID, '_mco_link_com', true) ?: '', 
                    'in' => (string)get_post_meta($bp->ID, '_mco_link_in', true) ?: '', 
                    'ae' => (string)get_post_meta($bp->ID, '_mco_link_ae', true) ?: ''
                ]
            ];
        }
        
        return ['exams' => $exams, 'examProductCategories' => $cats, 'examPrices' => $prices, 'suggestedBooks' => $books];
    }
}

if (!function_exists('mco_get_app_config_data')) {
    function mco_get_app_config_data() {
        $version = (string)get_option('mco_config_version', '0');
        $site_id = (string)parse_url(get_bloginfo('url'), PHP_URL_HOST);
        $cache_key = 'mco_app_config_' . md5($site_id . $version);
        $cached = get_transient($cache_key);
        if ($cached !== false) return $cached;
        $data = mco_get_full_snapshot_data(false);
        set_transient($cache_key, $data, DAY_IN_SECONDS);
        return $data;
    }
}

if (!function_exists('mco_get_available_themes')) {
    function mco_get_available_themes() {
        return [['id'=>'default','name'=>'Cyberpunk'], ['id'=>'professional','name'=>'Professional'], ['id'=>'serene','name'=>'Serene'], ['id'=>'academic','name'=>'Academic'], ['id'=>'noir','name'=>'Noir']];
    }
}
?>