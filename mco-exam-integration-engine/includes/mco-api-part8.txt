/**
 * 9. PUBLIC: Industrial Certificate Authenticator
 * This function performs a deep-scan of the database to verify certificate 
 * authenticity based on a truncated MD5 hash of the unique Test ID.
 */
function mco_api_verify_certificate(WP_REST_Request $request) {
    $certId = strtoupper(sanitize_text_field($request->get_param('certId')));
    if (empty($certId)) return new WP_Error('invalid', 'ID Required', ['status' => 400]);

    global $wpdb;
    
    // Scan usermeta for all MCO result arrays
    $query = "SELECT user_id, meta_value FROM {$wpdb->usermeta} WHERE meta_key = 'mco_exam_results'";
    $rows = $wpdb->get_results($query);
    
    if (!$rows) return new WP_Error('not_found', 'No results found in system.', ['status' => 404]);

    foreach ($rows as $row) {
        $results = maybe_unserialize($row->meta_value);
        if (is_array($results)) {
            foreach ($results as $res) {
                if (!isset($res['testId'])) continue;
                
                // The Certificate ID is defined as the first 12 chars of the Test ID's MD5
                $calculatedId = strtoupper(substr(md5($res['testId']), 0, 12));
                
                if ($calculatedId === $certId) {
                    $u = get_userdata($row->user_id);
                    $timestamp = $res['timestamp'] ?? time();
                    
                    // Return full verification payload
                    return new WP_REST_Response([
                        'success'       => true,
                        'candidateName' => $u ? $u->display_name : 'Anonymous User',
                        'examName'      => $res['examId'] ?? 'Professional Certification',
                        'finalScore'    => (float)($res['score'] ?? 0),
                        'date'          => date('F j, Y', (int)($timestamp / 1000)),
                        'verificationStatus' => 'Authentic'
                    ], 200);
                }
            }
        }
    }
    
    return new WP_Error('not_found', 'Invalid or expired Certificate ID.', ['status' => 404]);
}
