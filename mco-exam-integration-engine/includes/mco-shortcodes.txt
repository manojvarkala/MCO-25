<?php
if (!defined('ABSPATH')) exit;

// --- SHORTCODE REGISTRATION ---
if (!function_exists('mco_register_shortcode_hooks')) {
    function mco_register_shortcode_hooks() {
        add_shortcode('mco_exam_showcase', 'mco_shortcode_exam_showcase');
        add_shortcode('mco_book_showcase', 'mco_shortcode_book_showcase');
        add_shortcode('mco_news_slider', 'mco_shortcode_news_slider');
        add_action('wp_enqueue_scripts', 'mco_enqueue_styles');
    }
}

// --- STYLESHEET ENQUEUE ---
if (!function_exists('mco_enqueue_styles')) {
    function mco_enqueue_styles() {
        if (is_a(get_post(), 'WP_Post') && (has_shortcode(get_post()->post_content, 'mco_exam_showcase') || has_shortcode(get_post()->post_content, 'mco_book_showcase') || has_shortcode(get_post()->post_content, 'mco_news_slider'))) {
            wp_enqueue_style('mco-styles', MCO_PLUGIN_URL . 'assets/mco-styles.css', [], MCO_PLUGIN_VERSION);
        }
    }
}

// --- NEWS SLIDER SHORTCODE ---
if (!function_exists('mco_shortcode_news_slider')) {
    function mco_shortcode_news_slider($atts) {
        $atts = shortcode_atts(['posts_per_page' => 10], $atts);
        $query = new WP_Query(['post_type' => 'post', 'posts_per_page' => $atts['posts_per_page'], 'post_status' => 'publish']);
        if (!$query->have_posts()) return '<p>No recent news found.</p>';
        
        $slider_id = 'mco-news-slider-' . uniqid();

        ob_start();
        ?>
        <div id="<?php echo esc_attr($slider_id); ?>" class="mco-news-slider-wrapper">
            <div class="mco-news-slider-container">
                <div class="mco-news-slider-track">
                    <?php while ($query->have_posts()) : $query->the_post(); ?>
                        <div class="mco-news-slide">
                            <a href="<?php the_permalink(); ?>" class="mco-news-card">
                                <?php if (has_post_thumbnail()) : ?>
                                    <div class="mco-news-card-image">
                                        <?php the_post_thumbnail('medium_large'); ?>
                                    </div>
                                <?php endif; ?>
                                <div class="mco-news-card-content">
                                    <h3 class="mco-news-card-title"><?php the_title(); ?></h3>
                                    <div class="mco-news-card-excerpt">
                                        <?php the_excerpt(); ?>
                                    </div>
                                    <span class="mco-news-card-link">Read More &rarr;</span>
                                </div>
                            </a>
                        </div>
                    <?php endwhile; wp_reset_postdata(); ?>
                </div>
            </div>
            <div class="mco-news-slider-pagination"></div>
        </div>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sliderWrapper = document.getElementById('<?php echo esc_js($slider_id); ?>');
            if (!sliderWrapper) return;

            const track = sliderWrapper.querySelector('.mco-news-slider-track');
            const slides = sliderWrapper.querySelectorAll('.mco-news-slide');
            const paginationContainer = sliderWrapper.querySelector('.mco-news-slider-pagination');
            
            if (slides.length <= 1) return;

            let currentIndex = 0;
            let intervalId;

            slides.forEach((_, index) => {
                const dot = document.createElement('button');
                dot.classList.add('mco-news-slider-dot');
                if (index === 0) dot.classList.add('active');
                dot.addEventListener('click', () => {
                    currentIndex = index;
                    scrollToSlide();
                    resetInterval();
                });
                paginationContainer.appendChild(dot);
            });

            const dots = paginationContainer.querySelectorAll('.mco-news-slider-dot');

            const updateDots = () => {
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentIndex);
                });
            };

            const scrollToSlide = () => {
                const slideWidth = slides[0].offsetWidth;
                track.style.transform = `translateX(-${currentIndex * slideWidth}px)`;
                updateDots();
            };

            const nextSlide = () => {
                currentIndex = (currentIndex + 1) % slides.length;
                scrollToSlide();
            };

            const startInterval = () => {
                intervalId = setInterval(nextSlide, 5000);
            };

            const resetInterval = () => {
                clearInterval(intervalId);
                startInterval();
            };
            
            sliderWrapper.addEventListener('mouseenter', () => clearInterval(intervalId));
            sliderWrapper.addEventListener('mouseleave', startInterval);

            startInterval();
            
            // Adjust on resize
            window.addEventListener('resize', scrollToSlide);
        });
        </script>
        <?php
        return ob_get_clean();
    }
}


// --- EXAM SHOWCASE SHORTCODE ---
if (!function_exists('mco_shortcode_exam_showcase')) {
    function mco_shortcode_exam_showcase() {
        $query = new WP_Query(['post_type' => 'mco_exam_program', 'posts_per_page' => -1, 'post_status' => 'publish', 'orderby' => 'title', 'order' => 'ASC']);
        if (!$query->have_posts()) return '<p>No exam programs are available at this time.</p>';

        ob_start();
        $gradients = ['card-gradient-1', 'card-gradient-2', 'card-gradient-3', 'card-gradient-4'];
        $i = 0;
        ?>
        <div class="mco-showcase-grid">
            <?php while ($query->have_posts()) : $query->the_post();
                $post_id = get_the_ID();
                $cert_sku = get_post_meta($post_id, '_mco_certification_exam_sku', true);
                if (empty($cert_sku)) continue;

                $product_id = wc_get_product_id_by_sku($cert_sku);
                $product = $product_id ? wc_get_product($product_id) : null;
                $practice_exam_id = $cert_sku . '-practice';
                
                $gradient_class = $gradients[$i % count($gradients)];
                $i++;
            ?>
            <div class="mco-card <?php echo esc_attr($gradient_class); ?>">
                <div class="mco-card-body">
                    <h3 class="mco-card-title"><?php the_title(); ?></h3>
                    <p class="mco-card-description"><?php echo wp_strip_all_tags(get_the_content()); ?></p>
                </div>
                <div class="mco-card-footer">
                    <a href="/exam-app/#/test/<?php echo esc_attr($practice_exam_id); ?>" class="mco-card-btn btn-secondary">Start Practice</a>
                    <?php if ($product): ?>
                        <a href="<?php echo esc_url(get_permalink($product_id)); ?>" class="mco-card-btn btn-secondary">View Details</a>
                        <a href="/exam-app/#/checkout/<?php echo esc_attr($product->get_slug()); ?>" class="mco-card-btn btn-primary">Purchase Exam</a>
                    <?php else: ?>
                         <a href="#" class="mco-card-btn btn-secondary disabled">Details N/A</a>
                         <a href="#" class="mco-card-btn btn-primary disabled">Unavailable</a>
                    <?php endif; ?>
                </div>
            </div>
            <?php endwhile; wp_reset_postdata(); ?>
        </div>
        <?php
        return ob_get_clean();
    }
}

// --- BOOKSTORE SHOWCASE SHORTCODE ---
if (!function_exists('mco_shortcode_book_showcase')) {
    function mco_shortcode_book_showcase() {
        $query = new WP_Query(['post_type' => 'mco_recommended_book', 'posts_per_page' => -1, 'post_status' => 'publish', 'orderby' => 'title', 'order' => 'ASC']);
        if (!$query->have_posts()) return '<p>No recommended books are available.</p>';
        
        ob_start();
        $gradients = ['card-gradient-4', 'card-gradient-3', 'card-gradient-2', 'card-gradient-1']; // Reverse order for variety
        $i = 0;
        ?>
        <div class="mco-showcase-grid">
            <?php while ($query->have_posts()) : $query->the_post();
                $post_id = get_the_ID();
                $link_com = get_post_meta($post_id, '_mco_link_com', true);
                $link_in = get_post_meta($post_id, '_mco_link_in', true);
                $link_ae = get_post_meta($post_id, '_mco_link_ae', true);

                $gradient_class = $gradients[$i % count($gradients)];
                $i++;
            ?>
            <div class="mco-card <?php echo esc_attr($gradient_class); ?>">
                <div class="mco-card-body">
                    <h3 class="mco-card-title"><?php the_title(); ?></h3>
                    <p class="mco-card-description"><?php echo wp_strip_all_tags(get_the_content()); ?></p>
                </div>
                <div class="mco-card-footer">
                    <?php if (!empty($link_com)): ?>
                        <a href="<?php echo esc_url($link_com); ?>" target="_blank" rel="noopener noreferrer" class="mco-card-btn btn-primary">Buy on Amazon.com</a>
                    <?php endif; ?>
                    <?php if (!empty($link_in)): ?>
                        <a href="<?php echo esc_url($link_in); ?>" target="_blank" rel="noopener noreferrer" class="mco-card-btn btn-secondary">Buy on Amazon.in</a>
                    <?php endif; ?>
                    <?php if (!empty($link_ae)): ?>
                        <a href="<?php echo esc_url($link_ae); ?>" target="_blank" rel="noopener noreferrer" class="mco-card-btn btn-secondary">Buy on Amazon.ae</a>
                    <?php endif; ?>
                </div>
            </div>
            <?php endwhile; wp_reset_postdata(); ?>
        </div>
        <?php
        return ob_get_clean();
    }
}
?>