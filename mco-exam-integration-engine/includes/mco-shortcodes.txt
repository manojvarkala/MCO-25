<?php
if (!defined('ABSPATH')) exit;

// --- COMPATIBILITY LAYER ---
// Bridges the gap between these shortcodes and the core API/Data functions
if (!function_exists('mco_get_exam_app_url')) {
    function mco_get_exam_app_url() {
        $urls = get_option('mco_exam_app_url', '');
        $url_list = preg_split('/\r\n|\r|\n/', $urls);
        return trim($url_list[0]); // Return the first configured URL
    }
}
if (!function_exists('mco_get_app_config_data')) {
    function mco_get_app_config_data() {
        if (function_exists('mco_fetch_and_prepare_data')) {
            return mco_fetch_and_prepare_data();
        }
        return [];
    }
}
if (!function_exists('mco_generate_exam_jwt')) {
    function mco_generate_exam_jwt($user_id) {
        if (function_exists('mco_generate_jwt')) {
            return mco_generate_jwt(get_user_by('ID', $user_id));
        }
        return null;
    }
}

// --- ICON HELPER ---
function mco_get_svg_icon($name) {
    $icons = [
        'practice' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
        'cert' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>',
        'cart' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>',
        'bundle' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>',
        'check' => '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>',
        'star' => '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
        'book' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
        'user' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
        'lock' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
        'unlock' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',
        'search' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>',
        'filter' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>',
        'arrow-right' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>',
        'chevron-down' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>',
    ];
    return $icons[$name] ?? '';
}

// --- SCOPED CSS GENERATOR ---
// Using a very specific ID selector to prevent conflicts with theme styles
function mco_get_scoped_css() {
    return '<style>
    #mco-app-root { font-family: system-ui, -apple-system, sans-serif; --mco-primary: #0891b2; --mco-primary-hover: #0e7490; --mco-text: #334155; --mco-bg: #fff; --mco-border: #e2e8f0; color: #334155; line-height: 1.5; }
    #mco-app-root *, #mco-app-root *::before, #mco-app-root *::after { box-sizing: border-box; }
    
    /* Form Container */
    #mco-app-root .mco-form-container { max-width: 480px; margin: 2rem auto; padding: 2.5rem; background-color: var(--mco-bg); border: 1px solid var(--mco-border); border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,.05); }
    #mco-app-root h2 { font-size: 1.5rem; font-weight: 700; color: #1e293b; margin: 0 0 1rem 0; text-align: center; border: none; }
    #mco-app-root label { font-weight: 600; color: var(--mco-text); display: block; margin-bottom: 0.5rem; font-size: 1rem; }
    #mco-app-root input[type="text"], #mco-app-root input[type="password"] { width: 100%; padding: 0.75rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 1rem; background: #fff; color: #333; }
    #mco-app-root input[type="submit"], #mco-app-root button, #mco-app-root .mco-button { width: 100%; padding: 0.75rem; border: none; border-radius: 0.5rem; background-color: var(--mco-primary); color: white; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-block; text-decoration: none; text-align: center; font-size: 1rem; line-height: 1.5; }
    #mco-app-root input[type="submit"]:hover, #mco-app-root button:hover, #mco-app-root .mco-button:hover { background-color: var(--mco-primary-hover); color: white; }
    #mco-app-root .mco-button--secondary { background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; }
    #mco-app-root .mco-button--secondary:hover { background-color: #e2e8f0; color: #1e293b; }

    /* Showcase Grid */
    #mco-app-root .mco-showcase-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    #mco-app-root .mco-program-group { background: #fff; border: 1px solid var(--mco-border); border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    #mco-app-root .mco-program-group__title { font-size: 1.25rem; font-weight: 700; color: #0f172a; margin: 0 0 0.5rem 0; border: none; }
    #mco-app-root .mco-program-group__desc { color: #64748b; margin-bottom: 1.5rem; font-size: 0.875rem; }
    #mco-app-root .mco-program-group__cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 1rem; }
    
    /* Cards */
    #mco-app-root .mco-card { display: flex; flex-direction: column; color: white; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -2px rgba(0,0,0,.06); }
    #mco-app-root .mco-card__header { padding: 1rem; font-weight: 600; text-transform: uppercase; background: rgba(0,0,0,0.1); display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; letter-spacing: 0.05em; }
    #mco-app-root .mco-card__body { padding: 1.5rem; flex: 1; }
    #mco-app-root .mco-card__subtitle { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; color: white; line-height: 1.3; }
    #mco-app-root .mco-card__stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; font-size: 0.8rem; background: rgba(0,0,0,0.15); padding: 0.5rem; border-radius: 0.5rem; text-align: center; margin-top: 1rem; }
    #mco-app-root .mco-card__footer { padding: 1rem; margin-top: auto; background: rgba(0,0,0,0.05); }
    #mco-app-root .mco-card__action-btn { display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; padding: 0.75rem; background: white; color: #1e293b; font-weight: 700; border-radius: 0.5rem; text-align: center; text-decoration: none; transition: all 0.2s; border: none; font-size: 0.9rem; }
    #mco-app-root .mco-card__action-btn:hover { background-color: #f8fafc; transform: translateY(-1px); }
    
    /* Gradients */
    #mco-app-root .mco-gradient--practice-1 { background-image: linear-gradient(to top right, #3b82f6, #60a5fa); }
    #mco-app-root .mco-gradient--cert-1 { background-image: linear-gradient(to top right, #059669, #10b981); }
    #mco-app-root .mco-gradient--bundle-sub { background-image: linear-gradient(to top right, #0d9488, #2dd4bf); }
    #mco-app-root .mco-gradient--bundle-practice { background-image: linear-gradient(to top right, #f97316, #fb923c); }
    #mco-app-root .mco-gradient--sub-monthly { background-image: linear-gradient(to top right, #0891b2, #22d3ee); }
    #mco-app-root .mco-gradient--sub-yearly { background-image: linear-gradient(to top right, #6d28d9, #8b5cf6); }

    /* Book Grid */
    #mco-app-root .mco-book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
    #mco-app-root .mco-book-card { background: #fff; border: 1px solid var(--mco-border); border-radius: 0.75rem; overflow: hidden; display: flex; flex-direction: column; }
    #mco-app-root .mco-book-cover { height: 200px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    #mco-app-root .mco-book-card__body { padding: 1rem; flex: 1; }
    #mco-app-root .mco-book-card__title { font-weight: 700; color: #1e293b; margin-bottom: 0.5rem; font-size: 1rem; margin-top: 0; border: none; }
    #mco-app-root .mco-book-card__desc { font-size: 0.875rem; color: #64748b; line-height: 1.5; margin-bottom: 0; }
    #mco-app-root .mco-book-card__footer { padding: 1rem; border-top: 1px solid var(--mco-border); }
    #mco-app-root .mco-book-btn { display: block; width: 100%; padding: 0.6rem; text-align: center; background: #f1f5f9; color: #475569; border-radius: 0.5rem; font-weight: 600; font-size: 0.875rem; text-decoration: none; border: 1px solid #e2e8f0; }
    #mco-app-root .mco-book-btn--primary { background: #facc15; color: #1e293b; border-color: #facc15; }
    #mco-app-root .mco-book-btn:hover { opacity: 0.9; }
    </style>';
}

// --- PROCEDURAL COVER LOGIC ---
function mco_render_procedural_cover($book) {
    $colors = ['#0369a1', '#059669', '#be185d', '#7e22ce', '#334155'];
    $bg = $colors[rand(0, 4)];
    return '<div style="width:100%;height:100%;background:'.$bg.';color:white;display:flex;align-items:center;justify-content:center;padding:10px;text-align:center;font-weight:bold;">'.esc_html($book['title']).'</div>';
}

// --- NEW HELPER FOR GEO-TARGETED LINKS ---
function mco_get_geo_primary_link_info($links) {
    if (empty($links) || !is_array($links)) return null;
    $links = array_filter($links);
    if (empty($links)) return null;

    $priority = ['in', 'ae', 'com'];
    
    foreach ($priority as $key) {
        if (!empty($links[$key])) {
            $store_map = ['com' => 'Amazon.com', 'in' => 'Amazon.in', 'ae' => 'Amazon.ae'];
            return [ 'key' => $key, 'url' => $links[$key], 'domainName' => $store_map[$key] ];
        }
    }
    
    $first_key = array_key_first($links);
    if ($first_key) {
        $store_map = ['com' => 'Amazon.com', 'in' => 'Amazon.in', 'ae' => 'Amazon.ae'];
        return [ 'key' => $first_key, 'url' => $links[$first_key], 'domainName' => $store_map[$first_key] ?? 'Amazon.com' ];
    }
    
    return null;
}

// --- LOGIN SHORTCODE ---
function mco_exam_login_shortcode() {
    // Handle Name Update Post-Login
    if (is_user_logged_in() && isset($_POST['mco_update_name_nonce']) && wp_verify_nonce($_POST['mco_update_name_nonce'], 'mco_update_name_action')) {
        $full_name = sanitize_text_field($_POST['full_name']);
        if (!empty($full_name) && strpos(trim($full_name), ' ') !== false) {
            $user_id = get_current_user_id();
            wp_update_user(['ID' => $user_id, 'display_name' => $full_name]);
            $name_parts = explode(' ', $full_name, 2);
            update_user_meta($user_id, 'first_name', $name_parts[0]);
            if (isset($name_parts[1])) {
                update_user_meta($user_id, 'last_name', $name_parts[1]);
            }
            return mco_redirect_to_app_with_token();
        } else {
            return mco_render_name_update_form('Please enter your full first and last name.');
        }
    }

    // If Logged In, Check Name & Redirect
    if (is_user_logged_in()) {
        $user = wp_get_current_user();
        if (strpos($user->display_name, ' ') !== false) {
            return mco_redirect_to_app_with_token();
        } else {
            return mco_render_name_update_form();
        }
    }

    // Logged Out Logic: IMMEDIATELY REDIRECT TO WP LOGIN
    // Using JS redirect for safety if headers are already sent
    $login_url = wp_login_url(get_permalink());
    
    if (!headers_sent()) {
        wp_redirect($login_url);
        exit;
    }

    return '<script>window.location.href="' . esc_url($login_url) . '";</script><div id="mco-app-root"><div class="mco-form-container" style="text-align:center;"><p>Redirecting to login...</p><a href="' . esc_url($login_url) . '" class="mco-button">Click here if not redirected</a></div></div>';
}
// --- EXAM SHOWCASE SHORTCODE ---
function mco_exam_showcase_shortcode($atts) {
    $atts = shortcode_atts(['id' => ''], $atts, 'exam_program');
    $program_id_str = sanitize_text_field($atts['id']);
    
    $query_args = ['post_type' => 'mco_exam_program', 'posts_per_page' => -1, 'post_status' => 'publish', 'orderby' => 'title', 'order' => 'ASC'];
    if (!empty($program_id_str)) {
        $post_id_from_app_id = (int) str_replace('prod-', '', $program_id_str);
        if ($post_id_from_app_id > 0) $query_args['p'] = $post_id_from_app_id;
        else { $query_args['name'] = $program_id_str; $query_args['posts_per_page'] = 1; }
    }
    
    $programs = get_posts($query_args);
    if (empty($programs)) return '<p>No exam programs found.</p>';
    
    $config_data = mco_get_app_config_data();
    $app_url = mco_get_exam_app_url();
    if (!$config_data || !$app_url) return '<p>Application is not configured correctly.</p>';

    ob_start();
    
    // Ensure CSS is loaded
    if (function_exists('mco_enqueue_shortcode_styles')) {
         $css_path = MCO_PLUGIN_PATH . 'assets/mco-styles.css';
         if (file_exists($css_path)) {
             echo '<style>' . file_get_contents($css_path) . '</style>';
         }
    }
    
    $subscriptions_enabled = get_option('mco_subscriptions_enabled', '1') === '1';
    $bundles_enabled = get_option('mco_bundles_enabled', '1') === '1';
    $is_subscribed = (is_user_logged_in() && class_exists('WC_Subscriptions') && function_exists('wcs_user_has_subscription') && wcs_user_has_subscription(get_current_user_id(), '', 'active'));
    
    echo '<div class="mco-showcase-layout">';
    echo '<div class="mco-showcase-main">';
    
    if (!$is_subscribed && empty($program_id_str) && $subscriptions_enabled) {
        $monthly_sub = $config_data['examPrices']['sub-monthly'] ?? null;
        $yearly_sub = $config_data['examPrices']['sub-yearly'] ?? null;
        if (($monthly_sub && isset($monthly_sub['productId'])) || ($yearly_sub && isset($yearly_sub['productId']))) {
            echo '<div class="mco-subscription-grid">';
            if ($monthly_sub && isset($monthly_sub['productId'])) {
                $monthly_url = get_site_url() . '/cart/?add-to-cart=' . $monthly_sub['productId'];
                echo '<div class="mco-card mco-gradient--sub-monthly"><h3 class="mco-sub-card__title">Monthly Subscription</h3><p class="mco-sub-card__description">Perfect for focused, short-term preparation.</p><div class="mco-sub-card__price">';
                if (isset($monthly_sub['regularPrice']) && $monthly_sub['regularPrice'] > $monthly_sub['price']) echo '<span style="font-size: 1.25rem; text-decoration: line-through; opacity: 0.7;">$' . number_format_i18n($monthly_sub['regularPrice'], 2) . '</span> ';
                echo '<span class="mco-sub-card__price-value">$' . number_format_i18n($monthly_sub['price'], 2) . '</span><span class="mco-sub-card__price-unit">/month</span></div><ul class="mco-sub-card__features"><li>' . mco_get_svg_icon('check') . '<span>Unlimited Access to ALL Practice Exams</span></li><li>' . mco_get_svg_icon('check') . '<span>Unlimited AI-Powered Feedback & Study Guides</span></li><li>' . mco_get_svg_icon('check') . '<span>Cancel Anytime</span></li></ul><div class="mco-card__footer"><a href="' . esc_url($monthly_url) . '" class="mco-card__button mco-card__button--primary">Subscribe Now</a></div></div>';
            }
            if ($yearly_sub && isset($yearly_sub['productId'])) {
                $yearly_url = get_site_url() . '/cart/?add-to-cart=' . $yearly_sub['productId'];
                echo '<div class="mco-card mco-gradient--sub-yearly mco-card--best-value"><div class="mco-best-value-tag">' . mco_get_svg_icon('star') . ' Best Value</div><h3 class="mco-sub-card__title">Yearly Subscription</h3><p class="mco-sub-card__description">For continuous learning and preparing for multiple certifications.</p><div class="mco-sub-card__price">';
                if (isset($yearly_sub['regularPrice']) && $yearly_sub['regularPrice'] > $yearly_sub['price']) echo '<span style="font-size: 1.25rem; text-decoration: line-through; opacity: 0.7;">$' . number_format_i18n($yearly_sub['regularPrice'], 2) . '</span> ';
                echo '<span class="mco-sub-card__price-value">$' . number_format_i18n($yearly_sub['price'], 2) . '</span><span class="mco-sub-card__price-unit">/year</span></div><p style="text-align:center; font-size: 0.875rem; color: #fcd34d; font-weight: 600;">Saves over 35%!</p><ul class="mco-sub-card__features"><li>' . mco_get_svg_icon('check') . '<span>All Monthly features</span></li><li>' . mco_get_svg_icon('check') . '<span>Access All Exam Programs</span></li><li>' . mco_get_svg_icon('check') . '<span>Billed Annually</span></li></ul><div class="mco-card__footer"><a href="' . esc_url($yearly_url) . '" class="mco-card__button mco-card__button--primary">Subscribe & Save</a></div></div>';
            }
            echo '</div>';
        }
    }

    echo '<div class="mco-showcase-grid">';
    foreach ($programs as $program_post) {
        $app_program_id = 'prod-' . $program_post->ID;
        $program_category = current(array_filter($config_data['examProductCategories'], function($c) use ($app_program_id) { return $c['id'] === $app_program_id; }));
        if (!$program_category) continue;
        
        $practice_exam = current(array_filter($config_data['exams'], function($e) use ($program_category) { return $e['id'] === $program_category['practiceExamId']; }));
        $cert_exam = current(array_filter($config_data['exams'], function($e) use ($program_category) { return $e['id'] === $program_category['certificationExamId']; }));
        
        $program_link_url = rtrim($app_url, '/') . '/program/' . $app_program_id;

        echo '<div class="mco-program-group" id="' . esc_attr($app_program_id) . '"><a href="' . esc_url($program_link_url) . '"><h2 class="mco-program-group__title">' . esc_html($program_category['name']) . '</h2></a><div class="mco-program-group__description">' . $program_category['description'] . '</div><div class="mco-program-group__cards">';

        if ($practice_exam) {
            echo '<div class="mco-card mco-gradient--practice-1"><div class="mco-card__header"><span>' . mco_get_svg_icon('practice') . '</span> Practice Exam</div><div class="mco-card__body"><h3 class="mco-card__subtitle">' . esc_html($practice_exam['name']) . '</h3><div class="mco-card__stats"><span>' . esc_html($practice_exam['numberOfQuestions']) . ' Qs</span><span>' . esc_html($practice_exam['durationMinutes']) . ' Mins</span><span>' . esc_html($practice_exam['passScore']) . '% Pass</span></div></div><div class="mco-card__footer"><a href="' . esc_url(mco_get_exam_app_url() . '/test/' . $practice_exam['id']) . '" class="mco-card__button mco-card__button--primary">Start Practice</a></div></div>';
        }

        if ($cert_exam) {
            $product_id = wc_get_product_id_by_sku($cert_exam['productSku']);
            $is_purchased = false;
            if (is_user_logged_in()) {
                $user_id = get_current_user_id();
                $is_purchased = $is_subscribed || ($product_id ? wc_customer_bought_product('', $user_id, $product_id) : false);
            }
            $button_text = $is_purchased ? 'Start Exam' : 'Add to Cart';
            $button_icon = $is_purchased ? mco_get_svg_icon('practice') : mco_get_svg_icon('cart');
            $button_url = $is_purchased ? mco_get_exam_app_url() . '/test/' . $cert_exam['id'] : ($product_id ? get_site_url() . '/cart/?add-to-cart=' . $product_id : '#');
            $button_class = $is_purchased ? 'mco-card__button--primary' : 'mco-card__button--purchase';

            echo '<div class="mco-card mco-gradient--cert-1"><div class="mco-card__header"><span>' . mco_get_svg_icon('cert') . '</span> Certification Exam</div><div class="mco-card__body"><h3 class="mco-card__subtitle">' . esc_html($cert_exam['name']) . '</h3>';
            if (!$is_purchased && $cert_exam['price'] > 0) {
                echo '<div style="text-align: center; margin-bottom: 1rem;">';
                if ($cert_exam['regularPrice'] > $cert_exam['price']) echo '<span style="font-size: 1.25rem; text-decoration: line-through; opacity: 0.7;">$' . number_format_i18n($cert_exam['regularPrice'], 2) . '</span>';
                echo '<span style="font-size: 2.5rem; font-weight: 800; margin-left: 0.5rem;">$' . number_format_i18n($cert_exam['price'], 2) . '</span></div>';
            }
            echo '<div class="mco-card__stats"><span>' . esc_html($cert_exam['numberOfQuestions']) . ' Qs</span><span>' . esc_html($cert_exam['durationMinutes']) . ' Mins</span><span>' . esc_html($cert_exam['passScore']) . '% Pass</span></div></div><div class="mco-card__footer"><a href="' . esc_url($button_url) . '" class="mco-card__button ' . $button_class . '">' . $button_icon . ' ' . $button_text . '</a></div></div>';

            if ($bundles_enabled) {
                $subscription_bundle_sku = $cert_exam['productSku'] . '-1mo-addon';
                $practice_bundle_sku = $cert_exam['productSku'] . '-1';

                if ($subscriptions_enabled && isset($config_data['examPrices'][$subscription_bundle_sku])) {
                    $bundle_data = $config_data['examPrices'][$subscription_bundle_sku];
                    $bundle_url = isset($bundle_data['productId']) ? get_site_url() . '/cart/?add-to-cart=' . $bundle_data['productId'] : '#';
                    echo '<div class="mco-card mco-gradient--bundle-sub"><div class="mco-card__header"><span>' . mco_get_svg_icon('bundle') . '</span> Exam + Subscription</div><div class="mco-card__body"><h3 class="mco-card__subtitle">Get This Exam PLUS 1-Month Full Access</h3>';
                    if (isset($bundle_data['price'])) {
                        echo '<div style="text-align: center; margin-bottom: 1rem;">';
                        if ($bundle_data['regularPrice'] > $bundle_data['price']) echo '<span style="font-size: 1.25rem; text-decoration: line-through; opacity: 0.7;">$' . number_format_i18n($bundle_data['regularPrice'], 2) . '</span>';
                        echo '<span style="font-size: 2.5rem; font-weight: 800; margin-left: 0.5rem;">$' . number_format_i18n($bundle_data['price'], 2) . '</span></div>';
                    }
                    echo '</div><div class="mco-card__footer"><a href="' . esc_url($bundle_url) . '" class="mco-card__button mco-card__button--purchase">' . mco_get_svg_icon('cart') . ' Purchase Bundle</a></div></div>';
                } elseif (isset($config_data['examPrices'][$practice_bundle_sku])) {
                     $bundle_data = $config_data['examPrices'][$practice_bundle_sku];
                     $bundle_url = isset($bundle_data['productId']) ? get_site_url() . '/cart/?add-to-cart=' . $bundle_data['productId'] : '#';
                     echo '<div class="mco-card mco-gradient--bundle-practice"><div class="mco-card__header"><span>' . mco_get_svg_icon('bundle') . '</span> Exam Bundle</div><div class="mco-card__body"><h3 class="mco-card__subtitle">Get This Exam PLUS 1-Month Practice Access</h3>';
                     if (isset($bundle_data['price'])) {
                         echo '<div style="text-align: center; margin-bottom: 1rem;">';
                         if ($bundle_data['regularPrice'] > $bundle_data['price']) echo '<span style="font-size: 1.25rem; text-decoration: line-through; opacity: 0.7;">$' . number_format_i18n($bundle_data['regularPrice'], 2) . '</span>';
                         echo '<span style="font-size: 2.5rem; font-weight: 800; margin-left: 0.5rem;">$' . number_format_i18n($bundle_data['price'], 2) . '</span></div>';
                     }
                     echo '</div><div class="mco-card__footer"><a href="' . esc_url($bundle_url) . '" class="mco-card__button mco-card__button--purchase">' . mco_get_svg_icon('cart') . ' Purchase Bundle</a></div></div>';
                }
            }
        }
        echo '</div></div>';
    }
    echo '</div>'; // end showcase-grid
    echo '</div>'; // end showcase-main
    echo '<div class="mco-study-hall-sidebar">';
    echo mco_render_study_hall_sidebar();
    echo '</div>'; // end sidebar
    echo '</div>'; // end layout

    return ob_get_clean();
}
// --- BOOK SHOWCASE SHORTCODE ---
function mco_book_showcase_shortcode() {
    $config_data = mco_get_app_config_data();
    if (empty($config_data['suggestedBooks'])) return '<p>No recommended books found.</p>';

    ob_start();
    // Ensure CSS is loaded
    if (function_exists('mco_enqueue_shortcode_styles')) {
         $css_path = MCO_PLUGIN_PATH . 'assets/mco-styles.css';
         if (file_exists($css_path)) {
             echo '<style>' . file_get_contents($css_path) . '</style>';
         }
    }
    
    echo '<div id="mco-app-root"><div class="mco-wrapper"><div class="mco-book-grid">';
    
    foreach ($config_data['suggestedBooks'] as $book) {
        $cover = !empty($book['thumbnailUrl']) ? '<img src="'.esc_url($book['thumbnailUrl']).'" style="width:100%;height:100%;object-fit:cover;">' : mco_render_procedural_cover($book);
        $link = mco_get_geo_primary_link_info($book['affiliateLinks']);
        $btn = $link ? '<a href="'.$link['url'].'" class="mco-book-btn mco-book-btn--primary" target="_blank">Buy on '.$link['domainName'].'</a>' : '<span class="mco-book-btn">Coming Soon</span>';
        
        echo '<div class="mco-book-card">';
        echo '<div class="mco-book-cover">'.$cover.'</div>';
        echo '<div class="mco-book-card__body"><h4 class="mco-book-card__title">'.esc_html($book['title']).'</h4><p class="mco-book-card__desc">'.wp_trim_words($book['description'], 15).'</p></div>';
        echo '<div class="mco-book-card__footer">'.$btn.'</div>';
        echo '</div>';
    }
    echo '</div></div></div>';
    return ob_get_clean();
}

function mco_single_book_shortcode() {
    global $post;
    $config_data = mco_get_app_config_data();
    $book_id_meta = get_post_meta($post->ID, '_mco_book_id', true);
    $book = current(array_filter($config_data['suggestedBooks'], function($b) use ($book_id_meta) { return $b['id'] === $book_id_meta; }));

    if (!$book) return '';

    ob_start();
    echo mco_get_scoped_css();
    
    $cover = !empty($book['thumbnailUrl']) ? '<img src="'.esc_url($book['thumbnailUrl']).'" style="width:100%;height:100%;object-fit:cover;">' : mco_render_procedural_cover($book);
    $link = mco_get_geo_primary_link_info($book['affiliateLinks']);
    $btn = $link ? '<a href="'.$link['url'].'" class="mco-book-btn mco-book-btn--primary" target="_blank">Buy on '.$link['domainName'].'</a>' : '';

    echo '<div id="mco-app-root"><div class="mco-wrapper"><div class="mco-single-book-card">';
    echo '<div class="mco-single-book-card__cover">'.$cover.'</div>';
    echo '<div class="mco-single-book-card__details">';
    echo '<h1>'.esc_html($book['title']).'</h1>';
    echo '<div class="mco-single-book-card__description">'.wp_kses_post(get_post($post->ID)->post_content).'</div>';
    echo '<div class="mco-single-book-card__buttons">'.$btn.'</div>';
    echo '</div></div></div></div>';
    
    return ob_get_clean();
}

function mco_render_study_hall_sidebar() {
    $config_data = mco_get_app_config_data();
    if (empty($config_data['suggestedBooks'])) return '';

    $all_books = $config_data['suggestedBooks'];
    shuffle($all_books);
    $random_books = array_slice($all_books, 0, 5);

    ob_start();
    ?>
    <div class="mco-study-hall-sidebar">
        <h3 class="mco-study-hall-sidebar__title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            <span>Study Hall</span>
        </h3>
        <div class="mco-study-hall-sidebar__grid">
            <?php foreach ($random_books as $book):
                $link_data = mco_get_geo_primary_link_info($book['affiliateLinks']);
                if (!$link_data) continue;

                $book_cover = '';
                if (!empty($book['thumbnailUrl'])) {
                    $book_cover = '<img src="' . esc_url($book['thumbnailUrl']) . '" alt="' . esc_attr($book['title']) . '" style="width:100%; height:100%; object-fit: cover;">';
                } else {
                    $site_host = parse_url(home_url(), PHP_URL_HOST);
                    $book_cover = (strpos($site_host, 'coding-online') !== false) 
                        ? mco_render_mco_procedural_cover_php($book) 
                        : mco_render_annapoorna_procedural_cover_php($book);
                }
            ?>
            <div class="mco-book-card-sidebar">
                <div class="mco-book-card-sidebar__cover"><?php echo $book_cover; ?></div>
                <div class="mco-book-card-sidebar__content">
                    <h4 class="mco-book-card-sidebar__title"><?php echo esc_html($book['title']); ?></h4>
                    <a href="<?php echo esc_url($link_data['url']); ?>" target="_blank" rel="noopener noreferrer" class="mco-book-card-sidebar__button">
                        Buy on <?php echo esc_html($link_data['domainName']); ?>
                    </a>
                </div>
            </div>
            <?php endforeach; ?>
        </div>
        <p class="mco-study-hall-sidebar__disclaimer">
            Using our affiliate links doesn't cost you extra and helps support our platform. Note: Book availability may vary by region. Thank you!
        </p>
    </div>
    <?php
    return ob_get_clean();
}

function mco_exam_login_shortcode() {
    // Handle Name Update Post-Login
    if (is_user_logged_in() && isset($_POST['mco_update_name_nonce']) && wp_verify_nonce($_POST['mco_update_name_nonce'], 'mco_update_name_action')) {
        $full_name = sanitize_text_field($_POST['full_name']);
        if (!empty($full_name) && strpos(trim($full_name), ' ') !== false) {
            $user_id = get_current_user_id();
            wp_update_user(['ID' => $user_id, 'display_name' => $full_name]);
            $name_parts = explode(' ', $full_name, 2);
            update_user_meta($user_id, 'first_name', $name_parts[0]);
            if (isset($name_parts[1])) {
                update_user_meta($user_id, 'last_name', $name_parts[1]);
            }
            return mco_redirect_to_app_with_token();
        } else {
            return mco_render_name_update_form('Please enter your full first and last name.');
        }
    }

    // If Logged In, Check Name & Redirect
    if (is_user_logged_in()) {
        $user = wp_get_current_user();
        if (strpos($user->display_name, ' ') !== false) {
            return mco_redirect_to_app_with_token();
        } else {
            return mco_render_name_update_form();
        }
    }

    // Logged Out Logic: IMMEDIATELY REDIRECT TO WP LOGIN
    // Using JS redirect for safety if headers are already sent
    $login_url = wp_login_url(get_permalink());
    
    if (!headers_sent()) {
        wp_redirect($login_url);
        exit;
    }

    return '<script>window.location.href="' . esc_url($login_url) . '";</script><div id="mco-app-root"><div class="mco-form-container" style="text-align:center;"><p>Redirecting to login...</p><a href="' . esc_url($login_url) . '" class="mco-button">Click here if not redirected</a></div></div>';
}
?>