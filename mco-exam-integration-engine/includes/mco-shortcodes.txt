<?php
if (!defined('ABSPATH')) exit;

// --- SHORTCODE REGISTRATION ---
if (!function_exists('mco_register_shortcode_hooks')) {
    function mco_register_shortcode_hooks() {
        add_shortcode('mco_exam_showcase', 'mco_shortcode_exam_showcase');
        add_shortcode('mco_book_showcase', 'mco_shortcode_book_showcase');
        add_shortcode('mco_news_slider', 'mco_shortcode_news_slider');
        add_action('wp_enqueue_scripts', 'mco_enqueue_styles');
    }
}

// --- STYLESHEET ENQUEUE ---
if (!function_exists('mco_enqueue_styles')) {
    function mco_enqueue_styles() {
        if (is_a(get_post(), 'WP_Post') && (has_shortcode(get_post()->post_content, 'mco_exam_showcase') || has_shortcode(get_post()->post_content, 'mco_book_showcase') || has_shortcode(get_post()->post_content, 'mco_news_slider'))) {
            wp_enqueue_style('mco-styles', MCO_PLUGIN_URL . 'assets/mco-styles.css', [], MCO_PLUGIN_VERSION);
        }
    }
}

// --- NEWS SLIDER SHORTCODE ---
if (!function_exists('mco_shortcode_news_slider')) {
    function mco_shortcode_news_slider($atts) {
        $atts = shortcode_atts(['posts_per_page' => 12], $atts);
        $query = new WP_Query(['post_type' => 'post', 'posts_per_page' => $atts['posts_per_page'], 'post_status' => 'publish', 'ignore_sticky_posts' => 1]);
        if (!$query->have_posts()) return '<p>No recent news found.</p>';
        
        $slider_id = 'mco-news-slider-' . uniqid();

        ob_start();
        ?>
        <div id="<?php echo esc_attr($slider_id); ?>" class="mco-news-slider-wrapper">
            <div class="mco-news-slider-container">
                <div class="mco-news-slider-track">
                    <?php 
                    $gradients = ['card-gradient-1', 'card-gradient-2', 'card-gradient-3', 'card-gradient-4'];
                    $i = 0;
                    while ($query->have_posts()) : $query->the_post(); 
                        $has_image = has_post_thumbnail();
                        $card_class = $has_image ? 'has-image' : 'no-image ' . $gradients[$i % count($gradients)];
                        $i++;
                    ?>
                        <div class="mco-news-slide">
                            <a href="<?php the_permalink(); ?>" class="mco-news-card <?php echo $card_class; ?>">
                                <?php if ($has_image) : ?>
                                    <div class="mco-news-card-image" style="background-image: url('<?php echo esc_url(get_the_post_thumbnail_url(get_the_ID(), 'medium_large')); ?>');"></div>
                                <?php endif; ?>
                                <div class="mco-news-card-content">
                                    <h3 class="mco-news-card-title"><?php the_title(); ?></h3>
                                    <div class="mco-news-card-excerpt">
                                        <?php echo wp_strip_all_tags(get_the_excerpt()); ?>
                                    </div>
                                    <span class="mco-news-card-link">Read More &rarr;</span>
                                </div>
                            </a>
                        </div>
                    <?php endwhile; wp_reset_postdata(); ?>
                </div>
            </div>
            <div class="mco-news-slider-pagination"></div>
        </div>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sliderWrapper = document.getElementById('<?php echo esc_js($slider_id); ?>');
            if (!sliderWrapper) return;

            const container = sliderWrapper.querySelector('.mco-news-slider-container');
            const track = sliderWrapper.querySelector('.mco-news-slider-track');
            const slides = Array.from(sliderWrapper.querySelectorAll('.mco-news-slide'));
            const paginationContainer = sliderWrapper.querySelector('.mco-news-slider-pagination');
            
            if (slides.length <= 1) return;

            let currentIndex = 0;
            let intervalId;
            let slidesPerView = 3;

            const updateSlidesPerView = () => {
                if (window.innerWidth < 640) slidesPerView = 1;
                else if (window.innerWidth < 1024) slidesPerView = 2;
                else slidesPerView = 3;
            };

            const totalPages = Math.ceil(slides.length / slidesPerView);
            
            for (let i = 0; i < totalPages; i++) {
                const dot = document.createElement('button');
                dot.classList.add('mco-news-slider-dot');
                dot.dataset.index = i;
                if (i === 0) dot.classList.add('active');
                dot.addEventListener('click', () => {
                    currentIndex = i;
                    scrollToPage();
                    resetInterval();
                });
                paginationContainer.appendChild(dot);
            }

            const dots = paginationContainer.querySelectorAll('.mco-news-slider-dot');

            const updateDots = () => {
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentIndex);
                });
            };

            const scrollToPage = () => {
                const containerWidth = container.offsetWidth;
                track.style.transform = `translateX(-${currentIndex * containerWidth}px)`;
                updateDots();
            };

            const nextPage = () => {
                currentIndex = (currentIndex + 1) % totalPages;
                scrollToPage();
            };

            const startInterval = () => {
                clearInterval(intervalId);
                intervalId = setInterval(nextPage, 5000);
            };

            const resetInterval = () => {
                startInterval();
            };
            
            sliderWrapper.addEventListener('mouseenter', () => clearInterval(intervalId));
            sliderWrapper.addEventListener('mouseleave', startInterval);

            window.addEventListener('resize', () => {
                updateSlidesPerView();
                scrollToPage();
            });

            updateSlidesPerView();
            startInterval();
        });
        </script>
        <?php
        return ob_get_clean();
    }
}


// --- EXAM SHOWCASE SHORTCODE ---
if (!function_exists('mco_shortcode_exam_showcase')) {
    function mco_shortcode_exam_showcase() {
        $query = new WP_Query(['post_type' => 'mco_exam_program', 'posts_per_page' => -1, 'post_status' => 'publish', 'orderby' => 'title', 'order' => 'ASC']);
        if (!$query->have_posts()) return '<p>No exam programs are available at this time.</p>';

        ob_start();
        $gradients = ['card-gradient-1', 'card-gradient-2', 'card-gradient-3', 'card-gradient-4'];
        $i = 0;
        ?>
        <div class="mco-showcase-grid">
            <?php while ($query->have_posts()) : $query->the_post();
                $post_id = get_the_ID();
                $cert_sku = get_post_meta($post_id, '_mco_certification_exam_sku', true);
                if (empty($cert_sku)) continue;

                $product_id = wc_get_product_id_by_sku($cert_sku);
                $product = $product_id ? wc_get_product($product_id) : null;
                $practice_exam_id = $cert_sku . '-practice';
                
                $gradient_class = $gradients[$i % count($gradients)];
                $i++;
            ?>
            <div class="mco-card <?php echo esc_attr($gradient_class); ?>">
                <div class="mco-card-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>
                </div>
                <div class="mco-card-body">
                    <h3 class="mco-card-title"><?php the_title(); ?></h3>
                    <p class="mco-card-description"><?php echo wp_strip_all_tags(get_the_content()); ?></p>
                </div>
                <div class="mco-card-footer">
                    <a href="/exam-app/#/test/<?php echo esc_attr($practice_exam_id); ?>" class="mco-card-btn btn-secondary">Start Practice</a>
                    <?php if ($product): ?>
                        <a href="<?php echo esc_url(get_permalink($product_id)); ?>" target="_blank" class="mco-card-btn btn-secondary">View Details</a>
                        <a href="/exam-app/#/checkout/<?php echo esc_attr($product->get_slug()); ?>" class="mco-card-btn btn-primary">Purchase Exam</a>
                    <?php else: ?>
                         <a href="#" class="mco-card-btn btn-secondary disabled">Details N/A</a>
                         <a href="#" class="mco-card-btn btn-primary disabled">Unavailable</a>
                    <?php endif; ?>
                </div>
            </div>
            <?php endwhile; wp_reset_postdata(); ?>
        </div>
        <?php
        return ob_get_clean();
    }
}

// --- BOOKSTORE SHOWCASE SHORTCODE ---
if (!function_exists('mco_shortcode_book_showcase')) {
    function mco_shortcode_book_showcase() {
        $query = new WP_Query(['post_type' => 'mco_recommended_book', 'posts_per_page' => -1, 'post_status' => 'publish', 'orderby' => 'title', 'order' => 'ASC']);
        if (!$query->have_posts()) return '<p>No recommended books are available.</p>';
        
        ob_start();
        $gradients = ['card-gradient-4', 'card-gradient-1', 'card-gradient-3', 'card-gradient-2'];
        $i = 0;
        ?>
        <div class="mco-showcase-grid">
            <?php while ($query->have_posts()) : $query->the_post();
                $post_id = get_the_ID();
                $link_com = get_post_meta($post_id, '_mco_link_com', true);
                $link_in = get_post_meta($post_id, '_mco_link_in', true);
                $link_ae = get_post_meta($post_id, '_mco_link_ae', true);

                $gradient_class = $gradients[$i % count($gradients)];
                $i++;
            ?>
            <div class="mco-card <?php echo esc_attr($gradient_class); ?>">
                <div class="mco-card-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                </div>
                <div class="mco-card-body">
                    <h3 class="mco-card-title"><?php the_title(); ?></h3>
                    <p class="mco-card-description"><?php echo wp_strip_all_tags(get_the_content()); ?></p>
                </div>
                <div class="mco-card-footer">
                    <?php if (!empty($link_com)): ?>
                        <a href="<?php echo esc_url($link_com); ?>" target="_blank" rel="noopener noreferrer" class="mco-card-btn btn-primary">Amazon.com</a>
                    <?php endif; ?>
                    <?php if (!empty($link_in)): ?>
                        <a href="<?php echo esc_url($link_in); ?>" target="_blank" rel="noopener noreferrer" class="mco-card-btn btn-secondary">Amazon.in</a>
                    <?php endif; ?>
                    <?php if (!empty($link_ae)): ?>
                        <a href="<?php echo esc_url($link_ae); ?>" target="_blank" rel="noopener noreferrer" class="mco-card-btn btn-secondary">Amazon.ae</a>
                    <?php endif; ?>
                </div>
            </div>
            <?php endwhile; wp_reset_postdata(); ?>
        </div>
        <?php
        return ob_get_clean();
    }
}
?>