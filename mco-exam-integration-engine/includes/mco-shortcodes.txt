<?php
/**
 * =============================================================================
 * MODULE: MCO Comprehensive Shortcodes & WP Integration
 * VERSION: 8.0.0 (Emergency Repair - CSS Loader Restoration)
 * =============================================================================
 */

if (!defined('ABSPATH')) exit;

// --- 1. CORE DATA & CONFIG ACCESSORS ---
if (!function_exists('mco_get_exam_app_url')) {
    function mco_get_exam_app_url($all = false) {
        $urls = get_option('mco_exam_app_url', '');
        $url_list = array_filter(array_map('trim', explode("\n", $urls)));
        return $all ? $url_list : (isset($url_list[0]) ? $url_list[0] : '');
    }
}

if (!function_exists('mco_get_app_config_data')) {
    function mco_get_app_config_data() {
        if (function_exists('mco_get_full_snapshot_data')) {
            $snapshot = mco_get_full_snapshot_data(false);
            return $snapshot['organizations'][0] ?? [];
        }
        return [];
    }
}

// --- 2. STYLING & ASSETS (FIXED UNDEFINED ERROR) ---
if (!function_exists('mco_get_scoped_css')) {
    function mco_get_scoped_css() {
        return '<style>
        #mco-app-root { font-family: system-ui, -apple-system, sans-serif; --mco-primary: #0891b2; --mco-text: #334155; --mco-bg: #fff; --mco-border: #e2e8f0; color: #334155; line-height: 1.5; width: 100%; }
        #mco-app-root * { box-sizing: border-box; }
        .mco-book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; width: 100%; grid-auto-rows: 1fr; }
        .mco-book-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s; height: 100%; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .mco-book-card:hover { transform: translateY(-4px); }
        .mco-card__button { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px; border-radius: 8px; font-weight: 700; text-decoration: none; transition: background 0.2s; border: none; cursor: pointer; }
        .mco-showcase-layout { display: flex; flex-direction: column; gap: 30px; margin-bottom: 40px; }
        @media(min-width: 900px) { .mco-showcase-layout { flex-direction: row; } .mco-showcase-main { flex: 1; } .mco-study-hall-sidebar { width: 320px; flex-shrink: 0; } }
        .mco-subscription-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .mco-best-value-tag { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #facc15; color: #000; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        </style>';
    }
}

if (!function_exists('mco_load_shortcode_css')) {
    function mco_load_shortcode_css() {
        $css_path = MCO_PLUGIN_PATH . 'assets/mco-styles.css';
        if (file_exists($css_path)) {
            $css = file_get_contents($css_path);
            if ($css) { echo '<style>' . $css . '</style>'; return; }
        }
        echo mco_get_scoped_css();
    }
}

// --- 3. AUTHENTICATION & REDIRECTION ---
if (!function_exists('mco_generate_exam_jwt')) {
    function mco_generate_exam_jwt($user_id) {
        if (!defined('MCO_JWT_SECRET')) return null;
        $user = get_user_by('ID', $user_id);
        if (!$user) return null;
        $header = base64_encode(json_encode(['typ' => 'JWT', 'alg' => 'HS256']));
        
        $paid_exam_skus = get_user_meta($user_id, 'mco_paid_exams', true) ?: [];
        $is_subscribed = false;
        if (class_exists('WC_Subscriptions')) {
            $is_subscribed = wcs_user_has_subscription($user_id, '', 'active');
        }

        $payload = base64_encode(json_encode([
            'iss' => get_bloginfo('url'),
            'iat' => time(),
            'exp' => time() + (14 * DAY_IN_SECONDS),
            'user' => [
                'id' => (string)$user->ID,
                'name' => $user->display_name,
                'email' => $user->user_email,
                'isAdmin' => user_can($user->ID, 'manage_options')
            ],
            'paidExamIds' => array_values((array)$paid_exam_skus),
            'isSubscribed' => $is_subscribed,
            'isBetaTester' => get_user_meta($user_id, '_mco_is_beta_tester', true) === '1'
        ]));
        $signature = hash_hmac('sha256', "{$header}.{$payload}", MCO_JWT_SECRET, true);
        return rtrim(strtr($header, '+/', '-_'), '=') . "." . rtrim(strtr($payload, '+/', '-_'), '=') . "." . rtrim(strtr(base64_encode($signature), '+/', '-_'), '=');
    }
}

if (!function_exists('mco_redirect_to_app_with_token')) {
    function mco_redirect_to_app_with_token() {
        $token = mco_generate_exam_jwt(get_current_user_id());
        $app_url = mco_get_exam_app_url();
        if (!$token || !$app_url) return '<p>Config error: Missing JWT or App URL.</p>';
        $redirect_url = add_query_arg(['token' => $token, 'api_url' => get_site_url()], rtrim($app_url, '/') . '/auth');
        if (!headers_sent()) { wp_redirect($redirect_url); exit; }
        return '<script>window.location.href="' . esc_url($redirect_url) . '";</script><div id="mco-app-root"><div class="mco-form-container" style="text-align:center;"><p>Authorizing Access...</p></div></div>';
    }
}

if (!function_exists('mco_render_name_update_form')) {
    function mco_render_name_update_form($error_msg = '') {
        ob_start();
        mco_load_shortcode_css();
        echo '<div id="mco-app-root"><div class="mco-form-container" style="max-width:500px; margin:40px auto; padding:40px; border-radius:12px; border:1px solid #e2e8f0; background:#fff; text-align:center;"><h2>Verify Your Identity</h2><p>Please confirm your full name for certification purposes.</p>' . ($error_msg ? '<div style="color:#dc2626; margin:10px 0;">' . esc_html($error_msg) . '</div>' : '') . '<form method="post">' . wp_nonce_field('mco_update_name_action', 'mco_update_name_nonce', true, false) . '<input type="text" name="full_name" required placeholder="Full First & Last Name" style="width:100%; padding:12px; margin-bottom:20px; border-radius:6px; border:1px solid #cbd5e1;"><button type="submit" style="width:100%; padding:14px; background:#0891b2; color:#fff; border:none; border-radius:6px; font-weight:700; cursor:pointer;">Update & Continue</button></form></div></div>';
        return ob_get_clean();
    }
}

// --- 4. GLOBAL ICON LIBRARY (FULL 17 ICONS) ---
if (!function_exists('mco_get_svg_icon')) {
    function mco_get_svg_icon($name) {
        $icons = [
            'practice' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
            'cert' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>',
            'cart' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 0 0 0 2-1.61L23 6H6"/></svg>',
            'bundle' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>',
            'check' => '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>',
            'star' => '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
            'book' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
            'external-link' => '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>',
            'book-open' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>',
            'book-up' => '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5V15A2.5 2.5 0 0 1 6.5 12H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2Z"/><path d="M10 12l2-2l2 2"/><path d="M12 18V8"/></svg>',
        ];
        return $icons[$name] ?? '';
    }
}

// --- 5. PROCEDURAL COVER ENGINE (HARDENED) ---
if (!function_exists('mco_decode_html_entities_php')) {
    function mco_decode_html_entities_php($html) {
        if (!is_string($html)) return $html;
        return html_entity_decode($html, ENT_QUOTES, 'UTF-8');
    }
}
if (!function_exists('mco_get_hash_of_string_php')) {
    function mco_get_hash_of_string_php($str) {
        $hash = 0; if (empty($str)) return $hash;
        for ($i = 0; $i < strlen($str); $i++) { $hash = ($hash * 31 + ord($str[$i])) % 2147483647; }
        return $hash;
    }
}
if (!function_exists('mco_render_annapoorna_procedural_cover_php_full')) {
    function mco_render_annapoorna_procedural_cover_php_full($item_data, $type = 'showcase') {
        $title = mco_decode_html_entities_php(isset($item_data['title']) ? $item_data['title'] : 'Study Material');
        $hash = mco_get_hash_of_string_php($title);
        $styleIndex = abs($hash) % 2; $colorIndex = floor(abs($hash) / 2) % 5;
        $colorsA = [['bg' => '#4338ca', 'pattern' => '#3730a3'], ['bg' => '#0f766e', 'pattern' => '#115e59'], ['bg' => '#334155', 'pattern' => '#1e293b'], ['bg' => '#1e40af', 'pattern' => '#1e3a8a'], ['bg' => '#374151', 'pattern' => '#1f2937']];
        $colorsB = [['bg' => '#dbeafe', 'shape' => '#93c5fd', 'text' => '#1e3a8a'], ['bg' => '#d1fae5', 'shape' => '#6ee7b7', 'text' => '#064e3b'], ['bg' => '#ffe4e6', 'shape' => '#fda4af', 'text' => '#881337'], ['bg' => '#ede9fe', 'shape' => '#c4b5fd', 'text' => '#4c1d95'], ['bg' => '#f1f5f9', 'shape' => '#cbd5e1', 'text' => '#0f172a']];
        if ($styleIndex === 0) {
            $color = $colorsA[$colorIndex];
            return '<div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:1.5rem;background:'.$color['bg'].';color:#fff;position:relative;overflow:hidden;"><div style="position:absolute;top:0;left:0;width:100%;height:100%;clip-path:polygon(0 0,100% 0,0 100%);opacity:0.2;background:'.$color['pattern'].';"></div><div style="position:relative;z-index:10;"><span style="font-size:0.75rem;text-transform:uppercase;opacity:0.8;">Study Material</span><h4 style="font-weight:800;font-size:1.25rem;margin:5px 0 0 0;">'.esc_html($title).'</h4></div></div>';
        } else {
            $color = $colorsB[$colorIndex];
            return '<div style="width:100%;height:100%;display:flex;flex-direction:column;justify-content:flex-end;padding:1.5rem;background:'.$color['bg'].';color:'.$color['text'].';position:relative;overflow:hidden;"><div style="position:absolute;right:-20%;top:-20%;width:70%;height:70%;border-radius:50%;opacity:0.5;background:'.$color['shape'].';"></div><div style="position:relative;z-index:10;"><h4 style="font-weight:800;font-size:1.5rem;margin:0 0 5px 0;">'.esc_html($title).'</h4><span style="font-size:0.75rem;text-transform:uppercase;opacity:0.8;">Official Guide</span></div></div>';
        }
    }
}
if (!function_exists('mco_render_mco_procedural_cover_php_full')) {
   function mco_render_mco_procedural_cover_php_full($item_data, $type = 'showcase') {
        $title = mco_decode_html_entities_php(isset($item_data['title']) ? $item_data['title'] : 'Reference Material');
        $hash = mco_get_hash_of_string_php($title);
        $styleIndex = abs($hash) % 2; $colorIndex = floor(abs($hash) / 2) % 4;
        $colorsA = [['bg' => '#1f2937', 'text' => '#f9fafb', 'bgWord' => '#374151'], ['bg' => '#1e3a8a', 'text' => '#eff6ff', 'bgWord' => '#3b82f6'], ['bg' => '#064e3b', 'text' => '#ecfdf5', 'bgWord' => '#34d399'], ['bg' => '#3730a3', 'text' => '#e0e7ff', 'bgWord' => '#6366f1']];
        $colorsB = [['bg' => '#111827', 'text' => '#ffffff', 'accent' => '#f59e0b'], ['bg' => '#1e293b', 'text' => '#ffffff', 'accent' => '#0ea5e9'], ['bg' => '#262626', 'text' => '#ffffff', 'accent' => '#84cc16'], ['bg' => '#292524', 'text' => '#ffffff', 'accent' => '#f43f5e']];
        if ($styleIndex === 0) {
            $color = $colorsA[$colorIndex];
            $words = explode(' ', $title); $bgWord = strtoupper(strlen($words[0]) > 4 ? $words[0] : (isset($words[1]) ? $words[1] : $words[0]));
            return '<div style="width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;padding:1.5rem;background:'.$color['bg'].';color:'.$color['text'].';position:relative;overflow:hidden;"><div style="position:absolute;bottom:-0.5rem;right:-0.5rem;font-size:9rem;font-weight:900;color:'.$color['bgWord'].';opacity:0.3;">'.$bgWord.'</div><div style="position:relative;z-index:10;"><h4 style="font-weight:800;font-size:1.5rem;margin:0;">'.esc_html($title).'</h4></div></div>';
        } else {
            $color = $colorsB[$colorIndex];
            return '<div style="width:100%;height:100%;display:flex;flex-direction:column;justify-content:space-between;padding:1.5rem;background:'.$color['bg'].';color:'.$color['text'].';position:relative;overflow:hidden;"><div style="position:absolute;top:1rem;left:0;width:0.25rem;height:25%;background:'.$color['accent'].';"></div><div><span style="font-size:0.75rem;text-transform:uppercase;opacity:0.8;">Reference</span><h4 style="font-weight:800;font-size:1.25rem;margin:5px 0 0 0;">'.esc_html($title).'</h4></div><div style="align-self:flex-end;font-size:3rem;font-weight:900;opacity:0.1;">MCO</div></div>';
        }
   }
}
if (!function_exists('mco_render_procedural_cover_full')) {
    function mco_render_procedural_cover_full($item_data, $type = 'showcase') {
        $config = mco_get_app_config_data(); $org_id = $config['id'] ?? 'org-annapoorna';
        return ($org_id === 'org-medical-coding-online') ? mco_render_mco_procedural_cover_php_full($item_data, $type) : mco_render_annapoorna_procedural_cover_php_full($item_data, $type);
    }
}

// --- 6. GEO & AFFILIATE LOGIC ---
if (!function_exists('mco_get_geo_primary_link_info')) {
    function mco_get_geo_primary_link_info($links, $override_geo = null) {
        if (empty($links)) return null;
        $links = array_filter(array_map('trim', $links));
        $domainMap = ['com' => 'Amazon.com', 'in' => 'Amazon.in', 'ae' => 'Amazon.ae'];
        $chosen = null;
        if ($override_geo && !empty($links[$override_geo])) $chosen = $override_geo;
        if (!$chosen && !empty($_COOKIE['mco_wp_geo_pref']) && !empty($links[$_COOKIE['mco_wp_geo_pref']])) $chosen = sanitize_text_field($_COOKIE['mco_wp_geo_pref']);
        if (!$chosen) { foreach (['com', 'in', 'ae'] as $k) { if (!empty($links[$k])) { $chosen = $k; break; } } }
        return $chosen ? ['key' => $chosen, 'url' => $links[$chosen], 'domainName' => $domainMap[$chosen]] : null;
    }
}

// --- 7. RENDERERS (CARDS & PAGES) ---
if (!function_exists('mco_render_book_card_php')) {
    function mco_render_book_card_php($book, $type = 'showcase') {
        $primary = mco_get_geo_primary_link_info($book['affiliateLinks'] ?? [], $_GET['geo'] ?? null);
        $stores = ['com' => 'Amazon.com', 'in' => 'Amazon.in', 'ae' => 'Amazon.ae'];
        $all_stores_html = '';
        foreach ($stores as $key => $name) {
            if (!empty($book['affiliateLinks'][$key])) {
                $is_p = $key === ($primary['key'] ?? '');
                $s = 'display:inline-flex;align-items:center;justify-content:center;gap:6px;font-size:0.75rem;font-weight:700;padding:6px 12px;border-radius:4px;text-decoration:none;transition:background 0.2s;min-width:100px;box-sizing:border-box;white-space:nowrap;' . ($is_p ? 'background:#f59e0b;color:#fff;border:1px solid #f59e0b;' : 'background:#e2e8f0;color:#64748b;border:1px solid #cbd5e1;');
                $all_stores_html .= '<a href="'.esc_url($book['affiliateLinks'][$key]).'" target="_blank" style="'.$s.'">'.mco_get_svg_icon('book-up').' Buy on '.$name.'</a>';
            }
        }
        $title = $book['title'] ?? 'Untitled Book'; 
        $thumb = esc_url($book['thumbnailUrl'] ?? ''); 
        $cover = !empty($thumb) ? '<img src="'.$thumb.'" style="width:100%;height:100%;object-fit:cover;">' : mco_render_procedural_cover_full($book, $type);
        
        if ($type === 'sidebar') {
            return '<div class="mco-book-card-sidebar"><div class="mco-book-card-sidebar__cover">'.$cover.'</div><div class="mco-book-card-sidebar__content"><h4 class="mco-book-card-sidebar__title">'.esc_html($title).'</h4><div style="display:flex;flex-direction:column;gap:5px;">'.($all_stores_html ?: '<span>Soon</span>').'</div></div></div>';
        } elseif ($type === 'single') {
            return '<div class="mco-single-book"><div style="height:400px;border-radius:12px;overflow:hidden;margin-bottom:30px;border:1px solid #e2e8f0;">'.$cover.'</div><h1 style="font-size:2.5rem;font-weight:800;margin-bottom:20px;">'.esc_html($title).'</h1><div style="font-size:1.1rem;line-height:1.8;color:#475569;margin-bottom:40px;">'.wp_kses_post($book['description']??'').'</div><div style="display:flex;gap:15px;flex-wrap:wrap;">'.$all_stores_html.'</div></div>';
        } else {
            return '<div class="mco-book-card"><div class="mco-book-cover" style="height:320px;">'.$cover.'</div><div class="mco-book-card__body"><h4 class="mco-book-card__title">'.esc_html($title).'</h4><p class="mco-book-card__desc">'.esc_html(wp_trim_words($book['description']??'', 20)).'</p></div><div class="mco-book-card__footer"><div style="display:flex;flex-direction:column;gap:10px;">'.$all_stores_html.'</div></div></div>';
        }
    }
}

if (!function_exists('mco_render_program_card')) {
    function mco_render_program_card($data, $url) {
        $u = rtrim($url, '/') . '/program/' . $data['id']; $thumb = $data['thumbnailUrl'] ?? '';
        $c = !empty($thumb) ? '<img src="'.esc_url($thumb).'" style="width:100%;height:100%;object-fit:cover;">' : mco_render_procedural_cover_full(['title'=>$data['name']], 'program');
        return '<div class="mco-book-card"><div class="mco-book-cover" style="height:320px;">'.$c.'</div><div class="mco-book-card__body"><a href="'.esc_url($u).'" style="text-decoration:none;"><h4 class="mco-book-card__title">'.esc_html($data['name']).'</h4></a><p class="mco-book-card__desc">'.esc_html(wp_trim_words($data['description'], 20)).'</p></div><div class="mco-book-card__footer"><a href="'.esc_url($u).'" class="mco-card__button" style="background:#0891b2;color:#fff;">View Details '.mco_get_svg_icon('external-link').'</a></div></div>';
    }
}

if (!function_exists('mco_render_single_book_content')) {
    function mco_render_single_book_content($data) {
        ob_start(); mco_load_shortcode_css(); echo '<div id="mco-app-root"><div class="mco-wrapper">'.mco_render_book_card_php($data, 'single').'</div></div>'; return ob_get_clean();
    }
}

if (!function_exists('mco_render_single_program_content')) {
    function mco_render_single_program_content($data) {
        ob_start(); mco_load_shortcode_css(); $json = json_encode($data); $uid = 'mco-p-'.uniqid();
        echo '<div id="mco-app-root"><div class="mco-wrapper"><div id="'.$uid.'" data-props="'.esc_attr($json).'"><p>Loading program...</p></div></div></div>';
        echo '<script type="module">(async()=>{const b=window.mcoReactAppBaseUrl||"'.esc_url(mco_get_exam_app_url()).'";try{const m=await import(`${b.replace(/\/$/,"")}/assets/ProgramRenderer.js`);const c=document.getElementById("'.$uid.'");if(c&&window.ReactDOM){window.ReactDOM.createRoot(c).render(React.createElement(m.default,{program:JSON.parse(c.dataset.props)}));}}catch(e){console.error(e);}})();</script>';
        return ob_get_clean();
    }
}

if (!function_exists('mco_render_study_hall_sidebar')) {
    function mco_render_study_hall_sidebar() {
        $config = mco_get_app_config_data(); $books = $config['suggestedBooks'] ?? []; if (empty($books)) return '';
        shuffle($books); $books = array_slice($books, 0, 5);
        ob_start(); echo '<div class="mco-study-hall-sidebar"><h3 class="mco-study-hall-sidebar__title">'.mco_get_svg_icon('book-open').' <span>Study Hall</span></h3><div class="mco-study-hall-sidebar__grid">';
        foreach ($books as $b) echo mco_render_book_card_php($b, 'sidebar');
        echo '</div><p style="font-size:0.7rem;color:#94a3b8;margin-top:20px;text-align:center;">Our links support this platform. Regional availability varies. Thank you!</p></div>';
        return ob_get_clean();
    }
}

// --- 8. THE MASTER [mco_exam_showcase] SHORTCODE ---
if (!function_exists('mco_exam_showcase_shortcode')) {
    function mco_exam_showcase_shortcode($atts) {
        $atts = shortcode_atts(['id' => ''], $atts); 
        $config = mco_get_app_config_data(); 
        $app_url = mco_get_exam_app_url();
        $is_pro = (is_user_logged_in() && class_exists('WC_Subscriptions') && wcs_user_has_subscription(get_current_user_id(), '', 'active'));
        $owned_exams = is_user_logged_in() ? (get_user_meta(get_current_user_id(), 'mco_paid_exams', true) ?: []) : [];

        ob_start(); 
        mco_load_shortcode_css();
        echo '<div class="mco-showcase-layout"><div class="mco-showcase-main">';
        
        // A. SUBSCRIPTION GRID
        $subscriptions_enabled = get_option('mco_subscriptions_enabled', '1') === '1';
        if ($subscriptions_enabled && !$is_pro) {
            $m = $config['examPrices']['sub-monthly'] ?? null; 
            $y = $config['examPrices']['sub-yearly'] ?? null;
            if ($m || $y) {
                echo '<div class="mco-subscription-grid">';
                if ($m) {
                    echo '<div class="mco-card mco-gradient--sub-monthly" style="padding:30px; text-align:center; border:none;">
                            <h3 class="mco-card__subtitle">Monthly Plan</h3>
                            <p style="font-size:2.5rem; font-weight:800; margin:10px 0;">$'.$m['price'].'</p>
                            <ul style="list-style:none; padding:0; margin:0 0 20px 0; font-size:0.9rem; opacity:0.9;">
                                <li>'.mco_get_svg_icon('check').' Unlimited Practice Exams</li>
                                <li>'.mco_get_svg_icon('check').' Unlimited AI Feedback</li>
                                <li>'.mco_get_svg_icon('check').' Cancel Anytime</li>
                            </ul>
                            <a href="'.get_site_url().'/cart/?add-to-cart='.$m['productId'].'" class="mco-card__button mco-card__button--primary">Subscribe Now</a>
                          </div>';
                }
                if ($y) {
                    echo '<div class="mco-card mco-gradient--sub-yearly" style="padding:30px; text-align:center; position:relative; border:none;">
                            <div class="mco-best-value-tag">'.mco_get_svg_icon('star').' Best Value</div>
                            <h3 class="mco-card__subtitle">Yearly Plan</h3>
                            <p style="font-size:2.5rem; font-weight:800; margin:10px 0;">$'.$y['price'].'</p>
                            <ul style="list-style:none; padding:0; margin:0 0 20px 0; font-size:0.9rem; opacity:0.9;">
                                <li>'.mco_get_svg_icon('check').' Access All Programs</li>
                                <li>'.mco_get_svg_icon('check').' Priority Career Support</li>
                                <li>'.mco_get_svg_icon('check').' Save over 35%</li>
                            </ul>
                            <a href="'.get_site_url().'/cart/?add-to-cart='.$y['productId'].'" class="mco-card__button mco-card__button--primary">Subscribe & Save</a>
                          </div>';
                }
                echo '</div>';
            }
        }
        
        // B. PROGRAM GROUPS
        echo '<div class="mco-program-list">';
        $cats = $config['examProductCategories'] ?? []; 
        if ($atts['id']) $cats = array_filter($cats, fn($c)=>$c['id']===$atts['id']);
        
        foreach ($cats as $cat) {
            $practice = current(array_filter($config['exams'], fn($e)=>$e['id']===$cat['practiceExamId']));
            $cert = current(array_filter($config['exams'], fn($e)=>$e['id']===$cat['certificationExamId']));
            
            echo '<div class="mco-program-group" style="margin-bottom:50px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px;">
                        <h2 class="mco-program-group__title">'.esc_html($cat['name']).'</h2>
                        <a href="'.esc_url($app_url.'/program/'.$cat['id']).'" style="font-size:0.85rem; font-weight:700; color:#0891b2;">View Details â†’</a>
                    </div>
                    <p class="mco-program-group__description">'.esc_html(wp_trim_words($cat['description'], 30)).'</p>
                    <div class="mco-program-group__cards">';
            
            if ($practice) {
                echo '<div class="mco-card mco-gradient--practice-1">
                        <div class="mco-card__header">'.mco_get_svg_icon('practice').' Practice Exam</div>
                        <div class="mco-card__body">
                            <h4 class="mco-card__subtitle">'.esc_html($practice['name']).'</h4>
                            <div class="mco-card__stats">
                                <span>'.$practice['numberOfQuestions'].' Qs</span>
                                <span>'.$practice['durationMinutes'].' Mins</span>
                            </div>
                        </div>
                        <div class="mco-card__footer">
                            <a href="'.esc_url($app_url.'/test/'.$practice['id']).'" class="mco-card__button mco-card__button--primary">Start Practice</a>
                        </div>
                      </div>';
            }
            
            if ($cert) {
                $is_owned = in_array($cert['productSku'], $owned_exams);
                $has_access = $is_owned || $is_pro;
                $btn_text = $has_access ? 'Start Exam' : 'Buy for $'.$cert['price'];
                $btn_url = $has_access ? $app_url.'/test/'.$cert['id'] : get_site_url().'/cart/?add-to-cart='.wc_get_product_id_by_sku($cert['productSku']);
                
                echo '<div class="mco-card mco-gradient--cert-1">
                        <div class="mco-card__header">'.mco_get_svg_icon('cert').' Certification</div>
                        <div class="mco-card__body">
                            <h4 class="mco-card__subtitle">'.esc_html($cert['name']).'</h4>
                            <div class="mco-card__stats">
                                <span>'.$cert['numberOfQuestions'].' Qs</span>
                                <span>'.$cert['durationMinutes'].' Mins</span>
                            </div>
                        </div>
                        <div class="mco-card__footer">
                            <a href="'.esc_url($btn_url).'" class="mco-card__button mco-card__button--primary">'.$btn_text.'</a>
                        </div>
                      </div>';
                
                $bundle_sku = $cert['productSku'].'-1mo-addon';
                if (isset($config['examPrices'][$bundle_sku])) {
                    $b = $config['examPrices'][$bundle_sku];
                    echo '<div class="mco-card mco-gradient--bundle-sub" style="border: 2px solid #fcd34d;">
                            <div class="mco-card__header">'.mco_get_svg_icon('bundle').' Bundle Offer</div>
                            <div class="mco-card__body">
                                <h4 class="mco-card__subtitle">Exam + 1mo Premium</h4>
                                <p style="font-size:1.75rem; font-weight:800; margin-bottom:10px;">$'.$b['price'].'</p>
                                <p style="font-size:0.75rem; opacity:0.8;">Includes full practice access for 30 days.</p>
                            </div>
                            <div class="mco-card__footer">
                                <a href="'.get_site_url().'/cart/?add-to-cart='.$b['productId'].'" class="mco-card__button mco-card__button--purchase">'.mco_get_svg_icon('cart').' Purchase Bundle</a>
                            </div>
                          </div>';
                }
            }
            
            echo '</div></div>';
        }
        echo '</div></div><div class="mco-study-hall-sidebar">'.mco_render_study_hall_sidebar().'</div></div>';
        return ob_get_clean();
    }
}

// --- 9. SHORTCODE HANDLERS & FILTERS ---
if (!function_exists('mco_exam_login_shortcode')) {
    function mco_exam_login_shortcode() {
        if (!is_user_logged_in()) { $u = wp_login_url(get_permalink()); echo "<script>window.location.href='$u';</script>"; return 'Redirecting...'; }
        $user = wp_get_current_user();
        if (strpos(trim($user->display_name), ' ') === false && !isset($_POST['mco_update_name_action'])) return mco_render_name_update_form();
        if (isset($_POST['mco_update_name_nonce']) && wp_verify_nonce($_POST['mco_update_name_nonce'], 'mco_update_name_action')) {
            $name = sanitize_text_field($_POST['full_name']);
            if (strpos(trim($name), ' ') !== false) {
                wp_update_user(['ID' => $user->ID, 'display_name' => $name]);
                $p = explode(' ', $name, 2); update_user_meta($user->ID, 'first_name', $p[0]); if (isset($p[1])) update_user_meta($user->ID, 'last_name', $p[1]);
                return mco_redirect_to_app_with_token();
            } else return mco_render_name_update_form('Please enter your full first and last name.');
        }
        return mco_redirect_to_app_with_token();
    }
}

if (!function_exists('mco_program_grid_shortcode')) {
    function mco_program_grid_shortcode() {
        $config = mco_get_app_config_data(); $app_url = mco_get_exam_app_url(); ob_start(); mco_load_shortcode_css();
        echo '<div id="mco-app-root"><div class="mco-wrapper"><div class="mco-book-grid">';
        foreach (($config['examProductCategories']??[]) as $c) echo mco_render_program_card($c, $app_url);
        echo '</div></div></div>'; return ob_get_clean();
    }
}

if (!function_exists('mco_book_showcase_shortcode')) {
    function mco_book_showcase_shortcode() {
        $config = mco_get_app_config_data(); ob_start(); mco_load_shortcode_css();
        echo '<div id="mco-app-root"><div class="mco-wrapper"><div class="mco-book-grid">';
        foreach (($config['suggestedBooks']??[]) as $b) echo mco_render_book_card_php($b, 'showcase');
        echo '</div></div></div>'; return ob_get_clean();
    }
}

if (!function_exists('mco_single_book_shortcode')) {
    function mco_single_book_shortcode() {
        global $post; $config = mco_get_app_config_data(); $id = get_post_meta($post->ID, '_mco_book_id', true);
        $book = current(array_filter($config['suggestedBooks']??[], fn($b)=>$b['id']===$id)) ?: ['title'=>$post->post_title,'description'=>$post->post_content];
        return mco_render_single_book_content($book);
    }
}

if (!function_exists('mco_single_program_shortcode')) {
    function mco_single_program_shortcode() {
        global $post; $app_url = mco_get_exam_app_url();
        $data = ['id'=>'prod-'.$post->ID,'title'=>get_the_title($post),'description'=>$post->post_content,'thumbnailUrl'=>get_post_meta($post->ID,'_mco_thumbnail_url',true)?:get_the_post_thumbnail_url($post->ID,'large'),'permalink'=>rtrim($app_url,'/').'/program/prod-'.$post->ID];
        return mco_render_single_program_content($data);
    }
}

if (!function_exists('mco_auto_inject_template')) {
    add_filter('the_content', 'mco_auto_inject_template');
    function mco_auto_inject_template($content) {
        if (!is_main_query() || !in_the_loop()) return $content;
        if (is_singular('mco_recommended_book')) return mco_single_book_shortcode();
        if (is_singular('mco_exam_program')) return mco_single_program_shortcode();
        return $content;
    }
}

if (!function_exists('mco_set_react_app_base_url_for_js')) {
    function mco_set_react_app_base_url_for_js() {
        $app_url = mco_get_exam_app_url();
        if (!empty($app_url)) echo '<script>window.mcoReactAppBaseUrl = "' . rtrim(esc_url($app_url), '/') . '";</script>' . "\n";
    }
    add_action('wp_footer', 'mco_set_react_app_base_url_for_js');
}

if (!function_exists('mco_inject_geo_preference_script')) {
    function mco_inject_geo_preference_script() {
        echo '<script>(function(){const k=localStorage.getItem("mco_preferred_geo_key");if(k)document.cookie=`mco_wp_geo_pref=${k}; path=/; SameSite=Lax`;})();</script>';
    }
    add_action('wp_footer', 'mco_inject_geo_preference_script');
}

add_shortcode('mco_exam_login', 'mco_exam_login_shortcode');
add_shortcode('mco_exam_showcase', 'mco_exam_showcase_shortcode');
add_shortcode('mco_program_grid', 'mco_program_grid_shortcode');
add_shortcode('mco_single_program', 'mco_single_program_shortcode');
add_shortcode('mco_book_showcase', 'mco_book_showcase_shortcode');
add_shortcode('mco_single_book', 'mco_single_book_shortcode');
