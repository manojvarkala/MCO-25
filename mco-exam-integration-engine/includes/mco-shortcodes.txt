<?php
/**
 * =============================================================================
 * MODULE: MCO Comprehensive Shortcodes & WP Integration
 * VERSION: 9.0.0 (Pure PHP Frontend Logic)
 * =============================================================================
 */

if (!defined('ABSPATH')) exit;

// --- 1. SHARED STYLES ---
add_action('wp_head', function() {
    echo '<style>
        :root {
            --mco-primary: #0891b2;
            --mco-p-hover: #0e7490;
            --mco-amber: #fbbf24;
            --mco-amber-hover: #f59e0b;
            --mco-amber-text: #78350f;
            --mco-bg: #f8fafc;
            --mco-text: #334155;
            --mco-border: #e2e8f0;
        }

        /* GRID SYSTEM (The fix for missing layouts) */
        .mco-book-grid, 
        .mco-program-group__cards {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
            gap: 30px !important;
            width: 100% !important;
            margin: 30px 0 !important;
            list-style: none !important;
            padding: 0 !important;
        }

        /* BOOK CARDS */
        .mco-book-card {
            background: #fff;
            border: 1px solid var(--mco-border);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            height: 100%;
        }
        .mco-book-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .mco-book-cover { height: 260px; background: #f1f5f9; position: relative; border-bottom: 1px solid var(--mco-border); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .mco-book-cover img { width: 100%; height: 100%; object-fit: cover; }
        
        .mco-book-card__body { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .mco-book-card__title { font-size: 1.1rem; font-weight: 700; margin: 0 0 10px; color: #0f172a; line-height: 1.3; }
        .mco-book-card__desc { font-size: 0.875rem; color: #64748b; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        
        .mco-book-card__footer { padding: 16px 20px; background: #f8fafc; border-top: 1px solid #f1f5f9; }

        /* BUTTONS */
        .mco-book-btn, .mco-card__button {
            display: flex !important; align-items: center; justify-content: center; gap: 8px;
            width: 100%; padding: 12px; border-radius: 8px; font-weight: 700;
            text-decoration: none !important; margin-bottom: 8px; font-size: 0.9rem;
            transition: opacity 0.2s; border: none; cursor: pointer;
        }
        .mco-book-btn:last-child { margin-bottom: 0; }
        .mco-book-btn--primary { background: var(--mco-amber) !important; color: var(--mco-amber-text) !important; }
        .mco-book-btn--cyan { background: var(--mco-primary) !important; color: #fff !important; }
        .mco-book-btn--secondary { background: #e2e8f0 !important; color: #475569 !important; border: 1px solid #cbd5e1 !important; }

        /* PROCEDURAL COVERS */
        .mco-proc-cover { width: 100%; height: 100%; padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: #fff; }
        .mco-proc-cover h4 { font-size: 1.1rem; font-weight: 800; margin: 0; line-height: 1.2; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .mco-proc-cover span { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; margin-bottom: 5px; }

        /* GRADIENTS */
        .mco-gradient--practice { background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); }
        .mco-gradient--cert { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
    </style>';
});

// --- 2. GEO AFFILIATE HELPER ---
if (!function_exists('mco_get_geo_links_php')) {
    function mco_get_geo_links_php($links) {
        $country = strtoupper($_COOKIE['mco_user_geo_country_code'] ?? 'US');
        $map = ['IN' => 'in', 'AE' => 'ae', 'SA' => 'ae', 'QA' => 'ae'];
        $preferred = $map[$country] ?? 'com';
        
        $primary = null;
        if (!empty($links[$preferred])) {
            $primary = ['key' => $preferred, 'url' => $links[$preferred], 'domain' => 'Amazon.' . $preferred];
        } elseif (!empty($links['com'])) {
            $primary = ['key' => 'com', 'url' => $links['com'], 'domain' => 'Amazon.com'];
        }

        return $primary;
    }
}

// --- 3. PROCEDURAL COVER HELPER ---
if (!function_exists('mco_render_proc_cover_php')) {
    function mco_render_proc_cover_php($title) {
        $hash = abs(crc32($title));
        $colors = ['#4338ca', '#0f766e', '#334155', '#1e40af', '#374151'];
        $bg = $colors[$hash % count($colors)];
        return '<div class="mco-proc-cover" style="background:'.$bg.'">
            <span>Study Guide</span>
            <h4>'.esc_html($title).'</h4>
        </div>';
    }
}

// --- 4. EXAM SHOWCASE SHORTCODE ---
if (!function_exists('mco_exam_showcase_shortcode')) {
    function mco_exam_showcase_shortcode($atts) {
        $config = mco_get_app_config_data();
        $org = $config['organizations'][0] ?? null;
        if (!$org) return '';

        $app_url = rtrim(mco_get_exam_app_url(), '/');
        $output = '<div class="mco-program-group__cards">';
        
        foreach ($org['examProductCategories'] as $cat) {
            $output .= '<div class="mco-book-card">';
            $output .= '<div class="mco-book-cover">'.mco_render_proc_cover_php($cat['name']).'</div>';
            $output .= '<div class="mco-book-card__body">';
            $output .= '<h4 class="mco-book-card__title">'.esc_html($cat['name']).'</h4>';
            $output .= '<p class="mco-book-card__desc">'.wp_trim_words($cat['description'], 15).'</p>';
            $output .= '</div>';
            $output .= '<div class="mco-book-card__footer">';
            $output .= '<a href="'.$app_url.'/program/'.$cat['id'].'" class="mco-book-btn mco-book-btn--cyan">View Program</a>';
            $output .= '</div></div>';
        }

        $output .= '</div>';
        return $output;
    }
}

// --- 5. BOOK SHOWCASE SHORTCODE (FULL MODIFIED VERSION) ---
if (!function_exists('mco_book_showcase_shortcode')) {
    function mco_book_showcase_shortcode($atts) {
        $config = mco_get_app_config_data();
        $books = $config['organizations'][0]['suggestedBooks'] ?? [];
        if (empty($books)) return '<p>No study materials listed.</p>';

        $output = '<div class="mco-book-grid">';
        
        foreach ($books as $book) {
            $primary = mco_get_geo_links_php($book['affiliateLinks'] ?? []);
            $thumb = $book['thumbnailUrl'] ?? '';
            $title = $book['title'] ?? 'Untitled';

            $output .= '<div class="mco-book-card">';
            $output .= '<div class="mco-book-cover">'.($thumb ? '<img src="'.esc_url($thumb).'" alt="'.esc_attr($title).'">' : mco_render_proc_cover_php($title)).'</div>';
            $output .= '<div class="mco-book-card__body">';
            $output .= '<h4 class="mco-book-card__title">'.esc_html($title).'</h4>';
            $output .= '<p class="mco-book-card__desc">'.wp_trim_words($book['description'], 20).'</p>';
            $output .= '</div>';
            $output .= '<div class="mco-book-card__footer">';
            
            if ($primary) {
                $output .= '<a href="'.esc_url($primary['url']).'" target="_blank" class="mco-book-btn mco-book-btn--primary">Buy on '.$primary['domain'].'</a>';
                // Show secondary link if available
                foreach (['com', 'in', 'ae'] as $k) {
                    if ($k !== $primary['key'] && !empty($book['affiliateLinks'][$k])) {
                        $output .= '<a href="'.esc_url($book['affiliateLinks'][$k]).'" target="_blank" class="mco-book-btn mco-book-btn--secondary">Amazon.'.strtoupper($k).'</a>';
                    }
                }
            } else {
                $output .= '<span class="mco-book-btn mco-book-btn--secondary">Coming Soon</span>';
            }
            
            $output .= '</div></div>';
        }

        $output .= '</div>';
        return $output;
    }
}

// --- 6. SSO REDIRECT LOGIC ---
if (!function_exists('mco_exam_login_shortcode')) {
    function mco_exam_login_shortcode($atts = []) {
        if (!is_user_logged_in()) {
            $login_url = wp_login_url(get_permalink());
            return '<div class="mco-wrapper" style="text-align:center; padding: 60px 0;">
                <h3>Please Log In to Access the Exam</h3>
                <p>You need to be logged in to continue.</p>
                <a href="' . esc_url($login_url) . '" class="mco-book-btn mco-book-btn--primary" style="display:inline-flex; width:auto;">
                    Log In Now
                </a>
            </div>';
        }

        $user = wp_get_current_user();
        $display_name = trim($user->display_name);

        // Handle name update if missing
        if (isset($_POST['mco_update_name_nonce']) && wp_verify_nonce($_POST['mco_update_name_nonce'], 'mco_update_name_action')) {
            $full_name = sanitize_text_field($_POST['full_name'] ?? '');
            if (!empty($full_name) && strpos(trim($full_name), ' ') !== false) {
                wp_update_user(['ID' => $user->ID, 'display_name' => $full_name]);
                $token = mco_generate_exam_jwt($user->ID);
                $app_url = mco_get_exam_app_url();
                $redirect = add_query_arg(['token' => $token, 'api_url' => get_site_url()], rtrim($app_url, '/') . '/auth');
                echo '<script>window.location.href="' . esc_url($redirect) . '";</script>';
                return '<p>Redirecting...</p>';
            }
        }

        if (strpos($display_name, ' ') === false) {
            return '<div class="mco-wrapper" style="max-width:500px; margin: 40px auto; padding: 30px; background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);">
                <h3 style="margin-top:0; color:#0f172a;">One Last Step</h3>
                <p>Please enter your full name (first and last) to continue to the exam.</p>
                <form method="post" style="display:flex; flex-direction:column; gap:16px;">
                    ' . wp_nonce_field('mco_update_name_action', 'mco_update_name_nonce', true, false) . '
                    <input type="text" name="full_name" placeholder="e.g., John Smith" required style="padding:12px; border:1px solid #e2e8f0; border-radius:6px; font-size:1rem;">
                    <button type="submit" class="mco-book-btn mco-book-btn--primary">Save Name & Continue</button>
                </form>
            </div>';
        }

        $token = mco_generate_exam_jwt($user->ID);
        $app_url = mco_get_exam_app_url();
        $redirect = add_query_arg(['token' => $token, 'api_url' => get_site_url()], rtrim($app_url, '/') . '/auth');
        echo '<script>window.location.href="' . esc_url($redirect) . '";</script>';
        return '<div style="text-align:center; padding:60px 0;"><p>Redirecting to exam portal...</p></div>';
    }
}

// --- 7. REGISTRATION ---
add_shortcode('mco_exam_showcase', 'mco_exam_showcase_shortcode');
add_shortcode('mco_book_showcase', 'mco_book_showcase_shortcode');
add_shortcode('mco_exam_login', 'mco_exam_login_shortcode');
