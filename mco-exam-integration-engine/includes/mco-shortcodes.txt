<?php
if (!defined('ABSPATH')) exit;

// --- COMPATIBILITY LAYER ---
if (!function_exists('mco_get_exam_app_url')) {
    function mco_get_exam_app_url($all = false) {
        $urls = get_option('mco_exam_app_url', '');
        $url_list = array_filter(array_map('trim', explode("\n", $urls)));
        return $all ? $url_list : (isset($url_list[0]) ? $url_list[0] : '');
    }
}
if (!function_exists('mco_get_app_config_data')) {
    function mco_get_app_config_data() {
        if (function_exists('mco_get_full_snapshot_data')) {
            $snapshot = mco_get_full_snapshot_data(false);
            return $snapshot['organizations'][0] ?? [];
        }
        return [];
    }
}

// --- CSS LOADER HELPER ---
if (!function_exists('mco_load_shortcode_css')) {
    function mco_load_shortcode_css() {
        $css_path = MCO_PLUGIN_PATH . 'assets/mco-styles.css';
        if (file_exists($css_path)) {
            $css = file_get_contents($css_path);
            if ($css) {
                $css = preg_replace('!/\*[^*]*\*+([^/][^*]*\*+)*/!', '', $css);
                $css = str_replace(array("\r\n", "\r", "\n", "\t", '  ', '    ', '    '), '', $css);
                echo '<style>' . $css . '</style>';
                return;
            }
        }
    }
}

// --- ICON HELPER ---
if (!function_exists('mco_get_svg_icon')) {
    function mco_get_svg_icon($name) {
        $icons = [
            'practice' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
            'cert' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>',
            'cart' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 0 0 0 2-1.61L23 6H6"/></svg>',
            'book-up' => '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5V15A2.5 2.5 0 0 1 6.5 12H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2Z"/><path d="M10 12l2-2l2 2"/><path d="M12 18V8"/></svg>',
        ];
        return $icons[$name] ?? '';
    }
}

// --- PROCEDURAL COVER LOGIC (Synced with React) ---
if (!function_exists('mco_render_procedural_cover_full')) {
    function mco_render_procedural_cover_full($item_data, $type = 'showcase') {
        $title = html_entity_decode($item_data['title'] ?? '', ENT_QUOTES, 'UTF-8');
        $hash = 0;
        if (!empty($title)) {
            for ($i = 0; $i < strlen($title); $i++) {
                $hash = (ord($title[$i]) + (($hash << 5) - $hash)) % 2147483647;
            }
        }
        $styleIndex = abs($hash) % 2;
        $colorIndex = floor(abs($hash) / 2) % 5;

        $colorsA = [
            ['bg' => '#4338ca', 'pattern' => '#3730a3'],
            ['bg' => '#0f766e', 'pattern' => '#115e59'],
            ['bg' => '#334155', 'pattern' => '#1e293b'],
            ['bg' => '#1e40af', 'pattern' => '#1e3a8a'],
            ['bg' => '#374151', 'pattern' => '#1f2937'],
        ];
        
        $colorsB = [
            ['bg' => '#dbeafe', 'shape' => '#93c5fd', 'text' => '#1e3a8a'],
            ['bg' => '#d1fae5', 'shape' => '#6ee7b7', 'text' => '#064e3b'],
            ['bg' => '#ffe4e6', 'shape' => '#fda4af', 'text' => '#881337'],
            ['bg' => '#ede9fe', 'shape' => '#c4b5fd', 'text' => '#4c1d95'],
            ['bg' => '#f1f5f9', 'shape' => '#cbd5e1', 'text' => '#0f172a'],
        ];

        if ($styleIndex === 0) {
            $color = $colorsA[$colorIndex];
            return '<div style="position:relative; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:1.5rem; box-sizing:border-box; background-color:'.$color['bg'].'; color:#fff; overflow:hidden;"><div style="position:absolute; top:0; left:0; width:100%; height:100%; clip-path:polygon(0 0, 100% 0, 0 100%); opacity:0.2; background-color:'.$color['pattern'].';"></div><div style="position:relative; z-index:10;"><span style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.1em; opacity:0.8; display:block; margin-bottom:0.5rem;">Study Material</span><h4 style="font-weight:800; font-size:1.25rem; line-height:1.2; margin:0;">'.esc_html($title).'</h4></div></div>';
        } else {
            $color = $colorsB[$colorIndex];
            return '<div style="position:relative; width:100%; height:100%; display:flex; flex-direction:column; justify-content:flex-end; text-align:left; padding:1.5rem; box-sizing:border-box; background-color:'.$color['bg'].'; color:'.$color['text'].'; overflow:hidden;"><div style="position:absolute; right:-20%; top:-20%; width:70%; height:70%; border-radius:50%; opacity:0.5; background-color:'.$color['shape'].';"></div><div style="position:relative; z-index:10;"><h4 style="font-weight:800; font-size:1.5rem; line-height:1.1; margin:0 0 0.5rem 0;">'.esc_html($title).'</h4><span style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.1em; opacity:0.8;">Official Guide</span></div></div>';
        }
    }
}

// --- GEO-CODING HELPER ---
if (!function_exists('mco_get_geo_primary_link_info')) {
    function mco_get_geo_primary_link_info($links, $override_geo_key = null) {
        if (empty($links) || !is_array($links)) return null;
        $links = array_filter(array_map('trim', $links)); 
        if (empty($links)) return null;

        $domainMap = ['com' => 'Amazon.com', 'in' => 'Amazon.in', 'ae' => 'Amazon.ae'];
        $chosen_key = null;

        if (!empty($override_geo_key) && !empty($links[$override_geo_key])) {
            $chosen_key = $override_geo_key;
        } 
        if (empty($chosen_key) && !empty($_COOKIE['mco_wp_geo_pref']) && !empty($links[$_COOKIE['mco_wp_geo_pref']])) {
            $chosen_key = sanitize_text_field($_COOKIE['mco_wp_geo_pref']);
        }
        if (empty($chosen_key)) {
            $fallback_priority = ['com', 'in', 'ae'];
            foreach ($fallback_priority as $key) {
                if (!empty($links[$key])) { $chosen_key = $key; break; }
            }
        }
        if (!empty($chosen_key)) {
            return ['key' => $chosen_key, 'url' => $links[$chosen_key], 'domainName' => $domainMap[$chosen_key] ?? 'Amazon.com'];
        }
        return null;
    }
}

if (!function_exists('mco_render_book_card_php')) {
    function mco_render_book_card_php($book, $type = 'showcase') {
        $geo_override_from_url = isset($_GET['geo']) ? sanitize_text_field($_GET['geo']) : null;
        $primary_link_info = mco_get_geo_primary_link_info($book['affiliateLinks'] ?? [], $geo_override_from_url);
        $all_stores = [];
        if (!empty($book['affiliateLinks'])) {
            $stores = ['com' => ['name' => 'Amazon.com', 'url' => $book['affiliateLinks']['com'] ?? ''], 'in' => ['name' => 'Amazon.in', 'url' => $book['affiliateLinks']['in'] ?? ''], 'ae' => ['name' => 'Amazon.ae', 'url' => $book['affiliateLinks']['ae'] ?? '']];
            foreach ($stores as $key => $store) { if (!empty($store['url'])) $all_stores[] = ['key' => $key, 'name' => $store['name'], 'url' => $store['url']]; }
        }

        $title = $book['title'] ?? '';
        $thumbnail_url = esc_url($book['thumbnailUrl'] ?? '');
        $permalink = esc_url($book['permalink'] ?? '#');
        $cover_html = !empty($thumbnail_url) ? '<img src="' . $thumbnail_url . '" style="width:100%;height:100%;object-fit:cover;" ' . (str_starts_with($thumbnail_url, 'data:image') ? '' : 'crossorigin="anonymous"') . '>' : mco_render_procedural_cover_full($book, $type);

        if ($type === 'sidebar') {
            return '<div class="mco-book-card-sidebar"><div class="mco-book-card-sidebar__cover">' . $cover_html . '</div><div class="mco-book-card-sidebar__content">' . (!empty($permalink) ? '<a href="' . $permalink . '" target="_blank" rel="noopener noreferrer" class="group">' : '') . '<h4 class="mco-book-card-sidebar__title">' . esc_html($title) . '</h4>' . (!empty($permalink) ? '</a>' : '') . '<div class="mco-store-buttons-sidebar">' . (count($all_stores) > 0 ? (implode('', array_map(function($store) use ($primary_link_info) {
                $is_primary = $store['key'] === ($primary_link_info['key'] ?? '');
                $button_style = 'display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.75rem; font-weight: 700; padding: 6px 12px; border-radius: 4px; text-decoration: none; align-self: flex-start; transition: background-color 0.2s; min-width: 100px; box-sizing: border-box; white-space: nowrap; text-align: center;' . ($is_primary ? ' background-color: #f59e0b; color: #fff; border: 1px solid #f59e0b;' : ' background-color: #e2e8f0; color: #64748b; border: 1px solid #cbd5e1;');
                return '<a href="' . esc_url($store['url']) . '" target="_blank" rel="noopener noreferrer" style="' . $button_style . '">' . mco_get_svg_icon('book-up') . ' Buy on ' . esc_html($store['name']) . '</a>';
            }, $all_stores))) : '<span>Soon</span>') . '</div></div></div>';
        } elseif ($type === 'single') {
            return '<div class="mco-single-book-card"><div class="mco-single-book-card__cover" style="height:400px; overflow:hidden; border-radius:12px; margin-bottom:30px; border:1px solid #e2e8f0;">' . $cover_html . '</div><div class="mco-single-book-card__details"><h1 style="font-size:2.5rem; font-weight:800; color:#0f172a; margin-bottom:20px;">' . esc_html($title) . '</h1><div style="font-size:1.125rem; line-height:1.8; color:#475569; margin-bottom:40px;">' . wp_kses_post($book['description'] ?? '') . '</div><div style="display:flex; flex-wrap:wrap; gap:16px;">' . (count($all_stores) > 0 ? (implode('', array_map(function($store) use ($primary_link_info) {
                $is_primary = $store['key'] === ($primary_link_info['key'] ?? '');
                $button_style = 'display: inline-flex; align-items: center; justify-content: center; gap: 8px; width: auto; padding: 14px 32px; border-radius: 8px; text-decoration: none; font-weight: 700; font-size: 1.1rem; box-sizing: border-box; transition: all 0.2s;' . ($is_primary ? ' background-color: #facc15; color: #1e293b; border: 1px solid #eab308; transform: scale(1.05);' : ' background-color: #f1f5f9; color: #475569; border: 1px solid #cbd5e1;');
                return '<a href="' . esc_url($store['url']) . '" target="_blank" rel="noopener noreferrer" style="' . $button_style . '">' . mco_get_svg_icon('book-up') . ' Buy on ' . esc_html($store['name']) . '</a>';
            }, $all_stores))) : '<span>Coming Soon</span>') . '</div></div></div>';
        } else {
            return '<div class="mco-book-card"><div class="mco-book-cover" style="height:320px;">' . $cover_html . '</div><div class="mco-book-card__body"><h4 class="mco-book-card__title">' . esc_html($title) . '</h4><p class="mco-book-card__desc">' . esc_html(wp_trim_words($book['description'] ?? '', 20, '...')) . '</p></div><div class="mco-book-card__footer"><div class="mco-store-buttons">' . (count($all_stores) > 0 ? (implode('', array_map(function($store) use ($primary_link_info) {
                $is_primary = $store['key'] === ($primary_link_info['key'] ?? '');
                $button_style = 'display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px; border-radius: 8px; text-decoration: none; font-weight: 700; font-size: 0.95rem; box-sizing: border-box; transition: all 0.2s;' . ($is_primary ? ' background-color: #facc15; color: #1e293b; border: 1px solid #eab308;' : ' background-color: #f1f5f9; color: #475569; border: 1px solid #cbd5e1;');
                return '<a href="' . esc_url($store['url']) . '" target="_blank" rel="noopener noreferrer" style="' . $button_style . '">' . mco_get_svg_icon('cart') . ' Buy on ' . esc_html($store['name']) . '</a>';
            }, $all_stores))) : '<span style="text-align:center;">Soon</span>') . '</div></div></div>';
        }
    }
}

// --- SHORTCODE DEFINITIONS ---
if (!function_exists('mco_exam_login_shortcode')) {
    function mco_exam_login_shortcode() {
        if (is_user_logged_in()) {
            $user = wp_get_current_user();
            if (strpos(trim($user->display_name), ' ') === false && !isset($_POST['mco_update_name_action'])) return mco_render_name_update_form();
            return mco_redirect_to_app_with_token();
        }
        $login_url = wp_login_url(get_permalink());
        return '<script>window.location.href="' . esc_url($login_url) . '";</script><div id="mco-app-root"><div class="mco-form-container" style="text-align:center;"><p>Redirecting...</p></div></div>';
    }
}

if (!function_exists('mco_book_showcase_shortcode')) {
    function mco_book_showcase_shortcode() {
        $config_data = mco_get_app_config_data();
        $raw_books = $config_data['suggestedBooks'] ?? [];
        ob_start();
        mco_load_shortcode_css();
        echo '<div id="mco-app-root" style="width:100%;"><div class="mco-wrapper" style="width:100%;"><div class="mco-book-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:30px; width:100%;">';
        foreach ((array)$raw_books as $book) echo mco_render_book_card_php($book, 'showcase');
        echo '</div></div></div>';
        return ob_get_clean();
    }
}

if (!function_exists('mco_single_book_shortcode')) {
    function mco_single_book_shortcode() {
        global $post;
        $config_data = mco_get_app_config_data();
        $book_id_meta = get_post_meta($post->ID, '_mco_book_id', true);
        $book = current(array_filter($config_data['suggestedBooks'] ?? [], function($b) use ($book_id_meta) { return ($b['id'] ?? '') === $book_id_meta; }));
        if (!$book) $book = ['id' => $book_id_meta ?: 'book-'.$post->ID, 'title' => get_the_title($post), 'description' => $post->post_content, 'thumbnailUrl' => get_post_meta($post->ID, '_mco_thumbnail_url', true) ?: get_the_post_thumbnail_url($post->ID, 'large'), 'permalink' => get_permalink($post->ID), 'affiliateLinks' => ['com' => get_post_meta($post->ID, '_mco_link_com', true), 'in' => get_post_meta($post->ID, '_mco_link_in', true), 'ae' => get_post_meta($post->ID, '_mco_link_ae', true)]];
        ob_start();
        mco_load_shortcode_css();
        echo '<div id="mco-app-root"><div class="mco-wrapper">' . mco_render_book_card_php($book, 'single') . '</div></div>';
        return ob_get_clean();
    }
}

// Footer injection for persistent geo preference
if (!function_exists('mco_inject_geo_preference_script')) {
    function mco_inject_geo_preference_script() {
        echo '<script>(function(){const k=localStorage.getItem("mco_preferred_geo_key");if(k)document.cookie=`mco_wp_geo_pref=${k}; path=/; SameSite=Lax`;})();</script>';
    }
    add_action('wp_footer', 'mco_inject_geo_preference_script');
}

add_shortcode('mco_exam_login', 'mco_exam_login_shortcode');
add_shortcode('mco_book_showcase', 'mco_book_showcase_shortcode');
add_shortcode('mco_single_book', 'mco_single_book_shortcode');