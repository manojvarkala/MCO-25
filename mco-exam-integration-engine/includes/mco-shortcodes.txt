<?php
/**
 * =============================================================================
 * MODULE: MCO Comprehensive Shortcodes & WP Integration
 * VERSION: 8.1.0 (UI & Geolocation Enhancements)
 * =============================================================================
 */

if (!defined('ABSPATH')) exit;

// --- 1. CORE DATA & CONFIG ACCESSORS ---
// These functions are defined in mco-data.php and mco-api.php
// The shortcodes will call the canonical functions directly.
// mco_get_exam_app_url is defined in mco-data.php
// mco_get_app_config_data is defined in mco-data.php
// mco_generate_exam_jwt is defined in mco-api.php


// --- 2. STYLING & ASSETS (FIXED UNDEFINED ERROR) ---
if (!function_exists('mco_load_shortcode_css')) {
    function mco_load_shortcode_css() {
        $css_path = MCO_PLUGIN_PATH . 'assets/mco-styles.css';
        if (file_exists($css_path)) {
            $css = file_get_contents($css_path);
            if ($css) {
                // Remove extra whitespace for inline CSS optimization
                $css = preg_replace('/\s+/', ' ', $css);
                echo '<style>' . $css . '</style>';
                return;
            }
        }
        // Fallback to scoped CSS if file not found
        echo '<style>
        #mco-app-root { font-family: system-ui, -apple-system, sans-serif; --mco-primary: #0891b2; --mco-text: #334155; --mco-bg: #fff; --mco-border: #e2e8f0; color: #334155; line-height: 1.5; width: 100%; }
        #mco-app-root * { box-sizing: border-box; }
        .mco-book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; width: 100%; grid-auto-rows: 1fr; }
        .mco-book-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s; height: 100%; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .mco-book-card:hover { transform: translateY(-4px); }
        .mco-card__button { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px; border-radius: 8px; font-weight: 700; text-decoration: none; transition: background 0.2s; border: none; cursor: pointer; }
        .mco-card__button--primary { background-color: var(--mco-primary); color: #fff; }
        .mco-card__button--primary:hover { background-color: var(--mco-primary-hover); }
        .mco-card__button--purchase { background-color: #facc15; color: #1e293b; }
        .mco-card__button--purchase:hover { background-color: #eab308; }
        .mco-showcase-layout { display: flex; flex-direction: column; gap: 30px; margin-bottom: 40px; }
        @media(min-width: 900px) { .mco-showcase-layout { flex-direction: row; } .mco-showcase-main { flex: 1; } .mco-study-hall-sidebar { width: 320px; flex-shrink: 0; } }
        .mco-subscription-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .mco-best-value-tag { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #facc15; color: #000; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        </style>';
    }
}
add_action('wp_head', 'mco_load_shortcode_css'); // Hook to wp_head for theme compatibility

// --- 3. ICON HELPER ---
if (!function_exists('mco_get_svg_icon')) {
    function mco_get_svg_icon($name) {
        $icons = [
            'practice' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
            'cert' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>',
            'cart' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 0 0 0 2-1.61L23 6H6"/></svg>',
            'bundle' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>',
            'check' => '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>',
            'star' => '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
            'book' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
            'external-link' => '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>',
            'book-open' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>',
            'book-up' => '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5V15A2.5 2.5 0 0 1 6.5 12H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2Z"/><path d="M10 12l2-2l2 2"/><path d="M12 18V8"/></svg>',
            'user' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            'lock' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
            'unlock' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',
            'search' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>',
            'filter' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>',
            'arrow-right' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>',
            'chevron-down' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>',
        ];
        return $icons[$name] ?? '';
    }
}

// --- 4. PROCEDURAL COVER LOGIC (PHP) ---
if (!function_exists('mco_get_hash_of_string')) {
    function mco_get_hash_of_string($str) {
        $hash = 0; if (empty($str)) return $hash;
        for ($i = 0; $i < strlen($str); $i++) { $hash = ($hash * 31 + ord($str[$i])); }
        return $hash;
    }
}

if (!function_exists('mco_render_annapoorna_procedural_cover_php')) {
    function mco_render_annapoorna_procedural_cover_php($item_data, $type = 'book') {
        $title = html_entity_decode($item_data['title'], ENT_QUOTES, 'UTF-8');
        $hash = mco_get_hash_of_string($title);
        $styleIndex = abs($hash) % 2; $colorIndex = floor(abs($hash) / 2) % 5;
        
        $superTitle = ($type === 'program') ? 'Certification Program' : 'Study Material';
        $subTitle = ($type === 'program') ? 'Exam Prep' : 'Official Guide';

        // SVG Pattern for Style A (circles)
        $svgPattern = '<svg width="100%" height="100%" style="position:absolute;inset:0;opacity:0.1;"><defs><pattern id="p-' . $hash . '" patternUnits="userSpaceOnUse" width="20" height="20"><circle cx="10" cy="10" r="1" fill="white"/></pattern></defs><rect width="100%" height="100%" fill="url(#p-' . $hash . ')"/></svg>';

        if ($styleIndex === 0) {
            // Style A: Centered with pattern
            $colorsA = [
                ['bg' => 'background-color: #4338ca;', 'pattern' => 'background-color: #3730a3;', 'text' => 'color: #ffffff;'],
                ['bg' => 'background-color: #0f766e;', 'pattern' => 'background-color: #115e59;', 'text' => 'color: #ffffff;'],
                ['bg' => 'background-color: #334155;', 'pattern' => 'background-color: #1e293b;', 'text' => 'color: #ffffff;'],
                ['bg' => 'background-color: #1e40af;', 'pattern' => 'background-color: #1e3a8a;', 'text' => 'color: #ffffff;'],
                ['bg' => 'background-color: #374151;', 'pattern' => 'background-color: #1f2937;', 'text' => 'color: #ffffff;'],
            ];
            $c = $colorsA[$colorIndex];
            
            return '<div class="mco-proc-cover-annapoorna-a ' . '" style="' . $c['bg'] . $c['text'] . '">' .
                    '<div class="mco-proc-cover-annapoorna-a__pattern-bg" style="' . $c['pattern'] . '">' . $svgPattern . '</div>' .
                    '<div class="mco-proc-cover-annapoorna-a__content">' .
                    '<span class="mco-proc-cover-annapoorna-a__super-title">' . $superTitle . '</span>' .
                    '<h4 class="mco-proc-cover-annapoorna-a__title">' . esc_html($title) . '</h4>' .
                    '</div></div>';
        } else {
            // Style B: Circle shape, bottom-left
            $colorsB = [
                ['bg' => 'background-color: #dbeafe;', 'shape' => 'background-color: #93c5fd;', 'text' => 'color: #1e3a8a;'], // blue
                ['bg' => 'background-color: #d1fae5;', 'shape' => 'background-color: #6ee7b7;', 'text' => 'color: #064e3b;'], // emerald
                ['bg' => 'background-color: #ffe4e6;', 'shape' => 'background-color: #fda4af;', 'text' => 'color: #881337;'], // rose
                ['bg' => 'background-color: #ede9fe;', 'shape' => 'background-color: #c4b5fd;', 'text' => 'color: #4c1d95;'], // violet
                ['bg' => 'background-color: #f1f5f9;', 'shape' => 'background-color: #cbd5e1;', 'text' => 'color: #0f172a;'], // slate
            ];
            $c = $colorsB[$colorIndex];

            return '<div class="mco-proc-cover-annapoorna-b" style="' . $c['bg'] . $c['text'] . '">' .
                    '<div class="mco-proc-cover-annapoorna-b__shape" style="' . $c['shape'] . '"></div>' .
                    '<div class="mco-proc-cover-annapoorna-b__content">' .
                    '<h4 class="mco-proc-cover-annapoorna-b__title">' . esc_html($title) . '</h4>' .
                    '<span class="mco-proc-cover-annapoorna-b__super-title">' . $subTitle . '</span>' .
                    '</div></div>';
        }
    }
}

if (!function_exists('mco_render_mco_procedural_cover_php')) {
   function mco_render_mco_procedural_cover_php($item_data, $type = 'book') {
        $title = html_entity_decode($item_data['title'], ENT_QUOTES, 'UTF-8');
        $hash = mco_get_hash_of_string($title);
        $styleIndex = abs($hash) % 2; $colorIndex = floor(abs($hash) / 2) % 4;
        
        $superTitle = ($type === 'program') ? 'Certification Program' : 'Study Material';
        $subTitle = ($type === 'program') ? 'Exam Prep' : 'Official Guide';

        $colorsA = [['bg' => 'background-color: #1f2937;', 'text' => 'color: #f9fafb;', 'bgWord' => 'color: #374151;'], ['bg' => 'background-color: #1e3a8a;', 'text' => 'color: #eff6ff;', 'bgWord' => 'color: #3b82f6;'], ['bg' => 'background-color: #064e3b;', 'text' => 'color: #ecfdf5;', 'bgWord' => 'color: #34d399;'], ['bg' => 'background-color: #3730a3;', 'text' => 'color: #e0e7ff;', 'bgWord' => 'color: #6366f1;']];
        $colorsB = [['bg' => 'background-color: #111827;', 'text' => 'color: #ffffff;', 'accent' => 'background-color: #f59e0b;'], ['bg' => 'background-color: #1e293b;', 'text' => 'color: #ffffff;', 'accent' => 'background-color: #0ea5e9;'], ['bg' => 'background-color: #262626;', 'text' => 'color: #ffffff;', 'accent' => 'background-color: #84cc16;'], ['bg' => 'background-color: #292524;', 'text' => 'color: #ffffff;', 'accent' => 'background-color: #f43f5e;']];
        if ($styleIndex === 0) {
            $c = $colorsA[$colorIndex];
            $words = explode(' ', $title); $bgWord = strtoupper(strlen($words[0]) > 4 ? $words[0] : (isset($words[1]) ? $words[1] : $words[0]));
            return '<div class="mco-proc-cover-mco-a" style="' . $c['bg'] . $c['text'] . '">' .
                    '<div class="mco-proc-cover-mco-a__bg-word" style="' . $c['bgWord'] . '">' . $bgWord . '</div>' .
                    '<div class="mco-proc-cover-mco-a__content">' .
                    '<h4 class="mco-proc-cover-mco-a__title">' . esc_html($title) . '</h4>' .
                    '</div></div>';
        } else {
            $c = $colorsB[$colorIndex];
            return '<div class="mco-proc-cover-mco-b" style="' . $c['bg'] . $c['text'] . '">' .
                    '<div class="mco-proc-cover-mco-b__accent-line" style="' . $c['accent'] . '"></div>' .
                    '<div class="mco-proc-cover-mco-b__header">' .
                    '<span class="mco-proc-cover-mco-b__super-title">' . $superTitle . '</span>' .
                    '<h4 class="mco-proc-cover-mco-b__title">' . esc_html($title) . '</h4>' .
                    '</div>' .
                    '<div class="mco-proc-cover-mco-b__logo-text">MCO</div>' .
                    '</div>';
        }
   }
}

if (!function_exists('mco_render_procedural_cover')) {
    function mco_render_procedural_cover($item_data, $type = 'book') {
        $config_data = mco_get_app_config_data();
        $org_id = $config_data['organizations'][0]['id'] ?? 'org-annapoorna'; // Access nested config data
        
        if ($org_id === 'org-medical-coding-online') {
            return mco_render_mco_procedural_cover_php($item_data, $type);
        }
        return mco_render_annapoorna_procedural_cover_php($item_data, $type);
    }
}


// --- 5. GEO & AFFILIATE LOGIC ---
if (!function_exists('mco_get_geo_primary_link_info')) {
    function mco_get_geo_primary_link_info($links, $override_geo = null) {
        if (empty($links) || !is_array($links)) return null;
        $links = array_filter(array_map('trim', $links));
        if (empty($links)) return null;

        $domainMap = ['com' => 'Amazon.com', 'in' => 'Amazon.in', 'ae' => 'Amazon.ae'];
        $chosen = null;

        // 1. Prioritize explicit override from URL (e.g., ?geo=in)
        if ($override_geo && !empty($links[$override_geo])) {
            $chosen = $override_geo;
        }

        // 2. Second priority: User's IP-inferred country from frontend (stored as cookie 'mco_user_geo_country_code')
        if (!$chosen && !empty($_COOKIE['mco_user_geo_country_code'])) {
            $ip_country_code = strtolower(sanitize_text_field($_COOKIE['mco_user_geo_country_code']));
            if ($ip_country_code === 'us' && !empty($links['com'])) $chosen = 'com';
            else if ($ip_country_code === 'in' && !empty($links['in'])) $chosen = 'in';
            else if ($ip_country_code === 'ae' && !empty($links['ae'])) $chosen = 'ae';
            // Add more specific country mappings if needed
        }
        
        // 3. Third priority: Generic frontend geo preference (timezone-based, stored as cookie 'mco_wp_geo_pref')
        if (!$chosen && !empty($_COOKIE['mco_wp_geo_pref']) && !empty($links[sanitize_text_field($_COOKIE['mco_wp_geo_pref'])])) {
            $chosen = sanitize_text_field($_COOKIE['mco_wp_geo_pref']);
        }

        // 4. Fallback: Default priority order
        if (!$chosen) { 
            foreach (['com', 'in', 'ae'] as $k) { 
                if (!empty($links[$k])) { 
                    $chosen = $k; 
                    break; 
                } 
            } 
        }
        return $chosen ? ['key' => $chosen, 'url' => $links[$chosen], 'domainName' => $domainMap[$chosen]] : null;
    }
}

// --- 6. RENDERERS (CARDS & PAGES) ---
if (!function_exists('mco_render_book_card_php')) {
    function mco_render_book_card_php($book_data, $type = 'showcase') {
        $primary_link_info = mco_get_geo_primary_link_info($book_data['affiliateLinks'] ?? [], $_GET['geo'] ?? null);
        $all_stores = [
            'com' => ['name' => 'Amazon.com', 'url' => $book_data['affiliateLinks']['com'] ?? ''],
            'in' => ['name' => 'Amazon.in', 'url' => $book_data['affiliateLinks']['in'] ?? ''],
            'ae' => ['name' => 'Amazon.ae', 'url' => $book_data['affiliateLinks']['ae'] ?? '']
        ];
        
        $buttons_html = '';
        foreach ($all_stores as $key => $store) {
            if (!empty($store['url'])) {
                $is_primary = $key === ($primary_link_info['key'] ?? '');
                $class = $is_primary ? 'mco-book-btn mco-book-btn--primary' : 'mco-book-btn mco-book-btn--secondary';
                $buttons_html .= '<a href="'.esc_url($store['url']).'" target="_blank" rel="noopener noreferrer" class="'.esc_attr($class).'">'.mco_get_svg_icon('book-up').' Buy on '.esc_html($store['name']).'</a>';
            }
        }
        if (empty($buttons_html)) $buttons_html = '<span class="mco-book-btn mco-book-btn--disabled">Coming Soon</span>';

        $title = html_entity_decode($book_data['title'] ?? 'Untitled Book', ENT_QUOTES, 'UTF-8');
        $thumbnail_url = esc_url($book_data['thumbnailUrl'] ?? ''); 
        $cover_html = !empty($thumbnail_url) ? '<img src="'.$thumbnail_url.'" class="mco-book-cover-image" alt="'.esc_attr($title).'">' : mco_render_procedural_cover($book_data, 'book');
        $description = html_entity_decode(wp_kses_post($book_data['description']??''), ENT_QUOTES, 'UTF-8');
        $trimmed_description = wp_trim_words($description, 20, '...');

        if ($type === 'sidebar') {
            return '
            <div class="mco-book-card-sidebar">
                <div class="mco-book-card-sidebar__cover">'.$cover_html.'</div>
                <div class="mco-book-card-sidebar__content">
                    <h4 class="mco-book-card-sidebar__title">'.esc_html($title).'</h4>
                    <div class="mco-store-buttons-sidebar">
                        <a href="'.esc_url($primary_link_info['url'] ?? '#').'" target="_blank" rel="noopener noreferrer" class="mco-book-card-sidebar__button">
                            Buy on '.esc_html($primary_link_info['domainName'] ?? 'Amazon').'
                        </a>
                    </div>
                </div>
            </div>';
        } elseif ($type === 'single') {
            return '
            <div class="mco-single-book-view">
                <div class="mco-single-book-view__cover">'.$cover_html.'</div>
                <div class="mco-single-book-view__details">
                    <h1 class="mco-single-book-view__title">'.esc_html($title).'</h1>
                    <div class="mco-single-book-view__description">'.$description.'</div>
                    <div class="mco-single-book-view__buttons">'.$buttons_html.'</div>
                </div>
            </div>';
        } else { // showcase
            return '
            <div class="mco-book-card">
                <div class="mco-book-cover">'.$cover_html.'</div>
                <div class="mco-book-card__body">
                    <h4 class="mco-book-card__title">'.esc_html($title).'</h4>
                    <p class="mco-book-card__desc">'.esc_html($trimmed_description).'</p>
                </div>
                <div class="mco-book-card__footer">
                    <div class="mco-store-buttons">'.$buttons_html.'</div>
                </div>
            </div>';
        }
    }
}

if (!function_exists('mco_render_program_card_php')) {
    function mco_render_program_card_php($program_data, $app_url) {
        $thumbnail_url = $program_data['thumbnailUrl'] ?? '';
        $cover_html = !empty($thumbnail_url) ? '<img src="'.esc_url($thumbnail_url).'" class="mco-book-cover-image" alt="'.esc_attr($program_data['name']).'">' : mco_render_procedural_cover($program_data, 'program');
        $trimmed_description = wp_trim_words(html_entity_decode($program_data['description'], ENT_QUOTES, 'UTF-8'), 20, '...');
        $program_link = rtrim($app_url, '/') . '/program/' . $program_data['id'];

        return '
        <div class="mco-book-card">
            <div class="mco-book-cover">'.$cover_html.'</div>
            <div class="mco-book-card__body">
                <a href="'.esc_url($program_link).'" style="text-decoration:none;"><h4 class="mco-book-card__title">'.esc_html(html_entity_decode($program_data['name'], ENT_QUOTES, 'UTF-8')).'</h4></a>
                <p class="mco-book-card__desc">'.esc_html($trimmed_description).'</p>
            </div>
            <div class="mco-book-card__footer">
                <div class="mco-store-buttons">
                    <a href="'.esc_url($program_link).'" class="mco-book-btn mco-book-btn--primary">
                        View Program '.mco_get_svg_icon('external-link').'
                    </a>
                </div>
            </div>
        </div>';
    }
}

// --- 7. THE MASTER [mco_exam_showcase] SHORTCODE ---
if (!function_exists('mco_exam_showcase_shortcode')) {
    function mco_exam_showcase_shortcode($atts) {
        $atts = shortcode_atts(['id' => ''], $atts); 
        $config = mco_get_app_config_data(); // Calls the updated function for full org structure
        $app_url = mco_get_exam_app_url();

        // Safely access active organization data
        $active_org_config = $config['organizations'][0] ?? [];
        $exam_product_categories = $active_org_config['examProductCategories'] ?? [];
        $all_exams = $active_org_config['exams'] ?? [];
        $all_prices = $config['examPrices'] ?? []; // examPrices is top-level
        
        $is_subscribed = (is_user_logged_in() && class_exists('WC_Subscriptions') && function_exists('wcs_user_has_subscription') && wcs_user_has_subscription(get_current_user_id(), '', 'active'));
        $owned_exams = is_user_logged_in() ? (get_user_meta(get_current_user_id(), 'mco_paid_exams', true) ?: []) : [];

        ob_start(); 
        
        echo '<div class="mco-showcase-layout">';
        echo '<div class="mco-showcase-main">';
        
        // A. SUBSCRIPTION GRID
        $subscriptions_enabled = $active_org_config['subscriptionsEnabled'] ?? true;
        if ($subscriptions_enabled && !$is_subscribed) {
            $monthly_sub_data = $all_prices['sub-monthly'] ?? null; 
            $yearly_sub_data = $all_prices['sub-yearly'] ?? null;

            if (($monthly_sub_data && isset($monthly_sub_data['productId'])) || ($yearly_sub_data && isset($yearly_sub_data['productId']))) {
                echo '<div class="mco-subscription-grid">';
                if ($monthly_sub_data && isset($monthly_sub_data['productId'])) {
                    $monthly_url = get_site_url() . '/cart/?add-to-cart=' . $monthly_sub_data['productId'];
                    echo '<div class="mco-card mco-gradient--sub-monthly" style="padding:30px; text-align:center; border:none;">
                            <h3 class="mco-sub-card__title">Monthly Plan</h3>
                            <p style="font-size:2.5rem; font-weight:800; margin:10px 0;">$'.number_format_i18n($monthly_sub_data['price'], 2).'</p>
                            <ul class="mco-sub-card__features">
                                <li>'.mco_get_svg_icon('check').'<span>Unlimited Access to ALL Practice Exams</span></li>
                                <li>'.mco_get_svg_icon('check').'<span>Unlimited AI-Powered Feedback & Study Guides</span></li>
                                <li>'.mco_get_svg_icon('check').'<span>Cancel Anytime</span></li>
                            </ul>
                            <div class="mco-card__footer"><a href="'.esc_url($monthly_url).'" class="mco-card__button mco-card__button--primary">Subscribe Now</a></div>
                          </div>';
                }
                if ($yearly_sub_data && isset($yearly_sub_data['productId'])) {
                    $yearly_url = get_site_url() . '/cart/?add-to-cart=' . $yearly_sub_data['productId'];
                    echo '<div class="mco-card mco-gradient--sub-yearly mco-card--best-value"><div class="mco-best-value-tag">' . mco_get_svg_icon('star') . ' Best Value</div><h3 class="mco-sub-card__title">Yearly Plan</h3><p style="font-size:2.5rem; font-weight:800; margin:10px 0;">$'.number_format_i18n($yearly_sub_data['price'], 2).'</p>
                            <p style="text-align:center; font-size: 0.875rem; color: #fcd34d; font-weight: 600;">Saves over 35%!</p>
                            <ul class="mco-sub-card__features">
                                <li>'.mco_get_svg_icon('check').'<span>All Monthly features</span></li>
                                <li>'.mco_get_svg_icon('check').'<span>Access All Exam Programs</span></li>
                                <li>'.mco_get_svg_icon('check').'<span>Billed Annually</span></li>
                            </ul>
                            <div class="mco-card__footer"><a href="'.esc_url($yearly_url).'" class="mco-card__button mco-card__button--primary">Subscribe & Save</a></div>
                          </div>';
                }
                echo '</div>';
            }
        }
        
        // B. PROGRAM GROUPS
        echo '<div class="mco-program-list">';
        $categories_to_display = $exam_product_categories; 
        if ($atts['id']) {
            $categories_to_display = array_filter($exam_product_categories, fn($c)=>$c['id']===$atts['id']);
        }
        
        foreach ($categories_to_display as $cat) {
            $practice_exam = current(array_filter($all_exams, fn($e)=>$e['id']===$cat['practiceExamId']));
            $cert_exam = current(array_filter($all_exams, fn($e)=>$e['id']===$cat['certificationExamId']));
            
            $program_link_url = rtrim($app_url, '/') . '/program/' . $cat['id'];

            echo '<div class="mco-program-group" id="' . esc_attr($cat['id']) . '"><a href="' . esc_url($program_link_url) . '"><h2 class="mco-program-group__title">' . esc_html($cat['name']) . '</h2></a><div class="mco-program-group__description">' . wp_kses_post($cat['description']) . '</div><div class="mco-program-group__cards">';
            
            if ($practice_exam) {
                echo '<div class="mco-card mco-gradient--practice-1">
                        <div class="mco-card__header"><span>' . mco_get_svg_icon('practice') . '</span> Practice Exam</div>
                        <div class="mco-card__body">
                            <h4 class="mco-card__subtitle">' . esc_html(html_entity_decode($practice_exam['name'], ENT_QUOTES, 'UTF-8')) . '</h4>
                            <div class="mco-card__stats">
                                <span>' . esc_html($practice_exam['numberOfQuestions']) . ' Qs</span>
                                <span>' . esc_html($practice_exam['durationMinutes']) . ' Mins</span>
                                <span>' . esc_html($practice_exam['passScore']) . '% Pass</span>
                            </div>
                        </div>
                        <div class="mco-card__footer">
                            <a href="' . esc_url($app_url . '/test/' . $practice_exam['id']) . '" class="mco-card__button mco-card__button--primary">Start Practice</a>
                        </div>
                      </div>';
            }
            
            if ($cert_exam) {
                $product_id = isset($cert_exam['productSku']) ? wc_get_product_id_by_sku($cert_exam['productSku']) : 0;
                $is_purchased = false;
                if (is_user_logged_in() && $product_id) {
                    $user_id = get_current_user_id();
                    $is_purchased = $is_subscribed || (function_exists('wc_customer_bought_product') && wc_customer_bought_product('', $user_id, $product_id));
                }
                $button_text = $is_purchased ? 'Start Exam' : 'Buy for $' . number_format_i18n($cert_exam['price'], 2);
                $button_icon = $is_purchased ? mco_get_svg_icon('practice') : mco_get_svg_icon('cart');
                $button_url = $is_purchased ? $app_url . '/test/' . $cert_exam['id'] : ($product_id ? get_site_url() . '/cart/?add-to-cart=' . $product_id : '#');
                $button_class = $is_purchased ? 'mco-card__button--primary' : 'mco-card__button--purchase';

                echo '<div class="mco-card mco-gradient--cert-1">
                        <div class="mco-card__header"><span>' . mco_get_svg_icon('cert') . '</span> Certification Exam</div>
                        <div class="mco-card__body">
                            <h4 class="mco-card__subtitle">' . esc_html(html_entity_decode($cert_exam['name'], ENT_QUOTES, 'UTF-8')) . '</h4>';
                if (!$is_purchased && $cert_exam['price'] > 0) {
                    echo '<div style="text-align: center; margin-bottom: 1rem;">';
                    if (isset($cert_exam['regularPrice']) && $cert_exam['regularPrice'] > $cert_exam['price']) echo '<span style="font-size: 1.25rem; text-decoration: line-through; opacity: 0.7;">$' . number_format_i18n($cert_exam['regularPrice'], 2) . '</span> ';
                    echo '<span style="font-size: 2.5rem; font-weight: 800; margin-left: 0.5rem;">$' . number_format_i18n($cert_exam['price'], 2) . '</span></div>';
                }
                echo '      <div class="mco-card__stats">
                                <span>' . esc_html($cert_exam['numberOfQuestions']) . ' Qs</span>
                                <span>' . esc_html($cert_exam['durationMinutes']) . ' Mins</span>
                                <span>' . esc_html($cert_exam['passScore']) . '% Pass</span>
                            </div>
                        </div>
                        <div class="mco-card__footer">
                            <a href="' . esc_url($button_url) . '" class="mco-card__button ' . $button_class . '">' . $button_icon . ' ' . $button_text . '</a>
                        </div>
                      </div>';
                
                // Addon Bundle
                $bundles_enabled = $active_org_config['bundlesEnabled'] ?? true;
                if ($bundles_enabled && isset($cert_exam['productSku'])) {
                    $subscription_bundle_sku = $cert_exam['productSku'] . '-1mo-addon';
                    $practice_bundle_sku = $cert_exam['productSku'] . '-1';
                    
                    $bundle_data = null;
                    $bundle_type = null;

                    if (isset($all_prices[$subscription_bundle_sku])) {
                        $bundle_data = $all_prices[$subscription_bundle_sku];
                        $bundle_type = 'subscription';
                    } elseif (isset($all_prices[$practice_bundle_sku])) {
                        $bundle_data = $all_prices[$practice_bundle_sku];
                        $bundle_type = 'practice';
                    }
                    
                    if ($bundle_data) {
                        $bundle_url = isset($bundle_data['productId']) ? get_site_url() . '/cart/?add-to-cart=' . $bundle_data['productId'] : '#';
                        $gradient_class = $bundle_type === 'subscription' ? 'mco-gradient--bundle-sub' : 'mco-gradient--bundle-practice';
                        $subtitle_text = $bundle_type === 'subscription' ? 'Exam + 1mo Premium' : 'Exam Bundle';
                        $desc_text = $bundle_type === 'subscription' ? 'Get This Exam PLUS 1-Month Full Access' : 'Get This Exam PLUS 1-Month Practice Access';
                        
                        echo '<div class="mco-card ' . $gradient_class . '">
                                <div class="mco-card__header"><span>' . mco_get_svg_icon('bundle') . '</span> ' . $subtitle_text . '</div>
                                <div class="mco-card__body">
                                    <h3 class="mco-card__subtitle">' . esc_html($desc_text) . '</h3>';
                        if (isset($bundle_data['price'])) {
                            echo '<div style="text-align: center; margin-bottom: 1rem;">';
                            if (isset($bundle_data['regularPrice']) && $bundle_data['regularPrice'] > $bundle_data['price']) echo '<span style="font-size: 1.25rem; text-decoration: line-through; opacity: 0.7;">$' . number_format_i18n($bundle_data['regularPrice'], 2) . '</span> ';
                            echo '<span style="font-size: 2.5rem; font-weight: 800; margin-left: 0.5rem;">$' . number_format_i18n($bundle_data['price'], 2) . '</span></div>';
                        }
                        echo '  </div>
                                <div class="mco-card__footer">
