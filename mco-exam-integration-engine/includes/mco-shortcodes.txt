<?php
if (!defined('ABSPATH')) exit;

// --- HOOKS ---
if (!function_exists('mco_register_shortcode_hooks')) {
    function mco_register_shortcode_hooks() {
        add_shortcode('mco_exam_login', 'mco_exam_login_shortcode');
        add_shortcode('mco_exam_showcase', 'mco_exam_showcase_shortcode');
        add_shortcode('exam_program', 'mco_exam_showcase_shortcode'); // Alias
        add_shortcode('mco_book_showcase', 'mco_book_showcase_shortcode');
        
        add_action('wp_enqueue_scripts', 'mco_enqueue_shortcode_styles');
        add_action('wp', 'mco_prevent_caching_on_shortcode_pages');
    }
}

if (!function_exists('mco_prevent_caching_on_shortcode_pages')) {
    function mco_prevent_caching_on_shortcode_pages() {
        if (is_admin()) return;
        global $post;
        if (is_a($post, 'WP_Post') && (
            has_shortcode($post->post_content, 'mco_exam_showcase') ||
            has_shortcode($post->post_content, 'exam_program') ||
            has_shortcode($post->post_content, 'mco_book_showcase') ||
            has_shortcode($post->post_content, 'mco_exam_login')
        )) {
            if (!defined('DONOTCACHEPAGE')) define('DONOTCACHEPAGE', true);
        }
    }
}

// --- STYLES ---
if (!function_exists('mco_enqueue_shortcode_styles')) {
    function mco_enqueue_shortcode_styles() {
        wp_enqueue_style('mco-styles', MCO_PLUGIN_URL . 'assets/mco-styles.css', [], MCO_PLUGIN_VERSION);
    }
}

// --- HELPER FUNCTIONS ---
if (!function_exists('mco_simple_hash_to_color_index')) {
    function mco_simple_hash_to_color_index($str, $max_index) {
        if (empty($str) || $max_index <= 0) return 0;
        $hash = 0;
        for ($i = 0; $i < strlen($str); $i++) {
            $hash = ord($str[$i]) + (($hash << 5) - $hash);
        }
        return abs($hash) % $max_index;
    }
}

// --- SHORTCODE IMPLEMENTATIONS ---

/**
 * [mco_exam_login]
 * Handles the SSO login flow. Place this on a dedicated page (e.g., /exam-login/).
 * If a user is logged into WordPress, it generates a JWT and redirects them to the React app.
 * If they are logged out, it redirects them to the standard WordPress login page.
 */
function mco_exam_login_shortcode() {
    if (is_user_logged_in()) {
        $app_url = mco_get_exam_app_url();
        if (!$app_url) {
            return '<p>Exam application URL is not configured. Please contact an administrator.</p>';
        }

        $user_id = get_current_user_id();
        $token = mco_generate_exam_jwt($user_id);
        
        if (!$token) {
            return '<p>Could not generate a secure authentication token. Please contact an administrator.</p>';
        }
        
        $redirect_url = add_query_arg('token', $token, rtrim($app_url, '/') . '/auth');

        if (!headers_sent()) {
            wp_redirect($redirect_url);
            exit;
        } else {
            return '<p>Redirecting to the exam portal... If you are not redirected automatically, <a href="' . esc_url($redirect_url) . '">click here</a>.</p>' .
                   '<script>window.location.href="' . esc_url($redirect_url) . '";</script>';
        }
    } else {
        $redirect_to_self = get_permalink();
        $login_url = wp_login_url($redirect_to_self);
         if (!headers_sent()) {
            wp_redirect($login_url);
            exit;
        } else {
            return '<p>Please <a href="' . esc_url($login_url) . '">log in</a> to access the exam portal.</p>';
        }
    }
}


/**
 * [mco_exam_showcase id="..."]
 * Displays one or all exam programs in a styled grid format.
 * - If `id` is provided, it shows only that specific program.
 * - If no `id`, it shows all published programs.
 */
function mco_exam_showcase_shortcode($atts) {
    $atts = shortcode_atts(['id' => ''], $atts, 'exam_program');
    $program_id_str = sanitize_text_field($atts['id']);
    
    $query_args = [
        'post_type' => 'mco_exam_program',
        'posts_per_page' => -1,
        'post_status' => 'publish',
        'orderby' => 'title',
        'order' => 'ASC',
    ];
    
    if (!empty($program_id_str)) {
        $post_id_from_app_id = (int) str_replace('prod-', '', $program_id_str);
        if ($post_id_from_app_id > 0) {
            $query_args['p'] = $post_id_from_app_id;
        } else {
            $query_args['name'] = $program_id_str;
            $query_args['posts_per_page'] = 1;
        }
    }
    
    $programs = get_posts($query_args);
    if (empty($programs)) {
        return '<p>No exam programs found.</p>';
    }
    
    $config_data = mco_get_app_config_data();
    if (!$config_data || !is_array($config_data) || !isset($config_data['organizations']) || !is_array($config_data['organizations']) || empty($config_data['organizations'])) {
        return '<p>Error: Could not load exam configuration data. Please contact an administrator.</p>';
    }
    $active_org_data = $config_data['organizations'][0];
     if (!is_array($active_org_data)) {
        return '<p>Error: Invalid organization configuration. Please contact an administrator.</p>';
    }
    
    $org_exams = isset($active_org_data['exams']) && is_array($active_org_data['exams']) ? $active_org_data['exams'] : [];
    $org_exam_categories = isset($active_org_data['examProductCategories']) && is_array($active_org_data['examProductCategories']) ? $active_org_data['examProductCategories'] : [];
    $exam_prices = isset($config_data['examPrices']) && is_array($config_data['examPrices']) ? $config_data['examPrices'] : [];

    $app_url = mco_get_exam_app_url();
    if (!$app_url) {
        return '<p>Exam application URL is not configured. Please contact an administrator.</p>';
    }

    $icons = [
        'practice' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
        'cert' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>',
        'cart' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>',
        'bundle' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>',
        'check' => '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>',
        'star' => '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
    ];

    ob_start();
    
    $is_wc_active = class_exists('WooCommerce');
    $is_user_logged_in = is_user_logged_in();
    $current_user_id = $is_user_logged_in ? get_current_user_id() : 0;
    $is_subscribed = false;
    if ($is_wc_active && $is_user_logged_in && class_exists('WC_Subscriptions') && function_exists('wcs_user_has_subscription')) {
        $is_subscribed = wcs_user_has_subscription($current_user_id, '', 'active');
    }

    // --- Subscription Offers Section ---
    if (!$is_subscribed && empty($program_id_str)) {
        $monthly_sub = isset($exam_prices['sub-monthly']) ? $exam_prices['sub-monthly'] : null;
        $yearly_sub = isset($exam_prices['sub-yearly']) ? $exam_prices['sub-yearly'] : null;
        
        if ($is_wc_active && (($monthly_sub && isset($monthly_sub['productId'])) || ($yearly_sub && isset($yearly_sub['productId'])))) {
            echo '<div class="mco-subscription-grid">';
            
            if ($monthly_sub && isset($monthly_sub['productId'])) {
                $monthly_url = get_site_url() . '/cart/?add-to-cart=' . $monthly_sub['productId'];
                echo '<div class="mco-card mco-gradient--sub-monthly">';
                echo '<h3 class="mco-sub-card__title">Monthly Subscription</h3>';
                echo '<p class="mco-sub-card__description">Perfect for focused, short-term preparation.</p>';
                echo '<div class="mco-sub-card__price">';
                if (isset($monthly_sub['regularPrice']) && is_numeric($monthly_sub['regularPrice']) && $monthly_sub['regularPrice'] > $monthly_sub['price']) {
                    echo '<span style="font-size: 1.25rem; text-decoration: line-through; opacity: 0.7;">$' . number_format_i18n($monthly_sub['regularPrice'], 2) . '</span> ';
                }
                echo '<span class="mco-sub-card__price-value">$' . number_format_i18n($monthly_sub['price'], 2) . '</span>';
                echo '<span class="mco-sub-card__price-unit">/month</span>';
                echo '</div>';
                echo '<ul class="mco-sub-card__features">';
                echo '<li>' . $icons['check'] . '<span>Unlimited Access to ALL Practice Exams</span></li>';
                echo '<li>' . $icons['check'] . '<span>Unlimited AI-Powered Feedback & Study Guides</span></li>';
                echo '<li>' . $icons['check'] . '<span>Cancel Anytime</span></li>';
                echo '</ul>';
                echo '<div class="mco-card__footer">';
                echo '<a href="' . esc_url($monthly_url) . '" class="mco-card__button mco-card__button--primary">Subscribe Now</a>';
                echo '</div></div>';
            }
            
            if ($yearly_sub && isset($yearly_sub['productId'])) {
                $yearly_url = get_site_url() . '/cart/?add-to-cart=' . $yearly_sub['productId'];
                echo '<div class="mco-card mco-gradient--sub-yearly mco-card--best-value">';
                echo '<div class="mco-best-value-tag">' . $icons['star'] . ' Best Value</div>';
                echo '<h3 class="mco-sub-card__title">Yearly Subscription</h3>';
                echo '<p class="mco-sub-card__description">For continuous learning and preparing for multiple certifications.</p>';
                echo '<div class="mco-sub-card__price">';
                if (isset($yearly_sub['regularPrice']) && is_numeric($yearly_sub['regularPrice']) && $yearly_sub['regularPrice'] > $yearly_sub['price']) {
                    echo '<span style="font-size: 1.25rem; text-decoration: line-through; opacity: 0.7;">$' . number_format_i18n($yearly_sub['regularPrice'], 2) . '</span> ';
                }
                echo '<span class="mco-sub-card__price-value">$' . number_format_i18n($yearly_sub['price'], 2) . '</span>';
                echo '<span class="mco-sub-card__price-unit">/year</span>';
                echo '</div>';
                echo '<p style="text-align:center; font-size: 0.875rem; color: #fcd34d; font-weight: 600;">Saves over 35%!</p>';
                echo '<ul class="mco-sub-card__features">';
                echo '<li>' . $icons['check'] . '<span>All Monthly features</span></li>';
                echo '<li>' . $icons['check'] . '<span>Access All Exam Programs</span></li>';
                echo '<li>' . $icons['check'] . '<span>Billed Annually</span></li>';
                echo '</ul>';
                echo '<div class="mco-card__footer">';
                echo '<a href="' . esc_url($yearly_url) . '" class="mco-card__button mco-card__button--primary">Subscribe & Save</a>';
                echo '</div></div>';
            }
            
            echo '</div>';
        }
    }


    echo '<div class="mco-showcase-grid">';
    foreach ($programs as $program_post) {
        $app_program_id = 'prod-' . $program_post->ID;
        
        $program_category = current(array_filter($org_exam_categories, function($c) use ($app_program_id) { 
            return is_array($c) && isset($c['id']) && $c['id'] === $app_program_id; 
        }));
        
        if (!$program_category || !is_array($program_category)) {
            continue;
        }
        
        $practice_exam = current(array_filter($org_exams, function($e) use ($program_category) { 
            return is_array($e) && isset($e['id'], $program_category['practiceExamId']) && $e['id'] === $program_category['practiceExamId']; 
        }));
        $cert_exam = current(array_filter($org_exams, function($e) use ($program_category) { 
            return is_array($e) && isset($e['id'], $program_category['certificationExamId']) && $e['id'] === $program_category['certificationExamId']; 
        }));

        $program_link_url = rtrim($app_url, '/') . '/program/' . $app_program_id;

        echo '<div class="mco-program-group" id="' . esc_attr($app_program_id) . '">';
        echo '<a href="' . esc_url($program_link_url) . '"><h2 class="mco-program-group__title">' . esc_html($program_category['name']) . '</h2></a>';
        echo '<div class="mco-program-group__description">' . wp_kses_post($program_category['description']) . '</div>';
        echo '<div class="mco-program-group__cards">';

        // Practice Exam Card
        if ($practice_exam) {
            echo '<div class="mco-card mco-gradient--practice-1">';
            echo '<div class="mco-card__header"><span>' . $icons['practice'] . '</span> Practice Exam</div>';
            echo '<div class="mco-card__body">';
            echo '<h3 class="mco-card__subtitle">' . esc_html($practice_exam['name']) . '</h3>';
            echo '<div class="mco-card__stats"><span>' . esc_html($practice_exam['numberOfQuestions']) . ' Qs</span><span>' . esc_html($practice_exam['durationMinutes']) . ' Mins</span><span>' . esc_html($practice_exam['passScore']) . '% Pass</span></div>';
            echo '</div>';
            echo '<div class="mco-card__footer">';
            echo '<a href="' . esc_url(mco_get_exam_app_url() . '/test/' . $practice_exam['id']) . '" class="mco-card__button mco-card__button--primary">Start Practice</a>';
            echo '</div>';
            echo '</div>';
        }

        // Certification Exam Card
        if ($cert_exam && $is_wc_active) {
            $product_id = 0;
            if (isset($cert_exam['productSku']) && function_exists('wc_get_product_id_by_sku')) {
                $product_id = wc_get_product_id_by_sku($cert_exam['productSku']);
            }
            
            $is_purchased = $is_subscribed;
            if (!$is_purchased && $is_user_logged_in && $product_id && function_exists('wc_customer_bought_product')) {
                $is_purchased = wc_customer_bought_product('', $current_user_id, $product_id);
            }

            $button_text = $is_purchased ? 'Start Exam' : 'Add to Cart';
            $button_icon = $is_purchased ? $icons['practice'] : $icons['cart'];
            $button_url = $is_purchased ? mco_get_exam_app_url() . '/test/' . $cert_exam['id'] : ($product_id ? get_site_url() . '/cart/?add-to-cart=' . $product_id : '#');
            $button_class = $is_purchased ? 'mco-card__button--primary' : 'mco-card__button--purchase';

            echo '<div class="mco-card mco-gradient--cert-1">';
            echo '<div class="mco-card__header"><span>' . $icons['cert'] . '</span> Certification Exam</div>';
            echo '<div class="mco-card__body">';
            echo '<h3 class="mco-card__subtitle">' . esc_html($cert_exam['name']) . '</h3>';
            if (!$is_purchased && isset($cert_exam['price']) && $cert_exam['price'] > 0) {
                echo '<div style="text-align: center; margin-bottom: 1rem;">';
                if (isset($cert_exam['regularPrice']) && is_numeric($cert_exam['regularPrice']) && $cert_exam['regularPrice'] > $cert_exam['price']) {
                    echo '<span style="font-size: 1.25rem; text-decoration: line-through; opacity: 0.7;">$' . number_format_i18n($cert_exam['regularPrice'], 2) . '</span>';
                }
                echo '<span style="font-size: 2.5rem; font-weight: 800; margin-left: 0.5rem;">$' . number_format_i18n($cert_exam['price'], 2) . '</span>';
                echo '</div>';
            }
            echo '<div class="mco-card__stats"><span>' . esc_html($cert_exam['numberOfQuestions']) . ' Qs</span><span>' . esc_html($cert_exam['durationMinutes']) . ' Mins</span><span>' . esc_html($cert_exam['passScore']) . '% Pass</span></div>';
            echo '</div>';
            echo '<div class="mco-card__footer">';
            echo '<a href="' . esc_url($button_url) . '" class="mco-card__button ' . $button_class . '">' . $button_icon . ' ' . $button_text . '</a>';
            echo '</div>';
            echo '</div>';
        }

        // --- Refactored & Resilient Bundle Card Logic ---
        if ($cert_exam && isset($cert_exam['productSku'])) {
            $subscription_bundle_sku = $cert_exam['productSku'] . '-1mo-addon';
            $practice_bundle_sku = $cert_exam['productSku'] . '-1';
        
            $bundle_to_render = null;
            $bundle_type = '';
        
            if (isset($exam_prices[$subscription_bundle_sku]) && is_array($exam_prices[$subscription_bundle_sku])) {
                $bundle_to_render = $exam_prices[$subscription_bundle_sku];
                $bundle_type = 'subscription';
            } elseif (isset($exam_prices[$practice_bundle_sku]) && is_array($exam_prices[$practice_bundle_sku])) {
                $bundle_to_render = $exam_prices[$practice_bundle_sku];
                $bundle_type = 'practice';
            }
        
            if ($bundle_to_render) {
                $bundle_product_id = isset($bundle_to_render['productId']) ? $bundle_to_render['productId'] : null;
                $bundle_url = $bundle_product_id ? get_site_url() . '/cart/?add-to-cart=' . $bundle_product_id : '#';
        
                $gradient_class = $bundle_type === 'subscription' ? 'mco-gradient--sub-bundle-1' : 'mco-gradient--bundle-1';
                $header_title = $bundle_type === 'subscription' ? 'Exam + Subscription' : 'Exam Bundle';
                $subtitle = $bundle_type === 'subscription' 
                    ? 'Get the certification exam plus one month of full subscription benefits.'
                    : 'The complete package for your certification.';
                $features = $bundle_type === 'subscription' 
                    ? ['One Certification Exam', '1-Month Full Subscription', '<span style="padding-left: 28px; font-size: 0.8rem; opacity: 0.8;">Incl. Unlimited Practice & AI Feedback</span>']
                    : ['One Certification Exam', '1-Month Unlimited Practice', '1-Month Unlimited AI Feedback'];
        
                echo '<div class="mco-card ' . esc_attr($gradient_class) . '">';
                echo '<div class="mco-card__header"><span>' . $icons['bundle'] . '</span> ' . esc_html($header_title) . '</div>';
                echo '<div class="mco-card__body">';
                echo '<h3 class="mco-card__subtitle">' . esc_html($subtitle) . '</h3>';
        
                if (isset($bundle_to_render['price']) && is_numeric($bundle_to_render['price']) && $bundle_to_render['price'] > 0) {
                    echo '<div style="text-align: center; margin-bottom: 1rem;">';
                    if (isset($bundle_to_render['regularPrice']) && is_numeric($bundle_to_render['regularPrice']) && $bundle_to_render['regularPrice'] > $bundle_to_render['price']) {
                        echo '<span style="font-size: 1.25rem; text-decoration: line-through; opacity: 0.7;">$' . number_format_i18n($bundle_to_render['regularPrice'], 2) . '</span>';
                    }
                    echo '<span style="font-size: 2.5rem; font-weight: 800; margin-left: 0.5rem;">$' . number_format_i18n($bundle_to_render['price'], 2) . '</span>';
                    echo '</div>';
                }
        
                echo '<ul class="mco-sub-card__features">';
                foreach ($features as $feature) {
                     $is_sub_feature = strpos($feature, '<span') === 0;
                     if ($is_sub_feature) {
                         echo '<li>' . $feature . '</li>'; // Not escaping because it contains intentional HTML
                     } else {
                         echo '<li>' . $icons['check'] . '<span>' . esc_html($feature) . '</span></li>';
                     }
                }
                echo '</ul>';
        
                echo '</div>';
                echo '<div class="mco-card__footer">';
                echo '<a href="' . esc_url($bundle_url) . '" class="mco-card__button mco-card__button--purchase">' . $icons['cart'] . ' Purchase Bundle</a>';
                echo '</div>';
                echo '</div>';
            }
        }
        echo '</div></div>'; // Close cards and group
    }
    echo '</div>'; // Close grid
    return ob_get_clean();
}


/**
 * [mco_book_showcase]
 * Displays all recommended books in a styled grid.
 */
function mco_book_showcase_shortcode() {
    $books = get_posts(['post_type' => 'mco_recommended_book', 'posts_per_page' => -1, 'post_status' => 'publish']);
    if (empty($books)) return '<p>No recommended books found.</p>';
    
    $icons = ['cart' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>'];

    ob_start();
    echo '<div class="mco-grid">';
    foreach ($books as $index => $book_post) {
        $book = [
            'title' => wp_strip_all_tags(get_the_title($book_post)),
            'description' => has_excerpt($book_post->ID) ? wp_strip_all_tags(get_the_excerpt($book_post->ID)) : wp_strip_all_tags(wp_trim_words($book_post->post_content, 30, '...')),
            'thumbnailUrl' => get_post_meta($book_post->ID, '_mco_thumbnail_url', true) ?: get_the_post_thumbnail_url($book_post->ID, 'medium_large'),
            'links' => [
                'com' => get_post_meta($book_post->ID, '_mco_link_com', true),
                'in' => get_post_meta($book_post->ID, '_mco_link_in', true),
                'ae' => get_post_meta($book_post->ID, '_mco_link_ae', true),
            ]
        ];

        echo '<div class="mco-card mco-card--book">';
        
        if ($book['thumbnailUrl']) {
            echo '<div class="mco-book-cover mco-book-cover--image"><img src="' . esc_url($book['thumbnailUrl']) . '" alt="' . esc_attr($book['title']) . '"/></div>';
        } else {
            $title_words = explode(' ', $book['title']);
            $color_index = mco_simple_hash_to_color_index($book['title'], 9); // Use 9 colors
            echo '<div class="mco-book-cover mco-book-cover--procedural mco-book-cover--color-' . $color_index . '">';
            echo '<h4 class="mco-book-cover__title">' . esc_html(implode(' ', array_slice($title_words, 0, 4))) . '</h4>';
            if (count($title_words) > 4) echo '<p class="mco-book-cover__subtitle">' . esc_html(implode(' ', array_slice($title_words, 4))) . '</p>';
            echo '<div class="mco-book-cover__accent"></div>';
            echo '</div>';
        }
        
        echo '<div class="mco-card__body">';
        echo '<h3 class="mco-card__title">' . esc_html($book['title']) . '</h3>';
        echo '<p class="mco-card__description">' . esc_html($book['description']) . '</p>';
        echo '</div>';
        
        echo '<div class="mco-card__footer">';
        $link_found = false;
        if (!empty($book['links']['com'])) { echo '<a href="' . esc_url($book['links']['com']) . '" target="_blank" rel="noopener" class="mco-card__button mco-card__button--purchase">' . $icons['cart'] . ' Buy on Amazon.com</a>'; $link_found = true; }
        if (!empty($book['links']['in'])) { echo '<a href="' . esc_url($book['links']['in']) . '" target="_blank" rel="noopener" class="mco-card__button mco-card__button--secondary">Buy on Amazon.in</a>'; $link_found = true; }
        if (!empty($book['links']['ae'])) { echo '<a href="' . esc_url($book['links']['ae']) . '" target="_blank" rel="noopener" class="mco-card__button mco-card__button--secondary">Buy on Amazon.ae</a>'; $link_found = true; }
        if (!$link_found) { echo '<p class="mco-card__no-links">Purchase links unavailable.</p>'; }
        echo '</div>';
        
        echo '</div>';
    }
    echo '</div>';
    return ob_get_clean();
}
?>