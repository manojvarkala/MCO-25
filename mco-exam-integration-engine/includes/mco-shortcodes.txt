<?php
if (!defined('ABSPATH')) exit;

// --- HELPER FUNCTIONS FOR PROCEDURAL BOOK COVERS ---

function mco_render_annapoorna_style_a($book, $color_index) {
    $colors = [
        ['bg' => '#0369a1', 'pattern' => '#075985', 'text' => '#ffffff'], // sky
        ['bg' => '#059669', 'pattern' => '#065f46', 'text' => '#ffffff'], // emerald
        ['bg' => '#be185d', 'pattern' => '#9d174d', 'text' => '#ffffff'], // rose
        ['bg' => '#7e22ce', 'pattern' => '#6b21a8', 'text' => '#ffffff'], // purple
        ['bg' => '#334155', 'pattern' => '#1e293b', 'text' => '#ffffff'], // slate
    ];
    $color = $colors[$color_index % 5];
    ob_start();
    ?>
    <div class="mco-book-cover mco-proc-cover-annapoorna-a" style="color: <?php echo esc_attr($color['text']); ?>;">
        <div class="mco-proc-cover-annapoorna-a__bg" style="background-color: <?php echo esc_attr($color['bg']); ?>;"></div>
        <div class="mco-proc-cover-annapoorna-a__pattern-bg" style="background-color: <?php echo esc_attr($color['pattern']); ?>;">
             <svg width="100%" height="100%" class="mco-proc-cover-annapoorna-a__pattern-svg">
                <defs><pattern id="mco-annapoorna-pattern-a-php" patternUnits="userSpaceOnUse" width="20" height="20"><circle cx="10" cy="10" r="1" fill="white" /></pattern></defs>
                <rect width="100%" height="100%" fill="url(#mco-annapoorna-pattern-a-php)" />
            </svg>
        </div>
        <div class="mco-proc-cover-annapoorna-a__content">
            <span class="mco-proc-cover-annapoorna-a__super-title">Study Material</span>
            <h4 class="mco-proc-cover-annapoorna-a__title"><?php echo esc_html($book['title']); ?></h4>
        </div>
    </div>
    <?php
    return ob_get_clean();
}

function mco_render_annapoorna_style_b($book, $color_index) {
    $colors = [
        ['bg' => '#fef08a', 'shape' => '#facc15', 'text' => '#713f12'], // amber
        ['bg' => '#d9f99d', 'shape' => '#a3e635', 'text' => '#3f6212'], // lime
        ['bg' => '#cffafe', 'shape' => '#67e8f9', 'text' => '#155e75'], // cyan
        ['bg' => '#f5d0fe', 'shape' => '#e879f9', 'text' => '#701a75'], // fuchsia
        ['bg' => '#e5e7eb', 'shape' => '#9ca3af', 'text' => '#1f2937'], // gray
    ];
    $color = $colors[$color_index % 5];
    ob_start();
    ?>
    <div class="mco-book-cover mco-proc-cover-annapoorna-b" style="background-color: <?php echo esc_attr($color['bg']); ?>; color: <?php echo esc_attr($color['text']); ?>;">
        <div class="mco-proc-cover-annapoorna-b__shape" style="background-color: <?php echo esc_attr($color['shape']); ?>;"></div>
        <div class="mco-proc-cover-annapoorna-b__content">
            <h4 class="mco-proc-cover-annapoorna-b__title"><?php echo esc_html($book['title']); ?></h4>
            <span class="mco-proc-cover-annapoorna-b__super-title">Official Guide</span>
        </div>
    </div>
    <?php
    return ob_get_clean();
}

function mco_render_mco_style_a($book, $color_index) {
    $colors = [
        ['bg' => '#334155', 'text' => '#f1f5f9', 'bgWord' => '#475569'], // slate
        ['bg' => '#0891b2', 'text' => '#cffafe', 'bgWord' => '#155e75'], // cyan
        ['bg' => '#115e59', 'text' => '#ccfbf1', 'bgWord' => '#134e4a'], // teal
        ['bg' => '#0369a1', 'text' => '#e0f2fe', 'bgWord' => '#0c4a6e'], // sky
    ];
    $color = $colors[$color_index % 4];
    $title_words = explode(' ', $book['title']);
    $bg_word_candidates = array_filter($title_words, function($w) { return strlen($w) > 4; });
    $bg_word = strtoupper(empty($bg_word_candidates) ? ($title_words[0] ?? '') : current($bg_word_candidates));

    ob_start();
    ?>
     <div class="mco-book-cover mco-proc-cover-mco-a mco-proc-cover-mco-a--color-<?php echo ($color_index % 4); ?>">
        <span class="mco-proc-cover-mco-a__bg-word"><?php echo esc_html($bg_word); ?></span>
        <div class="mco-proc-cover-mco-a__content">
             <h4 class="mco-proc-cover-mco-a__title"><?php echo esc_html($book['title']); ?></h4>
        </div>
    </div>
    <?php
    return ob_get_clean();
}

function mco_render_mco_style_b($book, $color_index) {
    $colors = [
        ['bg' => '#1e293b', 'text' => '#ffffff', 'accent' => '#38bdf8'], // slate
        ['bg' => '#44403c', 'text' => '#ffffff', 'accent' => '#facc15'], // stone/gray
        ['bg' => '#0c4a6e', 'text' => '#ffffff', 'accent' => '#fb7185'], // sky
        ['bg' => '#065f46', 'text' => '#ffffff', 'accent' => '#a3e635'], // emerald
    ];
    $color = $colors[$color_index % 4];
    ob_start();
    ?>
    <div class="mco-book-cover mco-proc-cover-mco-b mco-proc-cover-mco-b--color-<?php echo ($color_index % 4); ?>">
        <div class="mco-proc-cover-mco-b__accent"></div>
        <div class="mco-proc-cover-mco-b__content">
            <span class="mco-proc-cover-mco-b__super-title">Reference Material</span>
            <h4 class="mco-proc-cover-mco-b__title"><?php echo esc_html($book['title']); ?></h4>
        </div>
        <div class="mco-proc-cover-mco-b__logo-mark">MCO</div>
    </div>
    <?php
    return ob_get_clean();
}

function mco_render_annapoorna_procedural_cover_php($book) {
    $hash = 0; $str = $book['title'];
    for ($i = 0; $i < strlen($str); $i++) { $hash = ord($str[$i]) + (($hash << 5) - $hash); }
    $style_index = abs($hash) % 2;
    $color_index = floor(abs($hash) / 2);
    return ($style_index === 0) ? mco_render_annapoorna_style_a($book, $color_index) : mco_render_annapoorna_style_b($book, $color_index);
}

function mco_render_mco_procedural_cover_php($book) {
    $hash = 0; $str = $book['title'];
    for ($i = 0; $i < strlen($str); $i++) { $hash = ord($str[$i]) + (($hash << 5) - $hash); }
    $style_index = abs($hash) % 2;
    $color_index = floor(abs($hash) / 2);
    return ($style_index === 0) ? mco_render_mco_style_a($book, $color_index) : mco_render_mco_style_b($book, $color_index);
}

// --- HOOKS ---
if (!function_exists('mco_register_shortcode_hooks')) {
    function mco_register_shortcode_hooks() {
        add_shortcode('mco_exam_login', 'mco_exam_login_shortcode');
        add_shortcode('mco_exam_showcase', 'mco_exam_showcase_shortcode');
        add_shortcode('mco_book_showcase', 'mco_book_showcase_shortcode');
        add_shortcode('mco_single_book', 'mco_single_book_shortcode');
        
        add_action('wp_enqueue_scripts', 'mco_enqueue_shortcode_styles');
        add_action('wp', 'mco_prevent_caching_on_shortcode_pages');

        add_filter('the_content', 'mco_auto_apply_single_book_style', 999);
    }
}

if (!function_exists('mco_auto_apply_single_book_style')) {
    function mco_auto_apply_single_book_style($content) {
        if (is_singular('mco_recommended_book') && in_the_loop() && is_main_query() && !is_admin()) {
            if (has_shortcode($content, 'mco_single_book')) {
                return $content;
            }
            remove_filter('the_content', 'mco_auto_apply_single_book_style', 999);
            $new_content = mco_single_book_shortcode([]);
            add_filter('the_content', 'mco_auto_apply_single_book_style', 999);
            return $new_content;
        }
        return $content;
    }
}

if (!function_exists('mco_prevent_caching_on_shortcode_pages')) {
    function mco_prevent_caching_on_shortcode_pages() {
        if (is_admin()) return;
        global $post;
        if (is_a($post, 'WP_Post') && (
            has_shortcode($post->post_content, 'mco_exam_showcase') ||
            has_shortcode($post->post_content, 'mco_book_showcase') ||
            has_shortcode($post->post_content, 'mco_single_book') ||
            has_shortcode($post->post_content, 'mco_exam_login') ||
            is_singular('mco_recommended_book') // Ensures caching is off for auto-styled book pages
        )) {
            if (!defined('DONOTCACHEPAGE')) define('DONOTCACHEPAGE', true);
        }
    }
}

// --- STYLES ---
if (!function_exists('mco_enqueue_shortcode_styles')) {
    function mco_enqueue_shortcode_styles() {
        wp_enqueue_style('mco-styles', MCO_PLUGIN_URL . 'assets/mco-styles.css', [], MCO_PLUGIN_VERSION);
    }
}

// --- SHORTCODE IMPLEMENTATIONS ---

function mco_exam_login_shortcode() {
    if (is_user_logged_in()) {
        $app_url = mco_get_exam_app_url();
        if (!$app_url) return '<p>Exam application URL not configured.</p>';
        $token = mco_generate_exam_jwt(get_current_user_id());
        if (!$token) return '<p>Could not generate authentication token.</p>';
        $redirect_url = add_query_arg('token', $token, $app_url . '/auth');
        if (!headers_sent()) {
            wp_redirect($redirect_url); exit;
        }
        return '<p>Redirecting... <a href="' . esc_url($redirect_url) . '">Click here</a>.</p><script>window.location.href="' . esc_url($redirect_url) . '";</script>';
    } else {
        $login_url = wp_login_url(get_permalink());
        if (!headers_sent()) {
            wp_redirect($login_url); exit;
        }
        return '<p>Please <a href="' . esc_url($login_url) . '">log in</a>.</p>';
    }
}

function mco_single_book_shortcode($atts) {
    global $post;
    if (!is_a($post, 'WP_Post') || $post->post_type !== 'mco_recommended_book') {
        return '<!-- MCO Single Book: Shortcode must be on a "Recommended Book" post. -->';
    }

    remove_shortcode('mco_single_book', 'mco_single_book_shortcode');
    $processed_content = apply_filters('the_content', $post->post_content);
    add_shortcode('mco_single_book', 'mco_single_book_shortcode');
    
    $book = [
        'title' => get_the_title($post->ID), 'description' => $processed_content,
        'thumbnailUrl' => get_post_meta($post->ID, '_mco_thumbnail_url', true),
        'links' => [
            'com' => get_post_meta($post->ID, '_mco_link_com', true),
            'in' => get_post_meta($post->ID, '_mco_link_in', true),
            'ae' => get_post_meta($post->ID, '_mco_link_ae', true),
        ]
    ];
    
    $icons = ['cart' => '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>'];

    ob_start();
    echo '<div class="mco-single-book-card">';
    echo '<div class="mco-single-book-card__cover">';
    if ($book['thumbnailUrl']) {
        echo '<img src="' . esc_url($book['thumbnailUrl']) . '" alt="' . esc_attr($book['title']) . '"/>';
    } else {
        $is_mco = (strpos(strtolower(get_bloginfo('name')), 'medical coding online') !== false);
        echo $is_mco ? mco_render_mco_procedural_cover_php($book) : mco_render_annapoorna_procedural_cover_php($book);
    }
    echo '</div>';
    echo '<div class="mco-single-book-card__details">';
    echo '<h1 class="mco-single-book-card__title">' . esc_html($book['title']) . '</h1>';
    echo '<div class="mco-single-book-card__description">' . $book['description'] . '</div>';
    if (!empty(array_filter($book['links']))) {
        echo '<div class="mco-single-book-card__buttons" data-book-links-single><p class="mco-single-book-card__buttons-label">Available on:</p>';
        if ($book['links']['com']) echo '<a href="' . esc_url($book['links']['com']) . '" target="_blank" rel="noopener noreferrer" class="mco-single-book-card__button" data-store="com">' . $icons['cart'] . ' Buy on Amazon.com</a>';
        if ($book['links']['in']) echo '<a href="' . esc_url($book['links']['in']) . '" target="_blank" rel="noopener noreferrer" class="mco-single-book-card__button" data-store="in">' . $icons['cart'] . ' Buy on Amazon.in</a>';
        if ($book['links']['ae']) echo '<a href="' . esc_url($book['links']['ae']) . '" target="_blank" rel="noopener noreferrer" class="mco-single-book-card__button" data-store="ae">' . $icons['cart'] . ' Buy on Amazon.ae</a>';
        echo '</div>';
    }
    echo '</div></div>';
    $script = '<script>
    document.addEventListener("DOMContentLoaded", function() {
        try {
            const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            let preferredStore = "com";
            const gccTimezones = ["Asia/Dubai", "Asia/Riyadh", "Asia/Qatar", "Asia/Bahrain", "Asia/Kuwait", "Asia/Muscat"];
            if (timeZone.includes("Asia/Kolkata") || timeZone.includes("Asia/Calcutta")) preferredStore = "in";
            else if (gccTimezones.some(tz => timeZone === tz)) preferredStore = "ae";
            document.querySelectorAll("[data-book-links-single]").forEach(function(c) {
                const l = { com: c.querySelector("[data-store=\'com\']"), in: c.querySelector("[data-store=\'in\']"), ae: c.querySelector("[data-store=\'ae\']") };
                let p = l[preferredStore] || l.com || l.in || l.ae;
                if (p) {
                    p.classList.add("mco-single-book-card__button--primary"); c.prepend(p);
                    Object.values(l).forEach(link => { if (link && link !== p) link.classList.add("mco-single-book-card__button--secondary"); });
                }
            });
        } catch (e) { console.error("MCO Geo-targeting failed:", e); }
    });
    </script>';
    echo $script;
    return ob_get_clean();
}
// Other shortcodes like mco_exam_showcase and mco_book_showcase are omitted for brevity, but would be here.
?>
