<?php
if (!defined('ABSPATH')) exit;

// --- COMPATIBILITY LAYER ---
// These functions are primarily defined in mco-api.php.
// This compatibility layer provides a fallback or ensures they are always callable.
if (!function_exists('mco_get_exam_app_url')) {
    function mco_get_exam_app_url($all = false) {
        $urls = get_option('mco_exam_app_url', '');
        $url_list = array_filter(array_map('trim', explode("\n", $urls)));
        return $all ? $url_list : (isset($url_list[0]) ? $url_list[0] : '');
    }
}
if (!function_exists('mco_get_app_config_data')) {
    function mco_get_app_config_data() {
        // This function is usually provided by mco-data.php
        if (function_exists('mco_get_full_snapshot_data')) {
            // Simplified return for shortcode context, assuming `mco_get_full_snapshot_data` returns what's needed.
            $snapshot = mco_get_full_snapshot_data(false); // Pass false to get full data
            return $snapshot['organizations'][0] ?? []; // Assume single organization model for shortcode
        }
        return [];
    }
}
if (!function_exists('mco_generate_exam_jwt')) {
    // This function is usually provided by mco-api.php.
    // This fallback would only be used if mco-api.php wasn't loaded or didn't define it.
    // It's a minimal stub, not a full JWT implementation for safety.
    function mco_generate_exam_jwt($user_id) {
        // Fallback for when mco-api.php's full JWT generation isn't available
        error_log('MCO SHORTCODE: Using JWT fallback, full API not loaded.');
        if (!defined('MCO_JWT_SECRET')) return null;

        $user = get_user_by('ID', $user_id);
        if (!$user) return null;

        $header = base64_encode(json_encode(['typ' => 'JWT', 'alg' => 'HS256']));
        $payload = base64_encode(json_encode([
            'iss' => get_bloginfo('url'),
            'iat' => time(),
            'exp' => time() + (1 * HOUR_IN_SECONDS), // Short expiry for fallback
            'user' => [
                'id' => (string)$user->ID,
                'name' => $user->display_name,
                'email' => $user->user_email,
                'isAdmin' => user_can($user->ID, 'manage_options')
            ],
            'paidExamIds' => [], // Empty for fallback
            'isSubscribed' => false,
            'subscriptionInfo' => null,
            'isBetaTester' => false
        ]));
        
        $signature = hash_hmac('sha256', "{$header}.{$payload}", MCO_JWT_SECRET, true);
        return rtrim(strtr($header, '+/', '-_'), '=') . "." . rtrim(strtr($payload, '+/', '-_'), '=') . "." . rtrim(strtr(base64_encode($signature), '+/', '-_'), '=');
    }
}

// --- CSS LOADER HELPER ---
if (!function_exists('mco_load_shortcode_css')) {
    function mco_load_shortcode_css() {
        $css_path = MCO_PLUGIN_PATH . 'assets/mco-styles.css';
        if (file_exists($css_path)) {
            $css = file_get_contents($css_path);
            if ($css) {
                // Minify CSS by removing comments and extra whitespace
                $css = preg_replace('!/\*[^*]*\*+([^/][^*]*\*+)*/!', '', $css);
                $css = str_replace(array("\r\n", "\r", "\n", "\t", '  ', '    ', '    '), '', $css);
                echo '<style>' . $css . '</style>';
                return;
            }
        }
        echo mco_get_scoped_css();
    }
}

// --- ICON HELPER ---
if (!function_exists('mco_get_svg_icon')) {
    function mco_get_svg_icon($name) {
        $icons = [
            'practice' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
            'cert' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>',
            'cart' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>',
            'bundle' => '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>',
            'check' => '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>',
            'star' => '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
            'book' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
            'user' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            'lock' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
            'unlock' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',
            'search' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>',
            'filter' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>',
            'arrow-right' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>',
            'chevron-down' => '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></polyline></svg>',
            'external-link' => '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>',
        ];
        return $icons[$name] ?? '';
    }
}

// --- SCOPED CSS GENERATOR (Fallback) ---
if (!function_exists('mco_get_scoped_css')) {
    function mco_get_scoped_css() {
        return '<style>
        /* Full Frontend Styles Fallback */
        #mco-app-root { font-family: system-ui, -apple-system, sans-serif; --mco-primary: #0891b2; --mco-primary-hover: #0e7490; --mco-text: #334155; --mco-bg: #fff; --mco-border: #e2e8f0; color: #334155; line-height: 1.5; }
        #mco-app-root *, #mco-app-root *::before, #mco-app-root *::after { box-sizing: border-box; }
        /* (Styles truncated for brevity, but would act as fallback) */
        </style>';
    }
}

// --- PROCEDURAL COVER LOGIC ---
if (!function_exists('mco_get_hash_of_string')) {
    function mco_get_hash_of_string($str) {
        $hash = 0;
        $len = strlen($str);
        for ($i = 0; $i < $len; $i++) {
            $hash = ord($str[$i]) + (($hash << 5) - $hash);
        }
        return $hash;
    }
}

if (!function_exists('mco_render_annapoorna_procedural_cover_php')) {
    function mco_render_annapoorna_procedural_cover_php($item_data, $type = 'book') {
        $title = html_entity_decode($item_data['title'] ?? '', ENT_QUOTES, 'UTF-8');
        $hash = mco_get_hash_of_string($title);
        $styleIndex = abs($hash) % 2;
        $colorIndex = floor(abs($hash) / 2) % 5;
        
        $superTitle = ($type === 'program') ? 'Certification Program' : 'Study Material';
        $subTitle = ($type === 'program') ? 'Exam Prep' : 'Official Guide';

        // SVG Pattern for Style A (circles)
        $svgPattern = '<svg width="100%" height="100%" style="position:absolute;inset:0;opacity:0.1;"><defs><pattern id="p-' . $hash . '" patternUnits="userSpaceOnUse" width="20" height="20"><circle cx="10" cy="10" r="1" fill="white"/></pattern></defs><rect width="100%" height="100%" fill="url(#p-' . $hash . ')"/></svg>';

        $colorsA = [
            ['bg' => '#4338ca', 'pattern' => '#3730a3', 'text' => '#ffffff'], // Indigo
            ['bg' => '#0f766e', 'pattern' => '#115e59', 'text' => '#ffffff'], // Teal
            ['bg' => '#334155', 'pattern' => '#1e293b', 'text' => '#ffffff'], // Slate
            ['bg' => '#1e40af', 'pattern' => '#1e3a8a', 'text' => '#ffffff'], // Blue
            ['bg' => '#374151', 'pattern' => '#1f2937', 'text' => '#ffffff'], // Gray
        ];
        
        $colorsB = [
            ['bg' => '#dbeafe', 'shape' => '#93c5fd', 'text' => '#1e3a8a'], // Blue
            ['bg' => '#d1fae5', 'shape' => '#6ee7b7', 'text' => '#064e3b'], // Emerald
            ['bg' => '#ffe4e6', 'shape' => '#fda4af', 'text' => '#881337'], // Rose
            ['bg' => '#ede9fe', 'shape' => '#c4b5fd', 'text' => '#4c1d95'], // Violet
            ['bg' => '#f1f5f9', 'shape' => '#cbd5e1', 'text' => '#0f172a'], // Slate
        ];

        if ($styleIndex === 0) {
            $c = $colorsA[$colorIndex];
            return '<div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 1.5rem; box-sizing: border-box; background-color: ' . esc_attr($c['bg']) . '; color: ' . esc_attr($c['text']) . '; overflow: hidden;">' .
                    '<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; clip-path: polygon(0 0, 100% 0, 0 100%); opacity: 0.2; background-color: ' . esc_attr($c['pattern']) . ';">' . $svgPattern . '</div>' .
                    '<div style="position: relative; z-index: 10;">' .
                    '<span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.8; display: block; margin-bottom: 0.5rem; color: inherit;">' . esc_html($superTitle) . '</span>' .
                    '<h4 style="font-weight: 800; font-size: 1.25rem; line-height: 1.2; margin: 0; color: inherit;">' . esc_html($title) . '</h4>' .
                    '</div></div>';
        } else {
            $c = $colorsB[$colorIndex];
            return '<div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; text-align: left; padding: 1.5rem; box-sizing: border-box; background-color: ' . esc_attr($c['bg']) . '; color: ' . esc_attr($c['text']) . '; overflow: hidden;">' .
                    '<div style="position: absolute; right: -20%; top: -20%; width: 70%; height: 70%; border-radius: 50%; opacity: 0.5; mix-blend-mode: multiply; background-color: ' . esc_attr($c['shape']) . ';"></div>' .
                    '<div style="position: relative; z-index: 10;">' .
                    '<h4 style="font-weight: 800; font-size: 1.5rem; line-height: 1.1; margin: 0 0 0.5rem 0; color: inherit;">' . esc_html($title) . '</h4>' .
                    '<span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.8; color: inherit;">' . esc_html($subTitle) . '</span>' .
                    '</div></div>';
        }
    }
}

if (!function_exists('mco_render_mco_procedural_cover_php')) {
   function mco_render_mco_procedural_cover_php($item_data, $type = 'book') {
        $title = html_entity_decode($item_data['title'] ?? '', ENT_QUOTES, 'UTF-8');
        $hash = mco_get_hash_of_string($title);
        $styleIndex = abs($hash) % 2;
        $colorIndex = floor(abs($hash) / 2) % 4;

        $superTitle = ($type === 'program') ? 'Certification Program' : 'Reference Material';
        $subTitle = ($type === 'program') ? 'Exam Prep' : 'Official Guide'; // Used only in style B

        $colorsA = [
            ['bg' => '#334155', 'text' => '#f1f5f9', 'bgWord' => '#475569'], // Gray
            ['bg' => '#0891b2', 'text' => '#cffafe', 'bgWord' => '#0e7490'], // Cyan
            ['bg' => '#115e59', 'text' => '#ccfbf1', 'bgWord' => '#065f46'], // Emerald
            ['bg' => '#0369a1', 'text' => '#e0f2fe', 'bgWord' => '#075985'], // Sky
        ];
        $colorsB = [
            ['bg' => '#1e293b', 'text' => '#ffffff', 'accent' => '#38bdf8'], // Slate with Sky accent
            ['bg' => '#44403c', 'text' => '#ffffff', 'accent' => '#facc15'], // Stone with Yellow accent
            ['bg' => '#0c4a6e', 'text' => '#ffffff', 'accent' => '#fb7185'], // Blue with Rose accent
            ['bg' => '#065f46', 'text' => '#ffffff', 'accent' => '#a3e635'], // Emerald with Lime accent
        ];

        if ($styleIndex === 0) {
            $c = $colorsA[$colorIndex];
            $titleWords = explode(' ', $title);
            // Fix: Explicitly parenthesize the nested ternary to resolve PHP syntax error
            $bgWord = (count($titleWords) > 1 ? end($titleWords) : ($titleWords[0] ?? '')) ?: 'MCO';
            $bgWord = strtoupper(substr($bgWord, 0, min(strlen($bgWord), 4))); // Take up to 4 chars
            
            return '<div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: flex-start; text-align: left; padding: 1.5rem; box-sizing: border-box; background-color: ' . esc_attr($c['bg']) . '; color: ' . esc_attr($c['text']) . '; overflow: hidden;">' .
                    '<div style="position: absolute; bottom: -0.5rem; right: -0.5rem; font-size: 5rem; font-weight: 900; line-height: 1; z-index: 0; opacity: 0.15; user-select: none; color: ' . esc_attr($c['bgWord']) . ';">' . esc_html($bgWord) . '</div>' .
                    '<div style="position: relative; z-index: 10;">' .
                    '<span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.8; display: block; margin-bottom: 0.5rem; color: inherit;">' . esc_html($superTitle) . '</span>' .
                    '<h4 style="font-weight: 800; font-size: 1.5rem; line-height: 1.2; margin: 0; color: inherit; text-shadow: 0 1px 3px rgba(0,0,0,0.1);">' . esc_html($title) . '</h4>' .
                    '</div></div>';
        } else {
            $c = $colorsB[$colorIndex];
            return '<div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 1.5rem; box-sizing: border-box; background-color: ' . esc_attr($c['bg']) . '; color: ' . esc_attr($c['text']) . '; overflow: hidden;">' .
                    '<div style="position: absolute; top: 1.5rem; left: 0; width: 6px; height: 25%; background-color: ' . esc_attr($c['accent']) . ';"></div>' .
                    '<div>' .
                    '<span style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; display: block; color: inherit;">' . esc_html($superTitle) . '</span>' .
                    '<h4 style="font-weight: 800; font-size: 1.4rem; line-height: 1.2; margin: 0.5rem 0 0 0; color: inherit;">' . esc_html($title) . '</h4>' .
                    '</div>' .
                    '<div style="align-self: flex-end; font-size: 2.5rem; font-weight: 900; opacity: 0.1; user-select: none; color: inherit;">MCO</div>' .
                    '</div>';
        }
   }
}

if (!function_exists('mco_render_procedural_cover')) {
    function mco_render_procedural_cover($item_data, $type = 'book') {
        // Use the activeOrg to determine which style to render.
        // If mco_get_app_config_data is not available (e.g. plugin not fully loaded), default to Annapoorna.
        $config_data = function_exists('mco_get_app_config_data') ? mco_get_app_config_data() : [];
        $active_org_id = $config_data['id'] ?? 'org-annapoorna'; // Default to Annapoorna if not set

        if ($active_org_id === 'org-medical-coding-online') {
            return mco_render_mco_procedural_cover_php($item_data, $type);
        }
        return mco_render_annapoorna_procedural_cover_php($item_data, $type);
    }
}


// --- GEO-CODING HELPER ---
if (!function_exists('mco_get_geo_primary_link_info')) {
    function mco_get_geo_primary_link_info($links) {
        if (empty($links) || !is_array($links)) return null;
        
        $links = array_filter(array_map('trim', $links)); // Filter out empty or whitespace-only links
        if (empty($links)) return null;

        $preferredKey = 'com';
        $preferredDomainName = 'Amazon.com';
        
        // Attempt to get user's timezone from browser (not reliable in PHP without JS,
        // but this is how it's done in JS. For PHP, we might default or try IP-based geo-lookup if available)
        // For simplicity in PHP context, we'll mimic the logic with common assumptions
        $timeZone = date_default_timezone_get(); // This gets server's timezone

        $gccTimezones = [ 'Asia/Dubai', 'Asia/Riyadh', 'Asia/Qatar', 'Asia/Bahrain', 'Asia/Kuwait', 'Asia/Muscat' ];
        if (strpos($timeZone, 'Asia/Kolkata') !== false || strpos($timeZone, 'Asia/Calcutta') !== false) {
            $preferredKey = 'in';
            $preferredDomainName = 'Amazon.in';
        } else if (in_array($timeZone, $gccTimezones)) {
            $preferredKey = 'ae';
            $preferredDomainName = 'Amazon.ae';
        }

        // Try preferred geo link first
        if (isset($links[$preferredKey]) && !empty($links[$preferredKey])) {
            return [ 'key' => $preferredKey, 'url' => $links[$preferredKey], 'domainName' => $preferredDomainName ];
        }

        // Fallback in a defined priority order
        $fallbackPriority = ['com', 'in', 'ae'];
        foreach ($fallbackPriority as $key) {
            if ($key === $preferredKey) continue; // Already tried
            if (isset($links[$key]) && !empty($links[$key])) {
                $domainMap = ['com' => 'Amazon.com', 'in' => 'Amazon.in', 'ae' => 'Amazon.ae'];
                return [ 'key' => $key, 'url' => $links[$key], 'domainName' => $domainMap[$key] ];
            }
        }
        return null; // No valid links found
    }
}

// --- LOGIN SHORTCODE ---
if (!function_exists('mco_exam_login_shortcode')) {
    function mco_exam_login_shortcode() {
        if (is_user_logged_in() && isset($_POST['mco_update_name_nonce']) && wp_verify_nonce($_POST['mco_update_name_nonce'], 'mco_update_name_action')) {
            $full_name = sanitize_text_field($_POST['full_name']);
            if (!empty($full_name) && strpos(trim($full_name), ' ') !== false) {
                $user_id = get_current_user_id();
                wp_update_user(['ID' => $user_id, 'display_name' => $full_name]);
                $name_parts = explode(' ', $full_name, 2);
                update_user_meta($user_id, 'first_name', $name_parts[0]);
                if (isset($name_parts[1])) update_user_meta($user_id, 'last_name', $name_parts[1]);
                return mco_redirect_to_app_with_token();
            } else {
                return mco_render_name_update_form('Please enter your full first and last name.');
            }
        }

        if (is_user_logged_in()) {
            $user = wp_get_current_user();
            if (strpos(trim($user->display_name), ' ') === false) { // No space means it's likely not a full name
                return mco_render_name_update_form();
            }
            return mco_redirect_to_app_with_token();
        }

        $login_url = wp_login_url(get_permalink());
        if (!headers_sent()) { wp_redirect($login_url); exit; }
        mco_load_shortcode_css();
        return '<script>window.location.href="' . esc_url($login_url) . '";</script><div id="mco-app-root"><div class="mco-form-container" style="text-align:center;"><p>Redirecting to login...</p><a href="' . esc_url($login_url) . '" class="mco-button">Click here if not redirected</a></div></div>';
    }
}

// --- EXAM SHOWCASE SHORTCODE (List View) ---
if (!function_exists('mco_exam_showcase_shortcode')) {
    function mco_exam_showcase_shortcode($atts) {
        $atts = shortcode_atts(['id' => ''], $atts, 'exam_program');
        $program_id_str = sanitize_text_field($atts['id']);
        
        $query_args = ['post_type' => 'mco_exam_program', 'posts_per_page' => -1, 'post_status' => 'publish', 'orderby' => 'title', 'order' => 'ASC'];
        if (!empty($program_id_str)) {
            $post_id_from_app_id = (int) str_replace('prod-', '', $program_id_str);
            if ($post_id_from_app_id > 0) $query_args['p'] = $post_id_from_app_id;
            else { $query_args['name'] = $program_id_str; $query_args['posts_per_page'] = 1; }
        }
        
        $programs = get_posts($query_args);
        if (empty($programs)) return '<p>No exam programs found.</p>';
        
        // Ensure mco_get_app_config_data and mco_get_exam_app_url are defined
        if (!function_exists('mco_get_app_config_data') || !function_exists('mco_get_exam_app_url')) {
            return '<p>Application is not configured correctly. Missing core functions.</p>';
        }

        $config_data = mco_get_app_config_data();
        $app_url = mco_get_exam_app_url();
        if (!$config_data || !$app_url) return '<p>Application is not configured correctly.</p>';

        ob_start();
        mco_load_shortcode_css();
        
        $subscriptions_enabled = get_option('mco_subscriptions_enabled', '1') === '1';
        $bundles_enabled = get_option('mco_bundles_enabled', '1') === '1';
        $is_subscribed = (is_user_logged_in() && class_exists('WC_Subscriptions') && function_exists('wcs_user_has_subscription') && wcs_user_has_subscription(get_current_user_id(), '', 'active'));
        
        echo '<div class="mco-showcase-layout">';
        echo '<div class="mco-showcase-main">';
        
        if (!$is_subscribed && empty($program_id_str) && $subscriptions_enabled) {
            $monthly_sub = $config_data['examPrices']['sub-monthly'] ?? null;
            $yearly_sub = $config_data['examPrices']['sub-yearly'] ?? null;
            if (($monthly_sub && isset($monthly_sub['productId'])) || ($yearly_sub && isset($yearly_sub['productId']))) {
                echo '<div class="mco-subscription-grid">';
                if ($monthly_sub && isset($monthly_sub['productId'])) {
                    $monthly_url = get_site_url() . '/cart/?add-to-cart=' . $monthly_sub['productId'];
                    echo '<div class="mco-card mco-gradient--sub-monthly"><h3 class="mco-sub-card__title">Monthly Subscription</h3><p class="mco-sub-card__description">Perfect for focused, short-term preparation.</p><div class="mco-sub-card__price">';
                    if (isset($monthly_sub['regularPrice']) && $monthly_sub['regularPrice'] > $monthly_sub['price']) echo '<span style="font-size: 1.25rem; text-decoration: line-through; opacity: 0.7;">$' . number_format_i18n($monthly_sub['regularPrice'], 2) . '</span> ';
                    echo '<span class="mco-sub-card__price-value">$' . number_format_i18n($monthly_sub['price'], 2) . '</span><span class="mco-sub-card__price-unit">/month</span></div><ul class="mco-sub-card__features"><li>' . mco_get_svg_icon('check') . '<span>Unlimited Access to ALL Practice Exams</span></li><li>' . mco_get_svg_icon('check') . '<span>Unlimited AI-Powered Feedback & Study Guides</span></li><li>' . mco_get_svg_icon('check') . '<span>Cancel Anytime</span></li></ul><div class="mco-card__footer"><a href="' . esc_url($monthly_url) . '" class="mco-card__button mco-card__button--primary">Subscribe Now</a></div></div>';
                }
                if ($yearly_sub && isset($yearly_sub['productId'])) {
                    $yearly_url = get_site_url() . '/cart/?add-to-cart=' . $yearly_sub['productId'];
                    echo '<div class="mco-card mco-gradient--sub-yearly mco-card--best-value"><div class="mco-best-value-tag">' . mco_get_svg_icon('star') . ' Best Value</div><h3 class="mco-sub-card__title">Yearly Subscription</h3><p class="mco-sub-card__description">For continuous learning and preparing for multiple certifications.</p><div class="mco-sub-card__price">';
                    if (isset($yearly_sub['regularPrice']) && $yearly_sub['regularPrice'] > $yearly_sub['price']) echo '<span style="font-size: 1.25rem; text-decoration: line-through; opacity: 0.7;">$' . number_format_i18n($yearly_sub['regularPrice'], 2) . '</span> ';
                    echo '<span class="mco-sub-card__price-value">$' . number_format_i18n($yearly_sub['price'], 2) . '</span><span class="mco-sub-card__price-unit">/year</span></div><p style="text-align:center; font-size: 0.875rem; color: #fcd34d; font-weight: 600;">Saves over 35%!</p><ul class="mco-sub-card__features"><li>' . mco_get_svg_icon('check') . '<span>All Monthly features</span></li><li>' . mco_get_svg_icon('check') . '<span>Access All Exam Programs</span></li><li>' . mco_get_svg_icon('check') . '<span>Billed Annually</span></li></ul><div class="mco-card__footer"><a href="' . esc_url($yearly_url) . '" class="mco-card__button mco-card__button--primary">Subscribe & Save</a></div></div>';
                }
                echo '</div>';
            }
        }

        echo '<div class="mco-showcase-grid">';
        foreach ($programs as $program_post) {
            $app_program_id = 'prod-' . $program_post->ID;
            $program_category = current(array_filter($config_data['examProductCategories'], function($c) use ($app_program_id) { return $c['id'] === $app_program_id; }));
            if (!$program_category) continue;
            
            $practice_exam = current(array_filter($config_data['exams'], function($e) use ($program_category) { return $e['id'] === $program_category['practiceExamId']; }));
            $cert_exam = current(array_filter($config_data['exams'], function($e) use ($program_category) { return $e['id'] === $program_category['certificationExamId']; }));
            
            $program_link_url = rtrim($app_url, '/') . '/program/' . $app_program_id;

            echo '<div class="mco-program-group" id="' . esc_attr($app_program_id) . '"><a href="' . esc_url($program_link_url) . '"><h2 class="mco-program-group__title">' . esc_html(html_entity_decode($program_category['name'], ENT_QUOTES, 'UTF-8')) . '</h2></a><div class="mco-program-group__description">' . wp_kses_post(html_entity_decode($program_category['description'], ENT_QUOTES, 'UTF-8')) . '</div><div class="mco-program-group__cards">';

            if ($practice_exam) {
                echo '<div class="mco-card mco-gradient--practice-1"><div class="mco-card__header"><span>' . mco_get_svg_icon('practice') . '</span> Practice Exam</div><div class="mco-card__body"><h3 class="mco-card__subtitle">' . esc_html(html_entity_decode($practice_exam['name'], ENT_QUOTES, 'UTF-8')) . '</h3><div class="mco-card__stats"><span>' . esc_html($practice_exam['numberOfQuestions']) . ' Qs</span><span>' . esc_html($practice_exam['durationMinutes']) . ' Mins</span><span>' . esc_html($practice_exam['passScore']) . '% Pass</span></div></div><div class="mco-card__footer"><a href="' . esc_url(mco_get_exam_app_url() . '/test/' . $practice_exam['id']) . '" class="mco-card__button mco-card__button--primary">Start Practice</a></div></div>';
            }

            if ($cert_exam) {
                $product_id = wc_get_product_id_by_sku($cert_exam['productSku']);
                $is_purchased = false;
                if (is_user_logged_in()) {
                    $user_id = get_current_user_id();
                    $is_purchased = $is_subscribed || ($product_id ? wc_customer_bought_product('', $user_id, $product_id) : false);
                }
                $button_text = $is_purchased ? 'Start Exam' : 'Add to Cart';
                $button_icon = $is_purchased ? mco_get_svg_icon('practice') : mco_get_svg_icon('cart');
                $button_url = $is_purchased ? mco_get_exam_app_url() . '/test/' . $cert_exam['id'] : ($product_id ? get_site_url() . '/cart/?add-to-cart=' . $product_id : '#');
                $button_class = $is_purchased ? 'mco-card__button--primary' : 'mco-card__button--purchase';

                echo '<div class="mco-card mco-gradient--cert-1"><div class="mco-card__header"><span>' . mco_get_svg_icon('cert') . '</span> Certification Exam</div><div class="mco-card__body"><h3 class="mco-card__subtitle">' . esc_html(html_entity_decode($cert_exam['name'], ENT_QUOTES, 'UTF-8')) . '</h3>';
                if (!$is_purchased && $cert_exam['price'] > 0) {
                    echo '<div style="text-align: center; margin-bottom: 1rem;">';
                    if (isset($cert_exam['regularPrice']) && $cert_exam['regularPrice'] > $cert_exam['price']) echo '<span style="font-size: 1.25rem; text-decoration: line-through; opacity: 0.7;">$' . number_format_i18n($cert_exam['regularPrice'], 2) . '</span>';
                    echo '<span style="font-size: 2.5rem; font-weight: 800; margin-left: 0.5rem;">$' . number_format_i18n($cert_exam['price'], 2) . '</span></div>';
                }
                echo '<div class="mco-card__stats"><span>' . esc_html($cert_exam['numberOfQuestions']) . ' Qs</span><span>' . esc_html($cert_exam['durationMinutes']) . ' Mins</span><span>' . esc_html($cert_exam['passScore']) . '% Pass</span></div></div><div class="mco-card__footer"><a href="' . esc_url($button_url) . '" class="mco-card__button ' . $button_class . '">' . $button_icon . ' ' . $button_text . '</a></div></div>';

                if ($bundles_enabled) {
                    $subscription_bundle_sku = $cert_exam['productSku'] . '-1mo-addon';
                    $practice_bundle_sku = $cert_exam['productSku'] . '-1';
                    
                    $bundle_data = null;
                    $bundle_type = null;

                    // Check subscription bundle first (higher priority)
                    if (isset($config_data['examPrices'][$subscription_bundle_sku]) && ($config_data['examPrices'][$subscription_bundle_sku]['isBundle'] ?? false)) {
                        $bundle_data = $config_data['examPrices'][$subscription_bundle_sku];
                        $bundle_type = 'subscription';
                    } elseif (isset($config_data['examPrices'][$practice_bundle_sku]) && ($config_data['examPrices'][$practice_bundle_sku]['isBundle'] ?? false)) {
                        $bundle_data = $config_data['examPrices'][$practice_bundle_sku];
                        $bundle_type = 'practice';
                    }
                    
                    if ($bundle_data) {
                        $bundle_url = isset($bundle_data['productId']) ? get_site_url() . '/cart/?add-to-cart=' . $bundle_data['productId'] : '#';
                        $gradient_class = $bundle_type === 'subscription' ? 'mco-gradient--bundle-sub' : 'mco-gradient--bundle-practice';
                        $subtitle_text = $bundle_type === 'subscription' ? 'Exam + Subscription' : 'Exam Bundle';
                        $desc_text = $bundle_type === 'subscription' ? 'Get This Exam PLUS 1-Month Full Access' : 'Get This Exam PLUS 1-Month Practice Access';
                        
                        echo '<div class="mco-card ' . $gradient_class . '"><div class="mco-card__header"><span>' . mco_get_svg_icon('bundle') . '</span> ' . esc_html($subtitle_text) . '</div><div class="mco-card__body"><h3 class="mco-card__subtitle">' . esc_html($desc_text) . '</h3>';
                        if (isset($bundle_data['price'])) {
                            echo '<div style="text-align: center; margin-bottom: 1rem;">';
                            if (isset($bundle_data['regularPrice']) && $bundle_data['regularPrice'] > $bundle_data['price']) echo '<span style="font-size: 1.25rem; text-decoration: line-through; opacity: 0.7;">$' . number_format_i18n($bundle_data['regularPrice'], 2) . '</span>';
                            echo '<span style="font-size: 2.5rem; font-weight: 800; margin-left: 0.5rem;">$' . number_format_i18n($bundle_data['price'], 2) . '</span></div>';
                        }
                        echo '</div><div class="mco-card__footer"><a href="' . esc_url($bundle_url) . '" class="mco-card__button mco-card__button--purchase">' . mco_get_svg_icon('cart') . ' Purchase Bundle</a></div></div>';
                    }
                }
            }
            echo '</div></div>';
        }
        echo '</div>'; // end showcase-grid
        echo '</div>'; // end showcase-main
        echo '<div class="mco-study-hall-sidebar">';
        echo mco_render_study_hall_sidebar();
        echo '</div>'; // end sidebar
        echo '</div>'; // end layout

        return ob_get_clean();
    }
}

// --- PROGRAM GRID SHORTCODE (Category Page Style) ---
if (!function_exists('mco_program_grid_shortcode')) {
    function mco_program_grid_shortcode() {
        // Ensure mco_get_app_config_data is defined
        if (!function_exists('mco_get_app_config_data')) {
            return '<p>Application is not configured correctly. Missing core functions.</p>';
        }

        $config_data = mco_get_app_config_data();
        if (empty($config_data['examProductCategories'])) return '<p>No exam programs found.</p>';
        
        $programs = get_posts(['post_type' => 'mco_exam_program', 'posts_per_page' => -1, 'post_status' => 'publish', 'orderby' => 'title', 'order' => 'ASC']);
        
        ob_start();
        mco_load_shortcode_css();
        $app_url = mco_get_exam_app_url();
        ?>
        <div id="mco-app-root">
            <div class="mco-wrapper">
                <div class="mco-book-grid">
                    <?php foreach ($programs as $program): 
                        echo mco_render_program_card($program, $app_url);
                    endforeach; ?>
                </div>
            </div>
        </div>
        <?php
        return ob_get_clean();
    }
}

// --- HELPER: RENDER SINGLE PROGRAM CARD ---
if (!function_exists('mco_render_program_card')) {
    function mco_render_program_card($program, $app_url) {
        // Ensure mco_render_procedural_cover and mco_get_svg_icon are defined
        if (!function_exists('mco_render_procedural_cover') || !function_exists('mco_get_svg_icon')) {
            return '<p>Application is not configured correctly. Missing core functions.</p>';
        }

        $app_program_id = 'prod-' . $program->ID;
        $thumbnail = get_the_post_thumbnail_url($program->ID, 'medium_large');
        $program_url = rtrim($app_url, '/') . '/program/' . $app_program_id;
        
        if ($thumbnail) {
            $coverHtml = '<img src="' . esc_url($thumbnail) . '" style="width:100%;height:100%;object-fit:cover;">';
        } else {
            // Use activeOrg ID to determine procedural cover style
            $config_data = function_exists('mco_get_app_config_data') ? mco_get_app_config_data() : [];
            $active_org_id = $config_data['id'] ?? 'org-annapoorna';
            
            $item_data = ['title' => $program->post_title];
            $coverHtml = ($active_org_id === 'org-medical-coding-online') 
                ? mco_render_mco_procedural_cover_php($item_data, 'program') 
                : mco_render_annapoorna_procedural_cover_php($item_data, 'program');
        }
        
        $desc = wp_trim_words(html_entity_decode($program->post_content, ENT_QUOTES, 'UTF-8'), 20, '...');
        
        return '
        <div class="mco-book-card">
            <div class="mco-book-cover">' . $coverHtml . '</div>
            <div class="mco-book-card__body">
                <a href="' . esc_url($program_url) . '" style="text-decoration:none;"><h4 class="mco-book-card__title">' . esc_html(html_entity_decode($program->post_title, ENT_QUOTES, 'UTF-8')) . '</h4></a>
                <p class="mco-book-card__desc">' . esc_html($desc) . '</p>
            </div>
            <div class="mco-book-card__footer">
                <div class="mco-store-buttons">
                    <a href="' . esc_url($program_url) . '" class="mco-book-btn mco-book-btn--primary">
                        View Program ' . mco_get_svg_icon('external-link') . '
                    </a>
                </div>
            </div>
        </div>';
    }
}

// --- BOOK SHOWCASE SHORTCODE ---
if (!function_exists('mco_book_showcase_shortcode')) {
    function mco_book_showcase_shortcode() {
        // Ensure mco_get_app_config_data is defined
        if (!function_exists('mco_get_app_config_data')) {
            return '<p>Application is not configured correctly. Missing core functions.</p>';
        }

        $config_data = mco_get_app_config_data();
        if (empty($config_data['suggestedBooks'])) return '<p>No recommended books found.</p>';

        ob_start();
        mco_load_shortcode_css();
        
        // Inject JS array of books for geo-coding
        // Ensure book titles are HTML entity decoded before passing to JS
        $decoded_books = array_map(function($book) {
            $book['title'] = html_entity_decode($book['title'], ENT_QUOTES, 'UTF-8');
            $book['description'] = html_entity_decode($book['description'], ENT_QUOTES, 'UTF-8');
            return $book;
        }, $config_data['suggestedBooks']);
        $books_json = json_encode($decoded_books);
        $unique_id = 'mco-books-grid-' . uniqid();
        
        // Get activeOrg ID for procedural cover logic
        $active_org_id = $config_data['id'] ?? 'org-annapoorna';
        $is_mco_tenant_js = ($active_org_id === 'org-medical-coding-online') ? 'true' : 'false';

        ?>
        <div id="mco-app-root">
            <div class="mco-wrapper">
                <div id="<?php echo $unique_id; ?>" class="mco-book-grid">
                    <p class="mco-loading-text" style="grid-column: 1/-1; text-align: center;">Loading books...</p>
                </div>
            </div>
        </div>
        
        <script>
        (function() {
            var books = <?php echo $books_json; ?>;
            var container = document.getElementById('<?php echo $unique_id; ?>');
            var isMcoTenant = <?php echo $is_mco_tenant_js; ?>;

            function getGeoStore() {
                try {
                    var tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    var gcc = ['Asia/Dubai', 'Asia/Riyadh', 'Asia/Qatar', 'Asia/Bahrain', 'Asia/Kuwait', 'Asia/Muscat'];
                    if (tz.includes('Asia/Kolkata') || tz.includes('Asia/Calcutta')) return 'in';
                    if (gcc.some(t => tz === t)) return 'ae';
                } catch(e) { console.error("Error determining timezone for geo-affiliate links", e); }
                return 'com'; // Default fallback
            }
            
            function getHash(str) {
                var hash = 0;
                if (!str || str.length === 0) return hash;
                for (var i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                return hash;
            }

            var stores = {
                'com': 'Amazon.com',
                'in': 'Amazon.in',
                'ae': 'Amazon.ae'
            };
            
            // Annapoorna Procedural Cover Styles (mirrors React component)
            const annapoornaColorsA = [
                { bg: '#4338ca', pattern: '#3730a3', text: '#ffffff' }, // Indigo
                { bg: '#0f766e', pattern: '#115e59', text: '#ffffff' }, // Teal
                { bg: '#334155', pattern: '#1e293b', text: '#ffffff' }, // Slate
                { bg: '#1e40af', pattern: '#1e3a8a', text: '#ffffff' }, // Blue
                { bg: '#374151', pattern: '#1f2937', text: '#ffffff' }, // Gray
            ];
            const annapoornaColorsB = [
                { bg: '#dbeafe', shape: '#93c5fd', text: '#1e3a8a' }, // Blue
                { bg: '#d1fae5', shape: '#6ee7b7', text: '#064e3b' }, // Emerald
                { bg: '#ffe4e6', shape: '#fda4af', text: '#881337' }, // Rose
                { bg: '#ede9fe', shape: '#c4b5fd', text: '#4c1d95' }, // Violet
                { bg: '#f1f5f9', shape: '#cbd5e1', text: '#0f172a' }, // Slate
            ];

            // MCO Procedural Cover Styles (mirrors React component)
            const mcoColorsA = [
                { bg: '#334155', text: '#f1f5f9', bgWord: '#475569' }, // Gray
                { bg: '#0891b2', text: '#cffafe', bgWord: '#0e7490' }, // Cyan
                { bg: '#115e59', text: '#ccfbf1', bgWord: '#065f46' }, // Emerald
                { bg: '#0369a1', text: '#e0f2fe', bgWord: '#075985' }, // Sky
            ];
            const mcoColorsB = [
                { bg: '#1e293b', text: '#ffffff', accent: '#38bdf8' }, // Slate with Sky accent
                { bg: '#44403c', text: '#ffffff', accent: '#facc15' }, // Stone with Yellow accent
                { bg: '#0c4a6e', text: '#ffffff', accent: '#fb7185' }, // Blue with Rose accent
                { bg: '#065f46', text: '#ffffff', accent: '#a3e635' }, // Emerald with Lime accent
            ];

            function renderProceduralCover(bookTitle, isMco) {
                var hash = getHash(bookTitle);
                var styleIndex = Math.abs(hash) % 2;
                var colorIndex;
                var svgPattern = '<svg width="100%" height="100%" style="position:absolute;inset:0;opacity:0.1;"><defs><pattern id="p-' + hash + '" patternUnits="userSpaceOnUse" width="20" height="20"><circle cx="10" cy="10" r="1" fill="white"/></pattern></defs><rect width="100%" height="100%" fill="url(#p-' + hash + ')"/></svg>';
                
                if (isMco) {
                    colorIndex = Math.floor(Math.abs(hash) / 2) % mcoColorsA.length; // Use MCO specific color count
                    if (styleIndex === 0) { // MCO Style A
                        var c = mcoColorsA[colorIndex];
                        var titleWords = bookTitle.split(' ');
                        var bgWord = (titleWords.length > 1 ? titleWords[titleWords.length - 1] : (titleWords[0] || '')).toUpperCase();
                        bgWord = bgWord.substring(0, Math.min(bgWord.length, 4));
                        return '<div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: flex-start; text-align: left; padding: 1.5rem; box-sizing: border-box; background-color: ' + c.bg + '; color: ' + c.text + '; overflow: hidden;">' +
                                '<div style="position: absolute; bottom: -0.5rem; right: -0.5rem; font-size: 5rem; font-weight: 900; line-height: 1; z-index: 0; opacity: 0.15; user-select: none; color: ' + c.bgWord + ';">' + bgWord + '</div>' +
                                '<div style="position: relative; z-index: 10;">' +
                                '<span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.8; display: block; margin-bottom: 0.5rem; color: inherit;">Reference Material</span>' +
                                '<h4 style="font-weight: 800; font-size: 1.5rem; line-height: 1.2; margin: 0; color: inherit; text-shadow: 0 1px 3px rgba(0,0,0,0.1);">' + bookTitle + '</h4>' +
                                '</div></div>';
                    } else { // MCO Style B
                        var c = mcoColorsB[colorIndex];
                        return '<div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 1.5rem; box-sizing: border-box; background-color: ' + c.bg + '; color: ' + c.text + '; overflow: hidden;">' +
                                '<div style="position: absolute; top: 1.5rem; left: 0; width: 6px; height: 25%; background-color: ' + c.accent + ';"></div>' +
                                '<div>' +
                                '<span style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; display: block; color: inherit;">Reference Material</span>' +
                                '<h4 style="font-weight: 800; font-size: 1.4rem; line-height: 1.2; margin: 0.5rem 0 0 0; color: inherit;">' + bookTitle + '</h4>' +
                                '</div>' +
                                '<div style="align-self: flex-end; font-size: 2.5rem; font-weight: 900; opacity: 0.1; user-select: none; color: inherit;">MCO</div>' +
                                '</div>';
                    }
                } else { // Annapoorna (Default) Style
                    colorIndex = Math.floor(Math.abs(hash) / 2) % annapoornaColorsA.length;
                    if (styleIndex === 0) { // Annapoorna Style A
                        var c = annapoornaColorsA[colorIndex];
                        return '<div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 1.5rem; box-sizing: border-box; background-color: ' + c.bg + '; color: ' + c.text + '; overflow: hidden;">' +
                                '<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; clip-path: polygon(0 0, 100% 0, 0 100%); opacity: 0.2; background-color: ' + c.pattern + ';">' + svgPattern + '</div>' +
                                '<div style="position: relative; z-index: 10;">' +
                                '<span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.8; display: block; margin-bottom: 0.5rem; color: inherit;">Study Material</span>' +
                                '<h4 style="font-weight: 800; font-size: 1.25rem; line-height: 1.2; margin: 0; color: inherit;">' + bookTitle + '</h4>' +
                                '</div></div>';
                    } else { // Annapoorna Style B
                        var c = annapoornaColorsB[colorIndex];
                        return '<div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; text-align: left; padding: 1.5rem; box-sizing: border-box; background-color: ' + c.bg + '; color: ' + c.text + '; overflow: hidden;">' +
                                '<div style="position: absolute; right: -20%; top: -20%; width: 70%; height: 70%; border-radius: 50%; opacity: 0.5; mix-blend-mode: multiply; background-color: ' + c.shape + ';"></div>' +
                                '<div style="position: relative; z-index: 10;">' +
                                '<h4 style="font-weight: 800; font-size: 1.5rem; line-height: 1.1; margin: 0 0 0.5rem 0; color: inherit;">' + bookTitle + '</h4>' +
                                '<span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.8; color: inherit;">Official Guide</span>' +
                                '</div></div>';
                    }
                }
            }


            function renderBook(book) {
                var geoStore = getGeoStore();
                var links = book.affiliateLinks;
                var buttonsHtml = '';
                
                // Try preferred geo link first
                var primaryLink = null;
                if (links[geoStore] && links[geoStore].trim() !== '') {
                    primaryLink = { url: links[geoStore], domainName: stores[geoStore] };
                } else {
                    // Fallback in priority order
                    const fallbackOrder = ['com', 'in', 'ae'];
                    for (const key of fallbackOrder) {
                        if (links[key] && links[key].trim() !== '') {
                            primaryLink = { url: links[key], domainName: stores[key] };
                            break;
                        }
                    }
                }

                if (primaryLink) {
                    buttonsHtml += '<a href="' + primaryLink.url + '" class="mco-book-btn mco-book-btn--primary" target="_blank">Buy on ' + primaryLink.domainName + '</a>';
                }
                
                if (!buttonsHtml) buttonsHtml = '<span class="mco-book-btn">Coming Soon</span>';
                
                var coverHtml = '';
                if (book.thumbnailUrl) {
                    coverHtml = '<img src="' + book.thumbnailUrl + '" style="width:100%;height:100%;object-fit:cover;" crossorigin="' + (book.thumbnailUrl.startsWith('data:image') ? '' : 'anonymous') + '">';
                } else {
                    coverHtml = renderProceduralCover(book.title, isMcoTenant);
                }

                var titleHtml = '<h4 class="mco-book-card__title">' + book.title + '</h4>';
                if (book.permalink) {
                    titleHtml = '<a href="' + book.permalink + '" style="text-decoration:none;">' + titleHtml + '</a>';
                }
                var desc = book.description.split(' ').slice(0, 20).join(' ') + '...';

                return `
                <div class="mco-book-card">
                    <div class="mco-book-cover">${coverHtml}</div>
                    <div class="mco-book-card__body">
                        ${titleHtml}
                        <p class="mco-book-card__desc">${desc}</p>
                    </div>
                    <div class="mco-book-card__footer">
                        <div class="mco-store-buttons">${buttonsHtml}</div>
                    </div>
                </div>
                `;
            }
            
            if (books && books.length > 0) {
                container.innerHTML = books.map(renderBook).join('');
            } else {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">No books found.</p>';
            }

        })();
        </script>
        <style>
            .mco-book-btn--secondary { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }
            .mco-book-btn--secondary:hover { background: #e2e8f0; color: #1e293b; }
            .mco-loading-text { color: #94a3b8; font-size: 0.9rem; font-style: italic; }
        </style>
        <?php
        
        return ob_get_clean();
    }
}

// --- SINGLE BOOK RENDERER ---
if (!function_exists('mco_render_single_book_content')) {
    function mco_render_single_book_content($book, $content_override = '') {
        if (!$book) return '';
        ob_start();
        mco_load_shortcode_css();
        
        // Ensure mco_render_procedural_cover and mco_get_svg_icon are defined
        if (!function_exists('mco_render_procedural_cover') || !function_exists('mco_get_svg_icon')) {
            return '<p>Application is not configured correctly. Missing core functions.</p>';
        }

        $cover = !empty($book['thumbnailUrl']) ? '<img src="'.esc_url($book['thumbnailUrl']).'" style="width:100%;height:100%;object-fit:cover;" crossorigin="' . (str_starts_with($book['thumbnailUrl'], 'data:image') ? '' : 'anonymous') . '">' : mco_render_procedural_cover($book, 'book');
        
        $links_json = json_encode($book['affiliateLinks']);
        $book_title = esc_html(html_entity_decode($book['title'], ENT_QUOTES, 'UTF-8'));
        $unique_id = 'mco-book-' . uniqid();
        $description = !empty($content_override) ? $content_override : (html_entity_decode($book['description'] ?? '', ENT_QUOTES, 'UTF-8'));

        echo '<div id="mco-app-root"><div class="mco-wrapper"><div class="mco-single-book-card">';
        echo '<div class="mco-single-book-card__cover">'.$cover.'</div>';
        echo '<div class="mco-single-book-card__details">';
        echo '<h1>'.$book_title.'</h1>';
        echo '<div class="mco-single-book-card__description">'.wp_kses_post($description).'</div>';
        echo '<div id="'.$unique_id.'" class="mco-single-book-card__buttons"><span class="mco-loading-text">Loading purchasing options...</span></div>';
        echo '</div></div></div></div>';

        ?>
        <script>
        (function() {
            var links = <?php echo $links_json; ?>;
            var container = document.getElementById('<?php echo $unique_id; ?>');
            
            function getGeoStore() {
                try {
                    var tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    var gcc = ['Asia/Dubai', 'Asia/Riyadh', 'Asia/Qatar', 'Asia/Bahrain', 'Asia/Kuwait', 'Asia/Muscat'];
                    if (tz.includes('Asia/Kolkata') || tz.includes('Asia/Calcutta')) return 'in';
                    if (gcc.some(t => tz === t)) return 'ae';
                } catch(e) { console.error("Error determining timezone for geo-affiliate links", e); }
                return 'com'; // Default fallback
            }

            var stores = {'com': 'Amazon.com', 'in': 'Amazon.in', 'ae': 'Amazon.ae'};
            var preferred = getGeoStore();
            var html = '';

            // Try preferred geo link first
            var primaryLink = null;
            if (links[preferred] && links[preferred].trim() !== '') {
                primaryLink = { url: links[preferred], domainName: stores[preferred] };
            } else {
                // Fallback in priority order
                const fallbackOrder = ['com', 'in', 'ae'];
                for (const key of fallbackOrder) {
                    if (links[key] && links[key].trim() !== '') {
                        primaryLink = { url: links[key], domainName: stores[key] };
                        break;
                    }
                }
            }

            if (primaryLink) {
                html += '<a href="' + primaryLink.url + '" class="mco-book-btn mco-book-btn--primary" target="_blank">Buy on ' + primaryLink.domainName + '</a>';
            }
            
            if (!html) html = '<span class="mco-book-btn">Links Coming Soon</span>';
            container.innerHTML = html;
        })();
        </script>
        <style>.mco-book-btn--secondary { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; } .mco-book-btn--secondary:hover { background: #e2e8f0; color: #1e293b; } .mco-loading-text { color: #94a3b8; font-size: 0.9rem; font-style: italic; }</style>
        <?php
        return ob_get_clean();
    }
}

if (!function_exists('mco_single_book_shortcode')) {
    function mco_single_book_shortcode() {
        global $post;
        // Ensure mco_get_app_config_data is defined
        if (!function_exists('mco_get_app_config_data')) {
            return '<p>Application is not configured correctly. Missing core functions.</p>';
        }

        $config_data = mco_get_app_config_data();
        $book_id_meta = get_post_meta($post->ID, '_mco_book_id', true);
        $book = current(array_filter($config_data['suggestedBooks'] ?? [], function($b) use ($book_id_meta) { return ($b['id'] ?? '') === $book_id_meta; }));

        if (!$book) {
            $book = [
                'id' => $book_id_meta,
                'title' => get_the_title($post),
                'description' => $post->post_content,
                'thumbnailUrl' => get_post_meta($post->ID, '_mco_thumbnail_url', true),
                'affiliateLinks' => [
                    'com' => get_post_meta($post->ID, '_mco_link_com', true),
                    'in' => get_post_meta($post->ID, '_mco_link_in', true),
                    'ae' => get_post_meta($post->ID, '_mco_link_ae', true),
                ]
            ];
        }
        return mco_render_single_book_content($book, $post->post_content);
    }
}

// --- SINGLE PROGRAM RENDERER (PHP) ---
if (!function_exists('mco_render_single_program_content')) {
    function mco_render_single_program_content($program) {
        if (!$program) return '';
        ob_start();
        mco_load_shortcode_css();
        
        // Ensure mco_render_procedural_cover and mco_get_svg_icon are defined
        if (!function_exists('mco_render_procedural_cover') || !function_exists('mco_get_svg_icon')) {
            return '<p>Application is not configured correctly. Missing core functions.</p>';
        }

        // Check for thumbnail, otherwise generate procedural cover
        if (!empty($program['thumbnailUrl'])) {
            $cover = '<img src="'.esc_url($program['thumbnailUrl']).'" style="width:100%;height:100%;object-fit:cover;" crossorigin="' . (str_starts_with($program['thumbnailUrl'], 'data:image') ? '' : 'anonymous') . '">';
        } else {
            // Use activeOrg ID to determine procedural cover style
            $config_data = function_exists('mco_get_app_config_data') ? mco_get_app_config_data() : [];
            $active_org_id = $config_data['id'] ?? 'org-annapoorna';

            $item_data = ['title' => $program['title']];
            $cover = ($active_org_id === 'org-medical-coding-online') 
                ? mco_render_mco_procedural_cover_php($item_data, 'program') 
                : mco_render_annapoorna_procedural_cover_php($item_data, 'program');
        }
        
        $title = esc_html(html_entity_decode($program['title'], ENT_QUOTES, 'UTF-8'));
        $desc = html_entity_decode($program['description'] ?? '', ENT_QUOTES, 'UTF-8');
        $app_link = rtrim(mco_get_exam_app_url(), '/') . '/program/' . ($program['id'] ?? '');

        echo '<div id="mco-app-root"><div class="mco-wrapper"><div class="mco-single-book-card">';
        echo '<div class="mco-single-book-card__cover">'.$cover.'</div>';
        echo '<div class="mco-single-book-card__details">';
        echo '<h1>'.$title.'</h1>';
        echo '<div class="mco-single-book-card__description">'.wp_kses_post($desc).'</div>';
        
        echo '<div class="mco-single-book-card__buttons">
                <a href="' . esc_url($app_link) . '" class="mco-book-btn mco-book-btn--primary">
                    View Program Details ' . mco_get_svg_icon('external-link') . '
                </a>
            </div>';
        
        echo '</div></div></div></div>';
        return ob_get_clean();
    }
}

if (!function_exists('mco_single_program_shortcode')) {
    function mco_single_program_shortcode() {
        global $post;
        
        $program_data = [
            'id' => 'prod-' . $post->ID,
            'title' => get_the_title($post),
            'description' => $post->post_content,
            'thumbnailUrl' => get_the_post_thumbnail_url($post->ID, 'large'),
        ];
        
        return mco_render_single_program_content($program_data);
    }
}

// --- AUTO INJECT TEMPLATE ---
if (!function_exists('mco_auto_inject_template')) {
    add_filter('the_content', 'mco_auto_inject_template');

    function mco_auto_inject_template($content) {
        static $css_loaded = false;

        if (is_singular('mco_recommended_book') && in_the_loop() && is_main_query()) {
            return mco_single_book_shortcode();
        }
        if (is_singular('mco_exam_program') && in_the_loop() && is_main_query()) {
            return mco_single_program_shortcode();
        }
        // Handle Archive Pages: Inject card view for items in the loop
        if (is_post_type_archive('mco_exam_program') && in_the_loop() && is_main_query()) {
            global $post;
            // Ensure mco_render_program_card and mco_get_exam_app_url are defined
            if (!function_exists('mco_render_program_card') || !function_exists('mco_get_exam_app_url')) {
                return '<p>Application is not configured correctly. Missing core functions.</p>';
            }

            $card_html = mco_render_program_card($post, mco_get_exam_app_url());
            
            // Ensure CSS is loaded, but only once per page load to avoid bloat
            // We capture it into a variable to prepend to the first card
            $styles = '';
            if (!$css_loaded) {
                ob_start();
                mco_load_shortcode_css();
                $styles = ob_get_clean();
                $css_loaded = true;
            }
            
            return $styles . $card_html;
        }
        return $content;
    }
}

if (!function_exists('mco_render_study_hall_sidebar')) {
    function mco_render_study_hall_sidebar() {
        // Ensure mco_get_app_config_data is defined
        if (!function_exists('mco_get_app_config_data') || !function_exists('mco_get_geo_primary_link_info')) {
            return '<p>Application is not configured correctly. Missing core functions for sidebar.</p>';
        }

        $config_data = mco_get_app_config_data();
        if (empty($config_data['suggestedBooks'])) return '';

        $all_books = $config_data['suggestedBooks'];
        shuffle($all_books);
        $random_books = array_slice($all_books, 0, 5);

        ob_start();
        ?>
        <style>
        /* Specific Sidebar Styles to Fix Overflow */
        .mco-study-hall-sidebar {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px; /* Increased border-radius for more rounded look */
            padding: 24px; /* Increased padding */
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* More pronounced shadow */
            box-sizing: border-box; /* Ensure proper box model */
        }
        .mco-study-hall-sidebar__title {
            font-size: 1.5rem; /* Larger title */
            font-weight: 700;
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 12px; /* Increased gap */
            color: #1e293b;
            border-bottom: 2px solid #e2e8f0; /* Thicker border */
            padding-bottom: 12px; /* More padding */
        }
        .mco-study-hall-sidebar__title svg {
            color: #0891b2; /* Cyan color for icon */
            width: 28px; /* Larger icon */
            height: 28px;
        }
        .mco-study-hall-sidebar__grid {
            display: flex;
            flex-direction: column;
            gap: 20px; /* Increased gap between cards */
        }
        .mco-book-card-sidebar {
            border: 1px solid #cbd5e1; /* Slightly darker border for contrast */
            border-radius: 10px; /* More rounded cards */
            overflow: hidden;
            display: flex;
            min-height: 120px; /* Slightly taller cards */
            background: #fff;
            transition: all 0.2s ease-in-out; /* Smooth transition for hover effects */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Subtle shadow for individual cards */
            box-sizing: border-box;
        }
        .mco-book-card-sidebar:hover {
            border-color: #0ea5e9; /* Blue border on hover */
            transform: translateY(-3px); /* Lift effect on hover */
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .mco-book-card-sidebar__cover {
            width: 90px; /* Wider cover */
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            border-right: 1px solid #f1f5f9;
        }
        .mco-book-card-sidebar__cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        /* Procedural Cover Tweaks for Sidebar Small Size */
        .mco-book-card-sidebar__cover [class*="mco-proc-cover-"] {
            padding: 8px !important; /* Adjusted padding */
            justify-content: center;
            width: 100% !important;
            height: 100% !important;
        }
        .mco-book-card-sidebar__cover [class*="mco-proc-cover-"] h4 {
            font-size: 10px !important; /* Slightly larger text for readability */
            line-height: 1.2 !important;
            margin: 0 !important;
            display: block !important;
        }
        .mco-book-card-sidebar__cover [class*="mco-proc-cover-"] span {
            display: none !important; /* Hide supertitles to save space */
        }
        .mco-book-card-sidebar__content {
            padding: 15px; /* Increased padding */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Space out title and button */
            flex-grow: 1;
            min-width: 0;
        }
        .mco-book-card-sidebar__title {
            font-size: 15px; /* Larger title font size */
            font-weight: 600;
            line-height: 1.3;
            margin: 0 0 8px 0; /* Adjusted margin */
            color: #1e293b;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-decoration: none; /* Remove underline from default */
        }
        .mco-book-card-sidebar__title:hover {
            color: #0891b2; /* Primary color on hover */
        }
        .mco-book-card-sidebar__button {
            display: inline-flex; /* Use inline-flex for button content alignment */
            align-items: center;
            justify-content: center;
            background: #f59e0b; /* Amber 500 */
            color: #fff;
            font-size: 12px; /* Smaller font size for button */
            font-weight: 700;
            padding: 8px 12px; /* Adjusted padding */
            border-radius: 6px; /* More rounded button */
            text-decoration: none;
            align-self: flex-start;
            transition: background-color 0.2s ease-in-out;
            gap: 6px; /* Gap for icon + text */
        }
        .mco-book-card-sidebar__button:hover {
            background: #d97706; /* Amber 700 on hover */
        }
        .mco-study-hall-sidebar__disclaimer {
            font-size: 0.8rem; /* Slightly larger disclaimer */
            color: #64748b; /* Slate 500 */
            margin-top: 24px; /* More margin */
            text-align: center;
            line-height: 1.5;
        }
        </style>
        
        <div class="mco-study-hall-sidebar">
            <h3 class="mco-study-hall-sidebar__title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                <span>Study Hall</span>
            </h3>
            <div class="mco-study-hall-sidebar__grid">
                <?php foreach ($random_books as $book):
                    $link_data = mco_get_geo_primary_link_info($book['affiliateLinks']);
                    if (!$link_data) continue;

                    $book_cover = '';
                    if (!empty($book['thumbnailUrl'])) {
                        $book_cover = '<img src="' . esc_url($book['thumbnailUrl']) . '" alt="' . esc_attr($book['title']) . '" crossorigin="' . (str_starts_with($book['thumbnailUrl'], 'data:image') ? '' : 'anonymous') . '">';
                    } else {
                        $config_data = function_exists('mco_get_app_config_data') ? mco_get_app_config_data() : [];
                        $active_org_id = $config_data['id'] ?? 'org-annapoorna';
                        
                        $book_cover = ($active_org_id === 'org-medical-coding-online') 
                            ? mco_render_mco_procedural_cover_php($book, 'book') 
                            : mco_render_annapoorna_procedural_cover_php($book, 'book');
                    }
                    
                    $permalink = isset($book['permalink']) ? $book['permalink'] : '';
                ?>
                <div class="mco-book-card-sidebar">
                    <div class="mco-book-card-sidebar__cover"><?php echo $book_cover; ?></div>
                    <div class="mco-book-card-sidebar__content">
                        <?php if ($permalink): ?>
                            <a href="<?php echo esc_url($permalink); ?>" style="text-decoration:none;"><h4 class="mco-book-card-sidebar__title"><?php echo esc_html(html_entity_decode($book['title'], ENT_QUOTES, 'UTF-8')); ?></h4></a>
                        <?php else: ?>
                            <h4 class="mco-book-card-sidebar__title"><?php echo esc_html(html_entity_decode($book['title'], ENT_QUOTES, 'UTF-8')); ?></h4>
                        <?php endif; ?>
                        <a href="<?php echo esc_url($link_data['url']); ?>" target="_blank" rel="noopener noreferrer" class="mco-book-card-sidebar__button">
                            Buy on <?php echo esc_html($link_data['domainName']); ?>
                        </a>
                    </div>
                </div>
                <?php endforeach; ?>
            </div>
            <p class="mco-study-hall-sidebar__disclaimer">
                Using our affiliate links doesn't cost you extra and helps support our platform. Note: Book availability may vary by region. Thank you!
            </p>
        </div>
        <?php
        return ob_get_clean();
    }
}

if (!function_exists('mco_render_name_update_form')) {
    function mco_render_name_update_form($error_msg = '') {
        $redirect_to = isset($_GET['redirect_to']) ? $_GET['redirect_to'] : '';
        ob_start();
        mco_load_shortcode_css();
        ?>
        <div id="mco-app-root">
            <div class="mco-form-container">
                <h2>Complete Your Profile</h2>
                <p>Please enter your full First and Last Name. This will be used for your certificates.</p>
                <?php if ($error_msg): ?>
                    <div class="mco-error"><?php echo esc_html($error_msg); ?></div>
                <?php endif; ?>
                <form method="post" action="">
                    <?php wp_nonce_field('mco_update_name_action', 'mco_update_name_nonce'); ?>
                    <input type="hidden" name="redirect_to" value="<?php echo esc_attr($redirect_to); ?>">
                    <label for="full_name">Full Name</label>
                    <input type="text" name="full_name" id="full_name" required placeholder="e.g. John Doe">
                    <button type="submit" class="mco-button">Save & Continue</button>
                </form>
            </div>
        </div>
        <?php
        return ob_get_clean();
    }
}

if (!function_exists('mco_redirect_to_app_with_token')) {
    function mco_redirect_to_app_with_token() {
        // Ensure mco_generate_exam_jwt and mco_get_exam_app_url are defined (from mco-api.php)
        if (!function_exists('mco_generate_exam_jwt') || !function_exists('mco_get_exam_app_url')) {
            error_log('MCO SHORTCODE REDIRECT ERR: Critical API functions not defined. Check mco-api.php.');
            return '<p>Error: Application is not configured correctly. Missing core functions.</p>';
        }

        $token = mco_generate_exam_jwt(get_current_user_id());
        if (!$token) {
            return '<p>Error: Could not generate authentication token.</p>';
        }
        $app_url = mco_get_exam_app_url();
        if (!$app_url) return '<p>Error: App URL not configured.</p>';
        
        // FIX: Include the dynamic API URL in the redirect so the React app knows where to connect back to.
        $site_url = get_site_url();
        $redirect_url = add_query_arg(['token' => $token, 'api_url' => $site_url], rtrim($app_url, '/') . '/auth');
        
        // JS redirect is safer if headers are sent, but meta refresh is a good fallback
        return '<meta http-equiv="refresh" content="0;url=' . esc_url($redirect_url) . '">' .
            '<script>window.location.href="' . esc_url($redirect_url) . '";</script>' .
            '<div id="mco-app-root"><div class="mco-form-container" style="text-align:center;"><p>Redirecting to exam portal...</p><a href="' . esc_url($redirect_url) . '" class="mco-button">Click here if not redirected</a></div></div>';
    }
}

// --- SHORTCODE REGISTRATION ---
add_shortcode('mco_exam_login', 'mco_exam_login_shortcode');
add_shortcode('mco_exam_showcase', 'mco_exam_showcase_shortcode');
add_shortcode('mco_program_grid', 'mco_program_grid_shortcode'); // New grid shortcode for category pages
add_shortcode('mco_single_program', 'mco_single_program_shortcode'); // New single item shortcode
add_shortcode('mco_book_showcase', 'mco_book_showcase_shortcode');
add_shortcode('mco_single_book', 'mco_single_book_shortcode');