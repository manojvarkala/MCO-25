<?php
if (!defined('ABSPATH')) exit;

// --- ADMIN MENU & PAGE ---

if (!function_exists('mco_add_admin_menu')) {
    function mco_add_admin_menu() {
        // Step 1: Create the top-level menu page. This is the parent for all other items.
        add_menu_page(
            'Exam App Engine',          // Page Title
            'Exam App Engine',          // Menu Title
            'manage_options',           // Capability
            'mco-exam-engine',          // Menu Slug (this will be the slug for the first submenu item)
            'mco_exam_engine_admin_page', // Callback function for the default page
            'dashicons-welcome-learn-more', // Icon
            25                          // Position
        );

        // Step 2: Add the CPTs as submenu items under the new parent.
        add_submenu_page(
            'mco-exam-engine',                  // Parent slug
            'Exam Programs',                    // Page Title
            'Exam Programs',                    // Menu Title
            'manage_options',                   // Capability
            'edit.php?post_type=mco_exam_program' // The link to the CPT list view
        );
        add_submenu_page(
            'mco-exam-engine',                  // Parent slug
            'Recommended Books',                // Page Title
            'Recommended Books',                // Menu Title
            'manage_options',                   // Capability
            'edit.php?post_type=mco_recommended_book' // The link to the CPT list view
        );
        
        // Step 3: Add the custom Settings & Tools page as another submenu.
        // We make its slug the same as the parent to make it the default page when clicking the top-level menu.
        add_submenu_page(
            'mco-exam-engine',              // Parent slug
            'Settings & Tools',             // Page Title
            'Settings & Tools',             // Menu Title
            'manage_options',               // Capability
            'mco-exam-engine',              // Menu Slug (matches parent to become the default)
            'mco_exam_engine_admin_page'    // Callback function
        );
    }
}


if (!function_exists('mco_register_admin_hooks')) {
    function mco_register_admin_hooks() {
        add_action('admin_menu', 'mco_add_admin_menu');
        add_action('admin_enqueue_scripts', 'mco_admin_enqueue_scripts');
        add_action('admin_post_mco_bulk_import_csv', 'mco_handle_csv_upload');
        add_action('admin_post_mco_generate_tenant_blueprint', 'mco_handle_generate_tenant_blueprint');
        add_action('admin_post_mco_generate_full_snapshot', 'mco_handle_generate_full_snapshot');
        add_action('admin_post_mco_clear_config_cache_action', 'mco_handle_clear_config_cache');
        add_action('admin_post_mco_clear_question_caches_action', 'mco_handle_clear_question_caches');
        add_action('admin_init', 'mco_register_certificate_settings'); 
        add_action('admin_init', 'mco_register_main_settings');
        add_action('admin_notices', 'mco_display_admin_notices');
    }
}

if (!function_exists('mco_handle_clear_config_cache')) {
    function mco_handle_clear_config_cache() {
        if (!isset($_POST['_wpnonce']) || !wp_verify_nonce($_POST['_wpnonce'], 'mco_clear_config_cache_nonce')) {
            wp_die('Security check failed.');
        }
        if (!current_user_can('manage_options')) {
            wp_die('You do not have permission to perform this action.');
        }

        delete_transient('mco_app_config_data');
        update_option('mco_config_version', current_time('YmdHis'));
        
        mco_add_admin_notice('success', 'Application configuration cache has been cleared successfully.');
        wp_redirect(admin_url('admin.php?page=mco-exam-engine&tab=tools'));
        exit;
    }
}

if (!function_exists('mco_handle_clear_question_caches')) {
    function mco_handle_clear_question_caches() {
        if (!isset($_POST['_wpnonce']) || !wp_verify_nonce($_POST['_wpnonce'], 'mco_clear_question_caches_nonce')) {
            wp_die('Security check failed.');
        }
        if (!current_user_can('manage_options')) {
            wp_die('You do not have permission to perform this action.');
        }

        global $wpdb;
        $prefix = '_transient_mco_questions_';
        $wpdb->query(
            $wpdb->prepare(
                "DELETE FROM {$wpdb->options} WHERE option_name LIKE %s",
                $wpdb->esc_like($prefix) . '%'
            )
        );
         $wpdb->query(
            $wpdb->prepare(
                "DELETE FROM {$wpdb->options} WHERE option_name LIKE %s",
                $wpdb->esc_like('_transient_timeout_mco_questions_') . '%'
            )
        );
        
        mco_add_admin_notice('success', 'All question caches have been cleared.');
        wp_redirect(admin_url('admin.php?page=mco-exam-engine&tab=tools'));
        exit;
    }
}

if (!function_exists('mco_register_main_settings')) {
    function mco_register_main_settings() {
        register_setting('mco_main_options_group', 'mco_exam_app_url');
        register_setting('mco_main_options_group', 'mco_custom_logo_url');
        register_setting('mco_main_options_group', 'mco_active_theme_id');
        register_setting('mco_main_options_group', 'mco_config_version');
        register_setting('mco_main_options_group', 'mco_intro_video_url');
    }
}


if (!function_exists('mco_register_certificate_settings')) {
    function mco_register_certificate_settings() {
        register_setting('mco_certificate_options_group', 'mco_certificate_templates');
        register_setting('mco_certificate_options_group', 'mco_signature1_base64');
        register_setting('mco_certificate_options_group', 'mco_signature2_base64');
        register_setting('mco_certificate_options_group', 'mco_certificate_theme');
    }
}

if (!function_exists('mco_admin_enqueue_scripts')) {
    function mco_admin_enqueue_scripts($hook) {
        // Only load on our specific admin page
        if ($hook === 'exam-app-engine_page_mco-exam-engine' || $hook === 'toplevel_page_mco-exam-engine') {
            wp_enqueue_style('mco-admin-styles', MCO_PLUGIN_URL . 'assets/mco-styles.css', array(), MCO_PLUGIN_VERSION);
        }
    }
}


if (!function_exists('mco_exam_engine_admin_page')) {
    function mco_exam_engine_admin_page() {
        $active_tab = isset($_GET['tab']) ? sanitize_key($_GET['tab']) : 'main_settings';
        ?>
        <div class="wrap mco-admin-wrap">
            <h1>MCO Exam Integration Engine</h1>
            <h2 class="nav-tab-wrapper">
                <a href="?page=mco-exam-engine&tab=main_settings" class="nav-tab <?php echo $active_tab == 'main_settings' ? 'nav-tab-active' : ''; ?>">Main Settings</a>
                <a href="?page=mco-exam-engine&tab=certificate_templates" class="nav-tab <?php echo $active_tab == 'certificate_templates' ? 'nav-tab-active' : ''; ?>">Certificate Templates</a>
                <a href="?page=mco-exam-engine&tab=theme_selector" class="nav-tab <?php echo $active_tab == 'theme_selector' ? 'nav-tab-active' : ''; ?>">Theme Selector</a>
                <a href="?page=mco-exam-engine&tab=bulk_import" class="nav-tab <?php echo $active_tab == 'bulk_import' ? 'nav-tab-active' : ''; ?>">Bulk Import</a>
                <a href="?page=mco-exam-engine&tab=tools" class="nav-tab <?php echo $active_tab == 'tools' ? 'nav-tab-active' : ''; ?>">Tools</a>
            </h2>

            <?php
            // The content for each tab is rendered by a separate function
            $render_function_name = 'mco_render_' . $active_tab . '_tab';
            if (function_exists($render_function_name)) {
                call_user_func($render_function_name);
            } else {
                mco_render_main_settings_tab(); // Fallback to default
            }
            ?>
        </div>
        <?php
    }
}

// [All individual tab rendering functions: mco_render_main_settings_tab, mco_render_certificate_templates_tab, etc. remain here]
// ...
// --- BULK IMPORT & EXPORT HANDLERS ---
// [All handler functions: mco_handle_generate_tenant_blueprint, mco_handle_csv_upload, etc. remain here]
// ...
// --- ADMIN NOTICES ---
// [mco_add_admin_notice and mco_display_admin_notices remain here]
?>