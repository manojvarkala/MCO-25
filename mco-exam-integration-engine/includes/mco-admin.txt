<?php
if (!defined('ABSPATH')) exit;

// --- HOOKS ---
add_action('admin_menu', 'mco_exam_add_admin_menu');
add_action('add_meta_boxes', 'mco_add_meta_boxes');
add_action('save_post_product', 'mco_save_wc_product_meta_data');
add_action('save_post_mco_exam_program', 'mco_save_exam_program_meta');
add_action('save_post_mco_recommended_book', 'mco_save_book_meta_data');
add_action('admin_init', 'mco_register_settings_and_fields');
add_action('save_post', 'mco_auto_update_config_version_on_save');

// --- AUTO-VERSIONING ---
if (!function_exists('mco_auto_update_config_version_on_save')) {
    function mco_auto_update_config_version_on_save($post_id) {
        $post_type = get_post_type($post_id);
        if ($post_type === 'mco_exam_program' || $post_type === 'mco_recommended_book') {
            update_option('mco_config_version', current_time('YmdHis'));
        }
    }
}
if (!function_exists('mco_auto_update_config_version_on_settings_save')) {
    function mco_auto_update_config_version_on_settings_save($option_name) {
        if ($option_name === 'mco_certificate_templates') {
            update_option('mco_config_version', current_time('YmdHis'));
        }
    }
    add_action('update_option_mco_certificate_templates', 'mco_auto_update_config_version_on_settings_save', 10, 1);
}

// --- ADMIN NOTICES ---
if (!function_exists('mco_admin_notices')) {
    function mco_admin_notices() {
        if (!defined('MCO_JWT_SECRET') || strlen(MCO_JWT_SECRET) < 32) echo '<div class="notice notice-error"><p><strong>Exam App Engine:</strong> A secure <strong>MCO_JWT_SECRET</strong> is not defined in wp-config.php. SSO will not work.</p></div>';
        if (empty(get_option('mco_exam_app_url'))) echo '<div class="notice notice-warning"><p><strong>Exam App Engine:</strong> The Exam App URL is not set. Please <a href="' . admin_url('admin.php?page=mco-exam-engine') . '">configure it</a>.</p></div>';
    }
}
add_action('admin_notices', 'mco_admin_notices');

// --- ADMIN MENU & PAGES ---
if (!function_exists('mco_exam_add_admin_menu')) {
    function mco_exam_add_admin_menu() {
        add_menu_page('Exam App Engine', 'Exam App Engine', 'manage_options', 'mco-exam-engine', 'mco_render_settings_page', 'dashicons-analytics', 80);
        add_submenu_page('mco-exam-engine', 'Exam Programs', 'Exam Programs', 'manage_options', 'edit.php?post_type=mco_exam_program');
        add_submenu_page('mco-exam-engine', 'Recommended Books', 'Recommended Books', 'manage_options', 'edit.php?post_type=mco_recommended_book');
    }
}

if (!function_exists('mco_render_settings_page')) {
    function mco_render_settings_page() {
        $active_tab = isset($_GET['tab']) ? sanitize_key($_GET['tab']) : 'main_settings';

        if (isset($_POST['mco_flush_rewrites']) && check_admin_referer('mco_flush_rewrites_nonce')) {
            flush_rewrite_rules(true);
            add_action('admin_notices', function() {
                echo '<div class="notice notice-success is-dismissible"><p>API routes have been successfully refreshed.</p></div>';
            });
        }
        ?>
        <div class="wrap">
            <h1>Exam App Engine Settings</h1>
            <?php settings_errors(); do_action('admin_notices'); ?>
            <h2 class="nav-tab-wrapper">
                <a href="?page=mco-exam-engine&tab=main_settings" class="nav-tab <?php echo $active_tab == 'main_settings' ? 'nav-tab-active' : ''; ?>">Main Settings</a>
                <a href="?page=mco-exam-engine&tab=certificate_templates" class="nav-tab <?php echo $active_tab == 'certificate_templates' ? 'nav-tab-active' : ''; ?>">Certificate Templates</a>
                <a href="?page=mco-exam-engine&tab=tools" class="nav-tab <?php echo $active_tab == 'tools' ? 'nav-tab-active' : ''; ?>">Tools</a>
            </h2>

            <?php if ($active_tab !== 'tools'): ?>
                <form method="post" action="options.php">
                    <?php
                    if ($active_tab == 'main_settings') {
                        settings_fields('mco_main_settings_group');
                        do_settings_sections('mco_main_settings_page');
                    } elseif ($active_tab == 'certificate_templates') {
                        settings_fields('mco_certificate_templates_group');
                        do_settings_sections('mco_certificate_templates_page');
                    }
                    submit_button();
                    ?>
                </form>
            <?php else: ?>
                <?php mco_render_tools_tab(); ?>
            <?php endif; ?>
        </div>
        <?php
    }
}

if (!function_exists('mco_register_settings_and_fields')) {
    function mco_register_settings_and_fields() {
        register_setting('mco_main_settings_group', 'mco_exam_app_url');
        add_settings_section('mco_main_section', 'Core Configuration', null, 'mco_main_settings_page');
        add_settings_field('mco_exam_app_url_field', 'Exam Application URL', 'mco_render_app_url_field', 'mco_main_settings_page', 'mco_main_section');
        add_settings_field('mco_config_version_field', 'Live Config Version', 'mco_render_config_version_field', 'mco_main_settings_page', 'mco_main_section');
        
        register_setting('mco_certificate_templates_group', 'mco_certificate_templates', ['sanitize_callback' => 'mco_sanitize_certificate_templates']);
        add_settings_section('mco_certificate_section', 'Manage Certificate Templates', null, 'mco_certificate_templates_page');
        add_settings_field('mco_certificate_templates_field', '', 'mco_render_certificate_templates_field', 'mco_certificate_templates_page', 'mco_certificate_section');
    }
}

// --- RENDER FUNCTIONS FOR SETTINGS FIELDS ---
if (!function_exists('mco_render_app_url_field')) {
    function mco_render_app_url_field() {
        echo '<input type="url" name="mco_exam_app_url" value="' . esc_attr(get_option('mco_exam_app_url')) . '" class="regular-text" placeholder="https://exams.yourdomain.com">';
        echo '<p class="description"><strong>Crucial:</strong> Enter the main URL of your standalone React app. Do not include a path or a trailing slash.</p>';
    }
}

if (!function_exists('mco_render_config_version_field')) {
    function mco_render_config_version_field() {
        $version = get_option('mco_config_version', 'Not set');
        echo '<input type="text" value="' . esc_attr($version) . '" class="regular-text" readonly disabled>';
        echo '<p class="description">This version timestamp updates automatically when you save an exam, book, or certificate template. It signals the app to fetch new content.</p>';
    }
}

if (!function_exists('mco_render_certificate_templates_field')) {
    function mco_render_certificate_templates_field() {
        $templates = get_option('mco_certificate_templates', []);
        echo '<p class="description" style="margin-bottom: 1rem;">Edit the details for each certificate template below. The <strong>Template ID</strong> is crucial and should follow the format <code>cert-&lt;exam-sku-suffix&gt;</code> (e.g., <code>cert-cpc</code> for an exam with SKU <code>exam-cpc-cert</code>). The <code>cert-practice-1</code> template is used for all practice exams.</p>';
        echo '<div id="mco-certificate-accordion">';
        foreach ($templates as $id => $template) {
            ?>
            <div class="mco-cert-template-item">
                <h4 class="mco-cert-template-title"><?php echo esc_html($template['title']); ?> (ID: <?php echo esc_html($id); ?>)</h4>
                <div class="mco-cert-template-content">
                    <input type="hidden" name="mco_certificate_templates[<?php echo esc_attr($id); ?>][id]" value="<?php echo esc_attr($id); ?>">
                    <p><label>Title:<br><input type="text" name="mco_certificate_templates[<?php echo esc_attr($id); ?>][title]" value="<?php echo esc_attr($template['title']); ?>" class="large-text"></label></p>
                    <p><label>Body (use <code>{finalScore}</code> where the score should appear):<br><textarea name="mco_certificate_templates[<?php echo esc_attr($id); ?>][body]" rows="3" class="large-text"><?php echo esc_textarea($template['body']); ?></textarea></label></p>
                    <p><label>Signature 1 Name:<br><input type="text" name="mco_certificate_templates[<?php echo esc_attr($id); ?>][signature1Name]" value="<?php echo esc_attr($template['signature1Name']); ?>" class="regular-text"></label></p>
                    <p><label>Signature 1 Title:<br><input type="text" name="mco_certificate_templates[<?php echo esc_attr($id); ?>][signature1Title]" value="<?php echo esc_attr($template['signature1Title']); ?>" class="regular-text"></label></p>
                    <p><label>Signature 1 Image (Base64 SVG):<br><textarea name="mco_certificate_templates[<?php echo esc_attr($id); ?>][signature1ImageBase64]" rows="2" class="large-text"><?php echo esc_textarea($template['signature1ImageBase64']); ?></textarea></label></p>
                    <hr style="margin: 1rem 0;">
                    <p><label>Signature 2 Name (optional):<br><input type="text" name="mco_certificate_templates[<?php echo esc_attr($id); ?>][signature2Name]" value="<?php echo esc_attr($template['signature2Name']); ?>" class="regular-text"></label></p>
                    <p><label>Signature 2 Title (optional):<br><input type="text" name="mco_certificate_templates[<?php echo esc_attr($id); ?>][signature2Title]" value="<?php echo esc_attr($template['signature2Title']); ?>" class="regular-text"></label></p>
                    <p><label>Signature 2 Image (Base64 SVG):<br><textarea name="mco_certificate_templates[<?php echo esc_attr($id); ?>][signature2ImageBase64]" rows="2" class="large-text"><?php echo esc_textarea($template['signature2ImageBase64']); ?></textarea></label></p>
                </div>
            </div>
            <?php
        }
        echo '</div>';
        ?>
        <style>
            .mco-cert-template-item { border: 1px solid #ddd; margin-bottom: 1rem; }
            .mco-cert-template-title { font-size: 1.1em; padding: 0.8rem; margin: 0; background: #f9f9f9; cursor: pointer; }
            .mco-cert-template-content { display: none; padding: 1rem; border-top: 1px solid #ddd; }
            .mco-cert-template-item.active .mco-cert-template-content { display: block; }
        </style>
        <script>
        jQuery(document).ready(function($){
            $('#mco-certificate-accordion .mco-cert-template-title').click(function(){
                $(this).parent().toggleClass('active').find('.mco-cert-template-content').slideToggle();
            });
        });
        </script>
        <?php
    }
}

if (!function_exists('mco_sanitize_certificate_templates')) {
    function mco_sanitize_certificate_templates($input) {
        $output = [];
        foreach ($input as $id => $template) {
            $sanitized_id = sanitize_key($id);
            $output[$sanitized_id] = [
                'id' => $sanitized_id,
                'title' => sanitize_text_field($template['title']),
                'body' => wp_kses_post($template['body']),
                'signature1Name' => sanitize_text_field($template['signature1Name']),
                'signature1Title' => sanitize_text_field($template['signature1Title']),
                'signature1ImageBase64' => esc_url_raw($template['signature1ImageBase64']),
                'signature2Name' => sanitize_text_field($template['signature2Name']),
                'signature2Title' => sanitize_text_field($template['signature2Title']),
                'signature2ImageBase64' => esc_url_raw($template['signature2ImageBase64']),
            ];
        }
        return $output;
    }
}

if (!function_exists('mco_render_tools_tab')) {
    function mco_render_tools_tab() {
        ?>
        <h3>Maintenance Tools</h3>
        <form method="post" action="?page=mco-exam-engine&tab=tools">
            <?php wp_nonce_field('mco_flush_rewrites_nonce'); ?>
            <input type="hidden" name="mco_flush_rewrites" value="1">
            <table class="form-table">
                <tr valign="top">
                    <th scope="row">API Routes</th>
                    <td>
                        <p>If you see API errors, click this button to rebuild the API route list. This is often needed after plugin updates.</p>
                        <?php submit_button('Force Refresh API Routes', 'secondary', 'submit_flush', false); ?>
                    </td>
                </tr>
            </table>
        </form>
        <?php
    }
}

// --- META BOXES & SAVE FUNCTIONS ---
if (!function_exists('mco_add_meta_boxes')) {
    function mco_add_meta_boxes() {
        add_meta_box('mco_wc_product_meta', 'Exam App Configuration', 'mco_render_wc_product_meta_box', 'product', 'side', 'high');
        add_meta_box('mco_exam_program_meta', 'Exam Program Details', 'mco_render_exam_program_meta_box', 'mco_exam_program', 'normal', 'high');
        add_meta_box('mco_book_links_meta', 'Affiliate Links', 'mco_render_book_links_meta_box', 'mco_recommended_book', 'normal', 'high');
    }
}

if (!function_exists('mco_render_exam_program_meta_box')) {
    function mco_render_exam_program_meta_box($post) {
        wp_nonce_field('mco_save_exam_meta', 'mco_exam_nonce');
        $source_url = get_post_meta($post->ID, '_mco_question_source_url', true);
        $cert_sku = get_post_meta($post->ID, '_mco_certification_exam_sku', true);
        echo '<p><label>Question Source Google Sheet URL:</label><br><input type="url" name="mco_question_source_url" value="' . esc_attr($source_url) . '" style="width:100%;"></p>';
        echo '<p><label>Certification Exam Product SKU:</label><br><input type="text" name="mco_certification_exam_sku" value="' . esc_attr($cert_sku) . '" style="width:100%;"></p>';
    }
}

if (!function_exists('mco_save_exam_program_meta')) {
    function mco_save_exam_program_meta($post_id) {
        if (!isset($_POST['mco_exam_nonce']) || !wp_verify_nonce($_POST['mco_exam_nonce'], 'mco_save_exam_meta') || (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE)) return;
        if (isset($_POST['mco_question_source_url'])) update_post_meta($post_id, '_mco_question_source_url', esc_url_raw($_POST['mco_question_source_url']));
        if (isset($_POST['mco_certification_exam_sku'])) update_post_meta($post_id, '_mco_certification_exam_sku', sanitize_text_field($_POST['mco_certification_exam_sku']));
    }
}

if (!function_exists('mco_render_book_links_meta_box')) {
    function mco_render_book_links_meta_box($post) {
        wp_nonce_field('mco_save_book_meta', 'mco_book_nonce');
        $link_com = get_post_meta($post->ID, '_mco_link_com', true); $link_in = get_post_meta($post->ID, '_mco_link_in', true); $link_ae = get_post_meta($post->ID, '_mco_link_ae', true);
        echo '<p><label>Amazon.com URL:</label><br><input type="url" name="mco_link_com" value="' . esc_attr($link_com) . '" style="width:100%;"></p>';
        echo '<p><label>Amazon.in URL:</label><br><input type="url" name="mco_link_in" value="' . esc_attr($link_in) . '" style="width:100%;"></p>';
        echo '<p><label>Amazon.ae URL:</label><br><input type="url" name="mco_link_ae" value="' . esc_attr($link_ae) . '" style="width:100%;"></p>';
    }
}

if (!function_exists('mco_save_book_meta_data')) {
    function mco_save_book_meta_data($post_id) {
        if (!isset($_POST['mco_book_nonce']) || !wp_verify_nonce($_POST['mco_book_nonce'], 'mco_save_book_meta') || (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE)) return;
        if (isset($_POST['mco_link_com'])) update_post_meta($post_id, '_mco_link_com', esc_url_raw($_POST['mco_link_com']));
        if (isset($_POST['mco_link_in'])) update_post_meta($post_id, '_mco_link_in', esc_url_raw($_POST['mco_link_in']));
        if (isset($_POST['mco_link_ae'])) update_post_meta($post_id, '_mco_link_ae', esc_url_raw($_POST['mco_link_ae']));
    }
}

if (!function_exists('mco_render_wc_product_meta_box')) {
    function mco_render_wc_product_meta_box($post) {
        wp_nonce_field('mco_save_wc_meta', 'mco_wc_nonce');
        $product_type = get_post_meta($post->ID, '_mco_product_type', true);
        echo '<label for="mco_product_type">Product Role:</label><select name="mco_product_type" id="mco_product_type" style="width:100%;"><option value="" ' . selected($product_type, '', false) . '>None</option><option value="certification_exam" ' . selected($product_type, 'certification_exam', false) . '>Certification Exam</option><option value="subscription_bundle" ' . selected($product_type, 'subscription_bundle', false) . '>Subscription / Bundle</option></select>';
    }
}

if (!function_exists('mco_save_wc_product_meta_data')) {
    function mco_save_wc_product_meta_data($post_id) {
        if (!isset($_POST['mco_wc_nonce']) || !wp_verify_nonce($_POST['mco_wc_nonce'], 'mco_save_wc_meta') || (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE)) return;
        if (isset($_POST['mco_product_type'])) update_post_meta($post_id, '_mco_product_type', sanitize_text_field($_POST['mco_product_type']));
    }
}

if (!function_exists('mco_get_default_certificate_templates')) {
    function mco_get_default_certificate_templates() {
        return [
            'cert-practice-1' => [
                'id' => 'cert-practice-1',
                'title' => 'Certificate of Proficiency',
                'body' => 'For successfully demonstrating proficiency in the subject matter with a final score of <strong>{finalScore}%</strong>.',
                'signature1Name' => 'Program Director',
                'signature1Title' => 'Certification Authority',
                'signature1ImageBase64' => 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCAzMDAgODAiPjxwYXRoIGQ9Ik0xMiw1My4zMjYxQzE2Ljg2NDcsNDcuMjQzNyAyOC43MjQ3LDQwLjM0NDIgNDEuMzQzOCw0NS4xMTM4QzUzLjM2Niw0OS42Njc3IDU5Ljk0ODksNTguNDg4NyA3Mi4zNDM4LDYxLjUxMTRDODQuNzM4OCw2NC41MzQgOTkuNDUwNCw2MC4zODI0IDExMS4yNSw1NC43MkMxMjMuMDQ5Niw0OS4wNTc2IDEzNi44OTYsNDQuNjE4NCAxNDguOTIyLDQ1LjExMzhDMTYwLjk0Niw0NS42MDkzIDE2Ny44OTksNTEuMzMzNyAxNzkuNTgsNDkuNjY3N0MxOTEuMjYsNDggMTk4LjgzNCwzNi4xNzQzIDIxMC43NSwzNi4xNzQzQzIyMi42NjYsMzYuMTc0MyAyMjguODEzLDQ4LjA4NjYgMjM5LjUsNDkuNjY3N0MyNTAuMTg3LDUxLjI0ODkgMjU4LjU5OCw0NC4wMzIxIDI2OS41LDQ1LjExMzhDMjgwLjQwMSw0Ni4xOTU1IDI4Ni41LDUzLjA5NSAyOTEsNjEuNTExNCIgc3Ryb2tlPSIjMWUyOTJiIiBmaWxsPSJub25lIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvc3ZnPg==',
                'signature2Name' => 'Lead Instructor',
                'signature2Title' => 'Training Department',
                'signature2ImageBase64' => 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCAzMDAgODAiPjxwYXRoIGQ9Ik0xNSw1NSBDMjAsNDAgMzUsMzAgNDUsNDUgQzU1LDYwIDcwLDY1IDgwLDU1IEM5MCw0NSAxMDAsMzAgMTEwLDQ1IEMxMjAsNjAgMTM1LDY1IDE0NSw1NSBMMTYwLDQwIEwxNzUsNjAgTTE4NSw2MCBDMTk1LDQwIDIxMCw0NSAyMjAsNjAgQzIzMCw3NSAyNDUsNzAgMjU1LDYwIEMyNjUsNTAgMjg1LDgwIDI5MCw2MCIgc3Ryb2tlPSIjMWUyOTNiIiBmaWxsPSJub25lIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvc3ZnPg=='
            ],
            'cert-generic' => [
                'id' => 'cert-generic',
                'title' => 'Certificate of Completion',
                'body' => 'For successfully completing the comprehensive examination with a final score of <strong>{finalScore}%</strong>.',
                'signature1Name' => 'Program Director',
                'signature1Title' => 'Certification Authority',
                'signature1ImageBase64' => 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCAzMDAgODAiPjxwYXRoIGQ9Ik0xMCw1NSBDMTUsMzAgMzUsMjUgNDUsNDAgQzU1LDU1IDcwLDY1IDgwLDUwIEM5MCwzNSAxMDUsMzAgMTE1LDQ1IEMxMjUsNjAgMTQwLDY1IDE1MCw1MCBDMTYwLDM1IDE3NSwzNSAxODUsNTAgQzE5NSw2NSAyMTAsNzAgMjIwLDU1IEMyMzAsNDAgMjQ1LDMwIDI1NSw0NSBDMjY1LDYwIDI4MCw2NSAyOTAsNTAiIHN0cm9rZT0iIzFlMjkyYiIgZmlsbD0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48L3N2Zz4=',
                'signature2Name' => 'Lead Instructor',
                'signature2Title' => 'Training Department',
                'signature2ImageBase64' => 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCAzMDAgODAiPjxwYXRoIGQ9Ik0xNSw1NSBDMjAsNDAgMzUsMzAgNDUsNDUgQzU1LDYwIDcwLDY1IDgwLDU1IEM5MCw0NSAxMDAsMzAgMTEwLDQ1IEMxMjAsNjAgMTM1LDY1IDE0NSw1NSBMMTYwLDQwIEwxNzUsNjAgTTE4NSw2MCBDMTk1LDQwIDIxMCw0NSAyMjAsNjAgQzIzMCw3NSAyNDUsNzAgMjU1LDYwIEMyNjUsNTAgMjg1LDgwIDI5MCw2MCIgc3Ryb2tlPSIjMWUyOTNiIiBmaWxsPSJub25lIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvc3ZnPg=='
            ]
        ];
    }
}
?>