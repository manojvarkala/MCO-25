<?php
// Add top-level admin menu
function mco_exam_admin_menu() {
    add_menu_page(
        'Exam App Engine',
        'Exam App Engine',
        'manage_options',
        'mco-exam-settings',
        'mco_exam_settings_page',
        'dashicons-welcome-learn-more',
        25
    );
}
add_action('admin_menu', 'mco_exam_admin_menu');

// Register Settings
function mco_register_main_settings() {
    register_setting('mco_main_options', 'mco_app_url');
    register_setting('mco_main_options', 'mco_custom_logo_url');
    register_setting('mco_main_options', 'mco_subscriptions_enabled');
    register_setting('mco_main_options', 'mco_bundles_enabled');
}
add_action('admin_init', 'mco_register_main_settings');

// Admin page content
function mco_exam_settings_page() {
    ?>
    <div class="wrap mco-admin-wrapper">
        <h1>Exam App Engine - Settings & Tools</h1>
        <?php settings_errors(); ?>

        <h2 class="nav-tab-wrapper">
            <a href="?page=mco-exam-settings&tab=main" class="nav-tab <?php echo (!isset($_GET['tab']) || $_GET['tab'] == 'main') ? 'nav-tab-active' : ''; ?>">Main Settings</a>
            <a href="?page=mco-exam-settings&tab=certs" class="nav-tab <?php echo (isset($_GET['tab']) && $_GET['tab'] == 'certs') ? 'nav-tab-active' : ''; ?>">Certificate Templates</a>
             <a href="?page=mco-exam-settings&tab=tools" class="nav-tab <?php echo (isset($_GET['tab']) && $_GET['tab'] == 'tools') ? 'nav-tab-active' : ''; ?>">Tools</a>
             <a href="?page=mco-exam-settings&tab=bulk" class="nav-tab <?php echo (isset($_GET['tab']) && $_GET['tab'] == 'bulk') ? 'nav-tab-active' : ''; ?>">Bulk Data</a>
        </h2>

        <div class="mco-tab-content">
            <?php
            $active_tab = isset($_GET['tab']) ? $_GET['tab'] : 'main';
            
            if ($active_tab == 'main') {
                ?>
                <form method="post" action="options.php">
                    <?php settings_fields('mco_main_options'); ?>
                    <table class="form-table">
                        <tr valign="top">
                            <th scope="row">Exam Application URL(s)</th>
                            <td>
                                <textarea name="mco_app_url" rows="3" class="large-text code"><?php echo esc_textarea(get_option('mco_app_url')); ?></textarea>
                                <p class="description">Enter the full URL of your React application (e.g., <code>https://exams.yoursite.com</code>). For multiple environments (dev/staging), enter each on a new line.</p>
                            </td>
                        </tr>
                        <tr valign="top">
                            <th scope="row">Custom Logo URL</th>
                            <td>
                                <input type="text" name="mco_custom_logo_url" value="<?php echo esc_attr(get_option('mco_custom_logo_url')); ?>" class="regular-text" />
                                <p class="description">Direct URL to your logo image. If empty, the Site Icon will be used.</p>
                            </td>
                        </tr>
                        <tr valign="top">
                            <th scope="row">Features</th>
                            <td>
                                <fieldset>
                                    <label><input type="checkbox" name="mco_subscriptions_enabled" value="1" <?php checked(get_option('mco_subscriptions_enabled', '1'), 1); ?> /> Enable Subscriptions</label><br>
                                    <label><input type="checkbox" name="mco_bundles_enabled" value="1" <?php checked(get_option('mco_bundles_enabled', '1'), 1); ?> /> Enable Bundles</label>
                                </fieldset>
                            </td>
                        </tr>
                    </table>
                    <?php submit_button(); ?>
                </form>
                <?php
            } elseif ($active_tab == 'certs') {
                 echo '<p>Certificate templates are currently managed via the JSON config or database directly. A visual editor is coming soon.</p>';
            } elseif ($active_tab == 'tools') {
                 ?>
                 <h3>Cache Management</h3>
                 <p>If you have made changes to products or exams and they aren't appearing in the app, try clearing the cache.</p>
                 <button id="mco-clear-cache-btn" class="button button-secondary">Clear Config Cache</button>
                 <script>
                     document.getElementById('mco-clear-cache-btn').addEventListener('click', function(e) {
                         e.preventDefault();
                         alert('To clear cache, please use the "System Health Check" in the React App Admin Panel.');
                     });
                 </script>
                 <?php
            } elseif ($active_tab == 'bulk') {
                 echo '<p>Please use the <strong>Bulk Data Management</strong> tools located within the React Application Admin Panel for importing/exporting CSVs.</p>';
            }
            ?>
        </div>
    </div>
    <?php
}

// Handler for generating Exam Programs CSV
function mco_handle_generate_programs_csv() {
    if (!isset($_POST['_wpnonce']) || !wp_verify_nonce($_POST['_wpnonce'], 'generate_programs_csv') || !current_user_can('manage_options')) {
        wp_die('Security check failed');
    }

    if (ob_get_length()) ob_end_clean();

    header('Content-Type: text/csv');
    header('Content-Disposition: attachment; filename="exam-programs-export-' . date('Y-m-d') . '.csv"');

    $output = fopen('php://output', 'w');

    $header = ['program_title', 'program_description', 'practice_exam_name_override', 'cert_exam_name_override', 'question_source_url', 'certification_exam_sku', 'is_proctored', 'certificate_enabled', 'recommended_book_id', 'practice_questions', 'practice_duration', 'cert_questions', 'cert_duration', 'pass_score', 'status'];
    fputcsv($output, $header);

    $query = new WP_Query([
        'post_type' => 'mco_exam_program',
        'posts_per_page' => -1,
        'post_status' => 'any',
    ]);

    if ($query->have_posts()) {
        while ($query->have_posts()) {
            $query->the_post();
            $post_id = get_the_ID();
            $row = [
                get_the_title(),
                get_the_content(),
                get_post_meta($post_id, 'mco_practice_exam_name_override', true),
                get_post_meta($post_id, 'mco_cert_exam_name_override', true),
                get_post_meta($post_id, 'mco_question_source_url', true),
                get_post_meta($post_id, 'mco_cert_exam_sku', true),
                get_post_meta($post_id, 'mco_cert_is_proctored', true) ? '1' : '0',
                get_post_meta($post_id, 'mco_cert_certificate_enabled', true) ? '1' : '0',
                implode(',', get_post_meta($post_id, 'mco_recommended_book_ids', true) ?: []),
                get_post_meta($post_id, 'mco_practice_questions', true),
                get_post_meta($post_id, 'mco_practice_duration', true),
                get_post_meta($post_id, 'mco_cert_questions', true),
                get_post_meta($post_id, 'mco_cert_duration', true),
                get_post_meta($post_id, 'mco_cert_pass_score', true),
                get_post_status(),
            ];
            fputcsv($output, $row);
        }
    }
    wp_reset_postdata();

    fclose($output);
    exit;
}
add_action('admin_post_mco_generate_programs_csv', 'mco_handle_generate_programs_csv');


// Handler for generating WooCommerce Products CSV
function mco_handle_generate_products_csv() {
    if (!isset($_POST['_wpnonce']) || !wp_verify_nonce($_POST['_wpnonce'], 'generate_products_csv') || !current_user_can('manage_options')) {
        wp_die('Security check failed');
    }

    if (ob_get_length()) ob_end_clean();

    header('Content-Type: text/csv');
    header('Content-Disposition: attachment; filename="woo-products-from-programs-' . date('Y-m-d') . '.csv"');

    $output = fopen('php://output', 'w');

    $header = ['Type', 'SKU', 'Name', 'Published', 'Virtual', 'Regular price', 'Sale price'];
    fputcsv($output, $header);

    $query = new WP_Query([
        'post_type' => 'mco_exam_program',
        'posts_per_page' => -1,
        'post_status' => 'publish',
    ]);

    if ($query->have_posts()) {
        while ($query->have_posts()) {
            $query->the_post();
            $post_id = get_the_ID();
            
            $cert_sku = get_post_meta($post_id, 'mco_cert_exam_sku', true);
            $cert_name = get_post_meta($post_id, 'mco_cert_exam_name_override', true) ?: get_the_title();

            if (!empty($cert_sku)) {
                $row = [
                    'simple',
                    $cert_sku,
                    $cert_name,
                    '1',
                    '1',
                    get_post_meta($post_id, 'mco_cert_regular_price', true) ?: '49.99',
                    get_post_meta($post_id, 'mco_cert_sale_price', true) ?: '',
                ];
                fputcsv($output, $row);
            }
        }
    }
    wp_reset_postdata();

    fclose($output);
    exit;
}
add_action('admin_post_mco_generate_products_csv', 'mco_handle_generate_products_csv');
?>