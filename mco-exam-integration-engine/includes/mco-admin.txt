<?php
if (!defined('ABSPATH')) exit;

// --- ADMIN MENU & PAGE ---

if (!function_exists('mco_add_admin_menu')) {
    function mco_add_admin_menu() {
        // Step 1: Create the top-level menu page. This is the parent for all other items.
        add_menu_page(
            'Exam App Engine',          // Page Title
            'Exam App Engine',          // Menu Title
            'manage_options',           // Capability
            'mco-exam-engine',          // Menu Slug (this will be the slug for the first submenu item)
            'mco_exam_engine_admin_page', // Callback function for the default page
            'dashicons-welcome-learn-more', // Icon
            25                          // Position
        );

        // Step 2: Add the CPTs as submenu items under the new parent.
        add_submenu_page(
            'mco-exam-engine',                  // Parent slug
            'Exam Programs',                    // Page Title
            'Exam Programs',                    // Menu Title
            'manage_options',                   // Capability
            'edit.php?post_type=mco_exam_program' // The link to the CPT list view
        );
        add_submenu_page(
            'mco-exam-engine',                  // Parent slug
            'Recommended Books',                // Page Title
            'Recommended Books',                // Menu Title
            'manage_options',                   // Capability
            'edit.php?post_type=mco_recommended_book' // The link to the CPT list view
        );
        
        // Step 3: Add the custom Settings & Tools page as another submenu.
        // We make its slug the same as the parent to make it the default page when clicking the top-level menu.
        add_submenu_page(
            'mco-exam-engine',              // Parent slug
            'Settings & Tools',             // Page Title
            'Settings & Tools',             // Menu Title
            'manage_options',               // Capability
            'mco-exam-engine',              // Menu Slug (matches parent to become the default)
            'mco_exam_engine_admin_page'    // Callback function
        );
    }
}


if (!function_exists('mco_register_admin_hooks')) {
    function mco_register_admin_hooks() {
        add_action('admin_menu', 'mco_add_admin_menu');
        add_action('admin_enqueue_scripts', 'mco_admin_enqueue_scripts');
        add_action('admin_post_mco_bulk_import_csv', 'mco_handle_csv_upload');
        // New hook for blueprint generation
        add_action('admin_post_mco_generate_tenant_blueprint', 'mco_handle_generate_tenant_blueprint');
        // New hook for full content snapshot generation
        add_action('admin_post_mco_generate_full_snapshot', 'mco_handle_generate_full_snapshot');
        add_action('add_meta_boxes', 'mco_add_exam_program_meta_boxes');
        add_action('save_post_mco_exam_program', 'mco_save_exam_program_meta_data');
        add_action('admin_init', 'mco_register_certificate_settings'); // New hook for signature settings
    }
}

// New function to register certificate signature settings
if (!function_exists('mco_register_certificate_settings')) {
    function mco_register_certificate_settings() {
        register_setting('mco_certificate_options_group', 'mco_certificate_templates');
        register_setting('mco_certificate_options_group', 'mco_signature1_base64');
        register_setting('mco_certificate_options_group', 'mco_signature2_base64');
    }
}
