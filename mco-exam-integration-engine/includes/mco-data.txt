<?php
if (!defined('ABSPATH')) exit;

if (!function_exists('mco_get_default_certificate_templates')) {
    function mco_get_default_certificate_templates() { 
        return [
            'cert-practice' => [
                'id' => 'cert-practice', 
                'name' => 'Default Practice Certificate', 
                'title' => 'Certificate of Proficiency', 
                'body' => "This certifies that <strong>{candidateName}</strong> has successfully demonstrated proficiency in the <strong>{examName}</strong> practice exam, achieving a score of <strong>{finalScore}%</strong>.", 
                'signature1Name' => 'Amelia Reed', 
                'signature1Title' => 'Program Director', 
                'signature1ImageUrl' => 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCAzMDAgODAiPjxwYXRoIGQ9Ik0xMiw1My4zMjYxQzE2Ljg2NDcsNDcuMjQzNyAyOC43MjQ3LDQwLjM0NDIgNDEuMzQzOCw0NS4xMTM4QzUzLjM2Niw0OS42Njc3IDU5Ljk0ODksNTguNDg4NyA3Mi4zNDM4LDYxLjUxMTRDODQuNzM4OCw2NC41MzQgOTkuNDUwNCw2MC4zODI0IDExMS4yNSw1NC43MkMxMjMuMDQ5Niw0OS4wNTc2IDEzNi44OTYsNDQuNjE4NCAxNDguOTIyLDQ1LjExMzhDMTYwLjk0Niw0NS42MDkzIDE2Ny44OTksNTEuMzMzNyAxNzkuNTgsNDkuNjY3N0MxOTEuMjYsNDggMTk4LjgzNCwzNi4xNzQzIDIxMC43NSwzNi4xNzQzQzIyMi42NjYsMzYuMTc0MyAyMjguODEzLDQ4LjA4NjYgMjM5LjUsNDkuNjY3N0MyNTAuMTg3LDUxLjI0ODkgMjU4LjU5OCw0NC4wMzIxIDI2OS41LDQ1LjExMzhDMjgwLjQwMSw0Ni4xOTU1IDI4Ni41LDUzLjA5NSAyOTEsNjEuNTExNCIgc3Ryb2tlPSIjMWUyOTJiIiBmaWxsPSJub25lIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvc3ZnPg==', 
                'signature2Name' => 'Quinn Casey, CPC', 
                'signature2Title' => 'Lead Instructor',
                'signature2ImageUrl' => 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCAzMDAgODAiPjxwYXRoIGQ9Ik0xMiw0Mi4xNDQ4QzE2Ljg2NDcsMzYuMDYyNCAyOC43MjQ3LDI5LjE2MyA0MS4zNDM4LDMzLjkyMjdDNTMuMzY2LDM4LjQ4NjQgNTkuOTQ4OSw0Ny4zMDc1IDcyLjM0MzgsNTAuMzMyMkM4NC43Mzg4LDUzLjM1MjggOTkuNDUwNCw0OS4yMDEyIDExMS4yNSw0My41Mzg4QzEyMy4wNDk2LDM3Ljg3NjQgMTM2Ljg5NiwzMy40Mzc0IDE0OC45MjIsMzMuOTMyN0MxNjAuOTQ2LDM0LjQyNzkgMTY3Ljg5OSw0MC4xNTI1IDE3OS41OCwzOC40ODY3QzE5MS4yNiwzNi44MjA2IDE5OC44MzQsMjQuOTkzMSAyMTAuNzUsMjQuOTkzMUMyMjIuNjY2LDI0Ljk5MzEgMjI4LjgxMywzNi45MDkyIDIzOS41LDM4LjQ4NjdDMjUwLjE4Nyw0MC4wNjczIDI1OC41OTgsMzIuODUwMSAyNjkuNSwzMy45MzI3QzI4MC40MDEsMzUuMDE0MyAyODYuNSw0MS45MTM4IDI5MSw1MC4zMzIyIiBzdHJva2U9IiMxZTI5MmIiIGZpbGw9Im5vbmUiIHN0cm9rZS1waWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PC9zdmc+'
            ], 
            'cert-completion' => [
                'id' => 'cert-completion', 
                'name' => 'Default Completion Certificate', 
                'title' => 'Certificate of Achievement', 
                'body' => "This is to certify that <strong>{candidateName}</strong> has successfully completed the rigorous requirements of the <strong>{examName}</strong> and is hereby awarded this certificate upon achieving a passing score of <strong>{finalScore}%</strong>.", 
                'signature1Name' => 'Amelia Reed', 
                'signature1Title' => 'Program Director', 
                'signature1ImageUrl' => 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCAzMDAgODAiPjxwYXRoIGQ9Ik0xMiw1My4zMjYxQzE2Ljg2NDcsNDcuMjQzNyAyOC43MjQ3LDQwLjM0NDIgNDEuMzQzOCw0NS4xMTM4QzUzLjM2Niw0OS42Njc3IDU5Ljk0ODksNTguNDg4NyA3Mi4zNDM4LDYxLjUxMTRDODQuNzM4OCw2NC41MzQgOTkuNDUwNCw2MC4zODI0IDExMS4yNSw1NC43MkMxMjMuMDQ5Niw0OS4wNTc2IDEzNi44OTYsNDQuNjE4NCAxNDguOTIyLDQ1LjExMzhDMTYwLjk0Niw0NS42MDkzIDE2Ny44OTksNTEuMzMzNyAxNzkuNTgsNDkuNjY3N0MxOTEuMjYsNDggMTk4LjgzNCwzNi4xNzQzIDIxMC43NSwzNi4xNzQzQzIyMi42NjYsMzYuMTc0MyAyMjguODEzLDQ4LjA4NjYgMjM5LjUsNDkuNjY3N0MyNTAuMTg3LDUxLjI0ODkgMjU4LjU5OCw0NC4wMzIxIDI2OS41LDQ1LjExMzhDMjgwLjQwMSw0Ni4xOTU1IDI4Ni41LDUzLjA5NSAyOTEsNjEuNTExNCIgc3Ryb2tlPSIjMWUyOTJiIiBmaWxsPSJub25lIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvc3ZnPg==', 
                'signature2Name' => 'Quinn Casey, CPC', 
                'signature2Title' => 'Lead Instructor',
                'signature2ImageUrl' => 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCAzMDAgODAiPjxwYXRoIGQ9Ik0xMiw0Mi4xNDQ4QzE2Ljg2NDcsMzYuMDYyNCAyOC43MjQ3LDI5LjE2MyA0MS4zNDM4LDMzLjkyMjdDNTMuMzY2LDM4LjQ4NjQgNTkuOTQ4OSw0Ny4zMDc1IDcyLjM0MzgsNTAuMzMyMkM4NC43Mzg4LDUzLjM1MjggOTkuNDUwNCw0OS4yMDEyIDExMS4yNSw0My41Mzg4QzEyMy4wNDk2LDM3Ljg3NjQgMTM2Ljg5NiwzMy40Mzc0IDE0OC45MjIsMzMuOTMyN0MxNjAuOTQ2LDM0LjQyNzkgMTY3Ljg5OSw0MC4xNTI1IDE3OS41OCwzOC40ODY3QzE5MS4yNiwzNi44MjA2IDE5OC44MzQsMjQuOTkzMSAyMTAuNzUsMjQuOTkzMUMyMjIuNjY2LDI0Ljk5MzEgMjI4LjgxMywzNi45MDkyIDIzOS41LDM4LjQ4NjdDMjUwLjE4Nyw0MC4wNjczIDI1OC41OTgsMzIuODUwMSAyNjkuNSwzMy45MzI3QzI4MC40MDEsMzUuMDE0MyAyODYuNSw0MS45MTM4IDI5MSw1MC4zMzIyIiBzdHJva2U9IiMxZTI5MmIiIGZpbGw9Im5vbmUiIHN0cm9rZS1waWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PC9zdmc+'
            ]
        ]; 
    }
}

// A unified function to generate either an empty blueprint or a full content snapshot.
function mco_get_full_snapshot_data($is_blueprint = false) {
    $site_name = get_bloginfo('name');
    $site_url_parts = parse_url(home_url());
    $site_host = $site_url_parts['host'] ?? 'default-site.com';
    $custom_logo_url = get_option('mco_custom_logo_url', '');
    $logo_url = !empty($custom_logo_url) ? $custom_logo_url : (get_site_icon_url(512) ?: '');

    $available_themes = [
        [ 'id' => 'default', 'name' => 'Cyberpunk' ],
        [ 'id' => 'professional', 'name' => 'Professional' ],
        [ 'id' => 'serene', 'name' => 'Serene' ],
        [ 'id' => 'academic', 'name' => 'Academic' ],
        [ 'id' => 'noir', 'name' => 'Noir' ],
    ];

    $configured_templates = get_option('mco_certificate_templates');
    if (empty($configured_templates) || !is_array($configured_templates)) {
        $configured_templates = mco_get_default_certificate_templates();
    }

    if ($is_blueprint) {
        $dynamic_data = [
            'exams' => [],
            'examProductCategories' => [],
            'suggestedBooks' => [],
            'examPrices' => new stdClass()
        ];
    } else {
        $dynamic_data = mco_get_app_config_data();
    }

    $snapshot_object = [
        "version" => get_option('mco_config_version', current_time('YmdHis')),
        "organizations" => [
            [
                "id" => "org-" . sanitize_title($site_name),
                "name" => $site_name,
                "website" => str_replace('www.', '', $site_host),
                "logo" => $logo_url,
                "introVideoUrl" => get_option('mco_intro_video_url', ''),
                "availableThemes" => $available_themes,
                "activeThemeId" => get_option('mco_active_theme_id', 'default'),
                "certificateThemeId" => get_option('mco_certificate_theme', 'classic'),
                "exams" => $dynamic_data['exams'],
                "examProductCategories" => $dynamic_data['examProductCategories'],
                "certificateTemplates" => array_values($configured_templates),
                "suggestedBooks" => $dynamic_data['suggestedBooks']
            ]
        ],
        "examPrices" => $dynamic_data['examPrices'] ?? new stdClass()
    ];
    
    return $snapshot_object;
}

// This function is the single source of truth for all dynamic data passed to the React app.
function mco_get_app_config_data() {
    $cached_data = get_transient('mco_app_config_data');
    if ($cached_data !== false) {
        return $cached_data;
    }

    $all_exams = [];
    $all_prices = [];
    $all_suggested_books = [];
    $exam_product_categories = [];

    // Step 1: Process Exam Programs
    $exam_program_posts = get_posts([
        'post_type' => 'mco_exam_program',
        'posts_per_page' => -1,
        'post_status' => 'publish'
    ]);

    foreach ($exam_program_posts as $post) {
        $program_id_for_app = 'prod-' . $post->ID;
        $practice_exam_id_for_app = 'exam-' . $program_id_for_app . '-practice';
        $clean_title = wp_strip_all_tags(get_the_title($post));

        $practice_name_override = get_post_meta($post->ID, '_mco_practice_exam_title_override', true);
        $cert_name_override = get_post_meta($post->ID, '_mco_cert_exam_title_override', true);

        $practice_exam_name = !empty($practice_name_override) ? $practice_name_override : $clean_title . ' Practice';
        $cert_exam_name = !empty($cert_name_override) ? $cert_name_override : $clean_title;

        $practice_exam_obj = mco_build_exam_object($post, true, $practice_exam_id_for_app, $practice_exam_name);
        $cert_exam_obj = mco_build_exam_object($post, false, null, $cert_exam_name);

        if ($practice_exam_obj) $all_exams[] = $practice_exam_obj;
        if ($cert_exam_obj) $all_exams[] = $cert_exam_obj;
        
        $exam_product_categories[] = [
            'id' => $program_id_for_app,
            'name' => $clean_title,
            'description' => apply_filters('the_content', $post->post_content),
            'practiceExamId' => $practice_exam_id_for_app,
            'certificationExamId' => $cert_exam_obj ? $cert_exam_obj['id'] : null,
        ];
    }

    // Step 2: Get ALL products from WooCommerce
    if (class_exists('WooCommerce')) {
        $all_wc_products = wc_get_products(['limit' => -1]);
        foreach ($all_wc_products as $product) {
            $sku = $product->get_sku();
            if ($sku) {
                $product_data = [
                    'price' => (float)$product->get_price(), 
                    'regularPrice' => (float)$product->get_regular_price(),
                    'productId' => $product->get_id(),
                    'name' => $product->get_name(),
                    'type' => $product->get_type(),
                    'isBundle' => $product->get_meta('_mco_is_bundle') === 'yes',
                    'bundledSkus' => $product->get_meta('_mco_bundled_skus', true) ?: [],
                    'avgRating' => (float)$product->get_average_rating(),
                    'reviewCount' => (int)$product->get_review_count()
                ];

                if (class_exists('WC_Product_Subscription') && $product->is_type('subscription')) {
                    $product_data['subscription_period'] = $product->get_subscription_period();
                    $product_data['subscription_period_interval'] = $product->get_subscription_period_interval();
                    $product_data['subscription_length'] = $product->get_subscription_length();
                }
                $all_prices[$sku] = $product_data;
            }
        }
    }

    // Step 3: Get all suggested books
    $book_posts = get_posts([
        'post_type' => 'mco_recommended_book',
        'posts_per_page' => -1,
        'post_status' => 'publish'
    ]);

    foreach($book_posts as $book) {
        $book_id_meta = get_post_meta($book->ID, '_mco_book_id', true);
        $book_id_to_use = !empty($book_id_meta) ? $book_id_meta : sanitize_title(get_the_title($book));
        
        $all_suggested_books[] = [
            'id' => $book_id_to_use,
            'title' => get_the_title($book),
            'description' => has_excerpt($book->ID) ? get_the_excerpt($book->ID) : wp_trim_words($book->post_content, 30),
            'thumbnailUrl' => get_post_meta($book->ID, '_mco_thumbnail_url', true),
            'affiliateLinks' => [
                'com' => get_post_meta($book->ID, '_mco_link_com', true),
                'in' => get_post_meta($book->ID, '_mco_link_in', true),
                'ae' => get_post_meta($book->ID, '_mco_link_ae', true),
            ]
        ];
    }
    
    // Build the final organizations object for the config
    $organizations_data = mco_get_full_snapshot_data(true)['organizations'];
    $organizations_data[0]['exams'] = $all_exams;
    $organizations_data[0]['examProductCategories'] = $exam_product_categories;
    $organizations_data[0]['suggestedBooks'] = $all_suggested_books;

    $data = [
        'organizations' => $organizations_data,
        'examPrices' => $all_prices,
    ];

    set_transient('mco_app_config_data', $data, HOUR_IN_SECONDS);
    return $data;
}

if (!function_exists('mco_get_single_term')) {
    function mco_get_single_term($post_id, $taxonomy, $field = 'name') {
        $terms = get_the_terms($post_id, $taxonomy);
        if (!empty($terms) && !is_wp_error($terms)) {
            return $terms[0]->$field;
        }
        return '';
    }
}

if (!function_exists('mco_build_exam_object')) {
    function mco_build_exam_object($post, $is_practice, $exam_id, $title_override) {
        $question_source = get_post_meta($post->ID, '_mco_question_source_url', true);
        if (empty($question_source)) return null;

        $pass_score = mco_get_single_term($post->ID, 'exam_pass_score', 'name');
        $exam_sections_json = get_post_meta($post->ID, '_mco_exam_sections', true);
        $exam_sections = !empty($exam_sections_json) ? json_decode($exam_sections_json, true) : null;
        $book_post_ids = get_post_meta($post->ID, '_mco_recommended_book_ids', true) ?: [];
        $recommended_book_ids = [];
        if (is_array($book_post_ids)) {
            foreach ($book_post_ids as $book_post_id) {
                $custom_id = get_post_meta($book_post_id, '_mco_book_id', true);
                if ($custom_id) {
                    $recommended_book_ids[] = $custom_id;
                }
            }
        }
        
        $exam_data = [
            'name' => $title_override,
            'description' => apply_filters('the_content', $post->post_content),
            'passScore' => (int)$pass_score,
            'questionSourceUrl' => $question_source,
            'isPractice' => $is_practice,
            'recommendedBookIds' => $recommended_book_ids,
            'sections' => $exam_sections,
            'price' => 0,
            'regularPrice' => 0,
            'productSku' => '',
            'productSlug' => '',
        ];

        if ($is_practice) {
            $exam_data['id'] = $exam_id;
            $exam_data['numberOfQuestions'] = (int)mco_get_single_term($post->ID, 'exam_practice_questions', 'name');
            $exam_data['durationMinutes'] = (int)mco_get_single_term($post->ID, 'exam_practice_duration', 'name');
            $exam_data['certificateEnabled'] = (bool)get_post_meta($post->ID, '_mco_practice_certificate_enabled', true);
            $exam_data['certificateTemplateId'] = 'cert-practice';
            $exam_data['isProctored'] = false;
        } else {
            $cert_sku = get_post_meta($post->ID, '_mco_certification_exam_sku', true);
            if (empty($cert_sku)) return null;

            $exam_data['id'] = $cert_sku;
            $exam_data['productSku'] = $cert_sku;
            $exam_data['numberOfQuestions'] = (int)mco_get_single_term($post->ID, 'exam_cert_questions', 'name');
            $exam_data['durationMinutes'] = (int)mco_get_single_term($post->ID, 'exam_cert_duration', 'name');
            $exam_data['isProctored'] = (bool)get_post_meta($post->ID, '_mco_is_proctored', true);
            $exam_data['certificateEnabled'] = (bool)get_post_meta($post->ID, '_mco_certificate_enabled', true);
            $exam_data['certificateTemplateId'] = 'cert-completion';

            if ($cert_sku && class_exists('WooCommerce') && function_exists('wc_get_product_id_by_sku')) {
                $product_id = wc_get_product_id_by_sku($cert_sku);
                if ($product_id) {
                    $product = wc_get_product($product_id);
                    if ($product) {
                        $exam_data['price'] = (float)$product->get_price();
                        $exam_data['regularPrice'] = (float)$product->get_regular_price();
                        $exam_data['productSlug'] = $product->get_slug();
                    }
                }
            }
        }
        return $exam_data;
    }
}
?>