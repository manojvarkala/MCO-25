<?php
if (!defined('ABSPATH')) exit;

if (!function_exists('mco_get_default_certificate_templates')) {
    function mco_get_default_certificate_templates() { 
        return [
            'cert-practice' => [
                'id' => 'cert-practice', 
                'name' => 'Default Practice Certificate', 
                'title' => 'Certificate of Proficiency', 
                'body' => "This certifies that <strong>{candidateName}</strong> has successfully demonstrated proficiency in the <strong>{examName}</strong> practice exam, achieving a score of <strong>{finalScore}%</strong>.", 
                'signature1Name' => 'Amelia Reed', 
                'signature1Title' => 'Program Director', 
                'signature1ImageUrl' => '', 
                'signature2Name' => '', 
                'signature2Title' => '',
                'signature2ImageUrl' => ''
            ], 
            'cert-completion' => [
                'id' => 'cert-completion', 
                'name' => 'Default Completion Certificate', 
                'title' => 'Certificate of Achievement', 
                'body' => "This is to certify that <strong>{candidateName}</strong> has successfully completed the rigorous requirements of the <strong>{examName}</strong> and is hereby awarded this certificate upon achieving a passing score of <strong>{finalScore}%</strong>.", 
                'signature1Name' => 'Amelia Reed', 
                'signature1Title' => 'Program Director', 
                'signature1ImageUrl' => '', 
                'signature2Name' => 'Quinn Casey, CPC', 
                'signature2Title' => 'Lead Instructor',
                'signature2ImageUrl' => ''
            ]
        ]; 
    }
}

function mco_get_full_snapshot_data($is_blueprint = false) {
    $site_name = get_bloginfo('name');
    $site_url_parts = parse_url(home_url());
    $site_host = $site_url_parts['host'] ?? 'default-site.com';
    $custom_logo_url = get_option('mco_custom_logo_url', '');
    $logo_url = !empty($custom_logo_url) ? $custom_logo_url : (get_site_icon_url(512) ?: '');

    $available_themes = [
        [ 'id' => 'default', 'name' => 'Cyberpunk' ],
        [ 'id' => 'professional', 'name' => 'Professional' ],
        [ 'id' => 'serene', 'name' => 'Serene' ],
        [ 'id' => 'academic', 'name' => 'Academic' ],
        [ 'id' => 'noir', 'name' => 'Noir' ],
    ];

    $configured_templates = get_option('mco_certificate_templates');
    if (empty($configured_templates) || !is_array($configured_templates)) {
        $configured_templates = mco_get_default_certificate_templates();
    }

    if ($is_blueprint) {
        $dynamic_data = [
            'exams' => [],
            'examProductCategories' => [],
            'suggestedBooks' => [],
            'examPrices' => new stdClass()
        ];
    } else {
        $dynamic_data = mco_get_app_config_data();
    }

    $snapshot_object = [
        "version" => current_time('YmdHis'),
        "organizations" => [
            [
                "id" => "org-" . sanitize_title($site_name),
                "name" => $site_name,
                "website" => $site_host,
                "logo" => $logo_url,
                "availableThemes" => $available_themes,
                "activeThemeId" => "default",
                "exams" => $dynamic_data['exams'],
                "examProductCategories" => $dynamic_data['examProductCategories'],
                "certificateTemplates" => array_values($configured_templates),
                "suggestedBooks" => $dynamic_data['suggestedBooks']
            ]
        ],
        "examPrices" => $dynamic_data['examPrices'] ?? new stdClass()
    ];
    
    return $snapshot_object;
}


function mco_get_app_config_data() {
    $cached_data = get_transient('mco_app_config_data');
    if ($cached_data !== false) {
        return $cached_data;
    }

    $all_exams = [];
    $all_prices = [];
    $all_suggested_books = [];
    $exam_product_categories = [];

    $exam_program_posts = get_posts([
        'post_type' => 'mco_exam_program',
        'posts_per_page' => -1,
        'post_status' => 'publish'
    ]);

    foreach ($exam_program_posts as $post) {
        $practice_questions = get_post_meta($post->ID, '_mco_practice_questions', true);
        $practice_duration = get_post_meta($post->ID, '_mco_practice_duration', true);
        $cert_questions = get_post_meta($post->ID, '_mco_cert_questions', true);
        $cert_duration = get_post_meta($post->ID, '_mco_cert_duration', true);
        $pass_score = get_post_meta($post->ID, '_mco_pass_score', true);
        
        $cert_sku = get_post_meta($post->ID, '_mco_certification_exam_sku', true);
        $question_source = get_post_meta($post->ID, '_mco_question_source_url', true);
        
        $is_proctored = (bool) get_post_meta($post->ID, '_mco_is_proctored', true);
        $certificate_enabled_meta = get_post_meta($post->ID, '_mco_certificate_enabled', true);
        $certificate_enabled = ($certificate_enabled_meta === '') ? true : (bool) $certificate_enabled_meta;

        $practice_name_override = get_post_meta($post->ID, '_mco_practice_exam_title_override', true);
        $cert_name_override = get_post_meta($post->ID, '_mco_cert_exam_title_override', true);
        
        $exam_sections_json = get_post_meta($post->ID, '_mco_exam_sections', true);
        $exam_sections = !empty($exam_sections_json) ? json_decode($exam_sections_json, true) : null;

        $book_post_ids = get_post_meta($post->ID, '_mco_recommended_book_ids', true) ?: [];
        $recommended_book_ids = [];
        if (is_array($book_post_ids)) {
            foreach ($book_post_ids as $book_post_id) {
                $custom_id = get_post_meta($book_post_id, '_mco_book_id', true);
                if ($custom_id) {
                    $recommended_book_ids[] = $custom_id;
                }
            }
        }

        $program_id_for_app = 'prod-' . $post->ID;
        $practice_exam_id_for_app = 'exam-' . $program_id_for_app . '-practice';
        
        $image_url = '';
        if ($cert_sku && function_exists('wc_get_product_id_by_sku')) {
            $product_id = wc_get_product_id_by_sku($cert_sku);
            if ($product_id) {
                $image_url = get_the_post_thumbnail_url($product_id, 'medium_large') ?: '';
            }
        }

        $clean_title = wp_strip_all_tags(get_the_title($post));
        
        $exam_product_categories[] = [
            'id' => $program_id_for_app,
            'name' => $clean_title,
            'description' => apply_filters('the_content', $post->post_content),
            'practiceExamId' => $practice_exam_id_for_app,
            'certificationExamId' => $cert_sku,
            'questionSourceUrl' => $question_source,
        ];
        
        $practice_exam_name = !empty($practice_name_override) ? $practice_name_override : $clean_title . ' Practice';
        $cert_exam_name = !empty($cert_name_override) ? $cert_name_override : $clean_title;

        $all_exams[] = [
            'id' => $practice_exam_id_for_app,
            'name' => $practice_exam_name,
            'description' => 'A practice test to assess your knowledge for the ' . $clean_title . '.',
            'price' => 0,
            'productSku' => 'practice-' . $cert_sku,
            'numberOfQuestions' => (int)$practice_questions,
            'passScore' => (int)$pass_score,
            'certificateTemplateId' => 'cert-practice',
            'isPractice' => true,
            'certificateEnabled' => false,
            'isProctored' => false,
            'durationMinutes' => (int)$practice_duration,
            'questionSourceUrl' => $question_source,
            'recommendedBookIds' => $recommended_book_ids,
            'imageUrl' => $image_url,
            'sections' => $exam_sections,
        ];
        
        if ($cert_sku && class_exists('WooCommerce')) {
            $product_id = wc_get_product_id_by_sku($cert_sku);
            $product = $product_id ? wc_get_product($product_id) : null;
            if ($product) {
                 $all_exams[] = [
                    'id' => $cert_sku,
                    'name' => $cert_exam_name,
                    'description' => apply_filters('the_content', $post->post_content),
                    'price' => (float)$product->get_price(),
                    'regularPrice' => (float)$product->get_regular_price(),
                    'productSku' => $cert_sku,
                    'productSlug' => $product->get_slug(),
                    'numberOfQuestions' => (int)$cert_questions,
                    'passScore' => (int)$pass_score,
                    'certificateTemplateId' => 'cert-completion',
                    'isPractice' => false,
                    'certificateEnabled' => $certificate_enabled,
                    'isProctored' => $is_proctored,
                    'durationMinutes' => (int)$cert_duration,
                    'questionSourceUrl' => $question_source,
                    'recommendedBookIds' => $recommended_book_ids,
                    'imageUrl' => $image_url,
                    'sections' => $exam_sections,
                ];
            }
        }
    }

    if (class_exists('WooCommerce')) {
        $all_wc_products = wc_get_products(['limit' => -1]);
        foreach ($all_wc_products as $product) {
            $sku = $product->get_sku();
            if ($sku) {
                $product_data = [
                    'price' => (float)$product->get_price(), 
                    'regularPrice' => (float)$product->get_regular_price(),
                    'productId' => $product->get_id(),
                    'name' => $product->get_name(),
                    'type' => $product->get_type(),
                    'isBundle' => $product->get_meta('_mco_is_bundle') === 'yes',
                    'bundledSkus' => $product->get_meta('_mco_bundled_skus', true) ?: [],
                    'avgRating' => (float)$product->get_average_rating(),
                    'reviewCount' => (int)$product->get_review_count()
                ];

                if (class_exists('WC_Product_Subscription') && $product->is_type('subscription')) {
                    $product_data['subscription_period'] = $product->get_subscription_period();
                    $product_data['subscription_period_interval'] = $product->get_subscription_period_interval();
                    $product_data['subscription_length'] = $product->get_subscription_length();
                }

                $all_prices[$sku] = $product_data;
            }
        }
    }

    $book_posts = get_posts([
        'post_type' => 'mco_recommended_book',
        'posts_per_page' => -1,
        'post_status' => 'publish'
    ]);

    foreach($book_posts as $book) {
        $all_suggested_books[] = [
            'id' => get_post_meta($book->ID, '_mco_book_id', true),
            'title' => get_the_title($book),
            'description' => has_excerpt($book->ID) ? get_the_excerpt($book->ID) : wp_trim_words($book->post_content, 30),
            'thumbnailUrl' => get_post_meta($book->ID, '_mco_thumbnail_url', true),
            'affiliateLinks' => [
                'com' => get_post_meta($book->ID, '_mco_link_com', true),
                'in' => get_post_meta($book->ID, '_mco_link_in', true),
                'ae' => get_post_meta($book->ID, '_mco_link_ae', true),
            ]
        ];
    }

    $data = [
        'exams' => $all_exams,
        'examProductCategories' => $exam_product_categories,
        'suggestedBooks' => $all_suggested_books,
        'examPrices' => $all_prices,
    ];

    set_transient('mco_app_config_data', $data, HOUR_IN_SECONDS);
    return $data;
}
?>