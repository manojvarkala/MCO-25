<?php
if (!defined('ABSPATH')) exit;

/**
 * Automatically completes WooCommerce orders for virtual products after payment.
 * This ensures users get immediate access to digital products like exams.
 */
add_action( 'woocommerce_payment_complete', 'custom_auto_complete_virtual_order_after_payment' );

function custom_auto_complete_virtual_order_after_payment( $order_id ) {
    if ( ! $order_id ) {
        return;
    }

    $order = wc_get_order( $order_id );

    // If the order isn't valid or has a status that shouldn't be auto-completed, exit.
    if ( ! $order || $order->has_status( array( 'completed', 'failed', 'cancelled', 'refunded' ) ) ) {
        return;
    }

    $is_virtual_order = true;
    
    // Check if every item in the order is a virtual product.
    if ( count( $order->get_items() ) > 0 ) {
        foreach ( $order->get_items() as $item ) {
            $product = $item->get_product();
            // If we find any product that is NOT virtual, we stop.
            if ( ! $product || !$product->is_virtual() ) {
                $is_virtual_order = false;
                break;
            }
        }
    } else {
        // No items in the order.
        $is_virtual_order = false;
    }
    
    // If all products in the order are indeed virtual, update the status to 'completed'.
    if ( $is_virtual_order ) {
        $order->update_status( 'completed', 'Order automatically completed as it only contains virtual items.' );
    }
}