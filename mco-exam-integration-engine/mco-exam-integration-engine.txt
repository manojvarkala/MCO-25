<?php
/**
 * Plugin Name:       MCO Exam Integration Engine
 * Plugin URI:        https://annapoornainfo.com
 * Description:       A modular, high-performance backend for the React Examination App.
 * Version:           5.2.4
 * Author:            Annapoorna Infotech
 * License:           GPL v2 or later
 */

if (!defined('ABSPATH')) exit;

// --- CONSTANTS ---
define('MCO_PLUGIN_FILE', __FILE__);
define('MCO_PLUGIN_PATH', plugin_dir_path(MCO_PLUGIN_FILE));
define('MCO_PLUGIN_URL', plugin_dir_url(MCO_PLUGIN_FILE));
define('MCO_VERSION', '5.2.4');

/**
 * 1. SECURITY & CORS (Load First)
 * Handles Preflight and exact-origin handshaking to fix "Connection Blocked" errors.
 */
require_once MCO_PLUGIN_PATH . 'includes/mco-security.php';

/**
 * 2. DATA MODELS & CPTS
 */
require_once MCO_PLUGIN_PATH . 'includes/mco-cpts.php';
require_once MCO_PLUGIN_PATH . 'includes/mco-data.php'; 

/**
 * 3. API ORCHESTRATION
 */
require_once MCO_PLUGIN_PATH . 'includes/mco-api-handlers.php';
require_once MCO_PLUGIN_PATH . 'includes/mco-api-routes.php';

/**
 * 4. WORDPRESS UI INTEGRATION
 */
require_once MCO_PLUGIN_PATH . 'includes/mco-admin.php'; 
require_once MCO_PLUGIN_PATH . 'includes/mco-shortcodes.php'; 

// --- ACTIVATION ---
register_activation_hook(__FILE__, function() {
    flush_rewrite_rules();
    if (!get_option('mco_config_version')) {
        update_option('mco_config_version', time());
    }
});

add_filter('option_users_can_register', function($value) {
    return (bool)get_option('mco_force_enable_registration', false) ? 1 : $value;
});

/**
 * 5. GLOBAL CACHE INVALIDATION HOOK
 * Automatically clears transients when content changes in standard WP admin.
 */
add_action('transition_post_status', function($new_status, $old_status, $post) {
    $watched_types = ['mco_exam_program', 'mco_recommended_book', 'product'];
    if (in_array($post->post_type, $watched_types)) {
        delete_transient('mco_app_config_data');
        delete_transient('mco_app_config_data_full');
        update_option('mco_config_version', time());
    }
}, 10, 3);
