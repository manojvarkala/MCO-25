
<?php
/**
 * Plugin Name:       MCO Exam Integration Engine
 * Plugin URI:        https://annapoornainfo.com
 * Description:       Provides the backend API, user authentication (SSO), and content management for the React-based examination app.
 * Version:           2.7.7
 * Author:            Annapoorna Infotech
 * Author URI:        https://annapoornainfo.com
 * License:           GPL v2 or later
 * License URI:       https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain:       mco-exam-engine
 */
if (!defined('ABSPATH')) exit;

// --- CONSTANTS ---
define('MCO_PLUGIN_FILE', __FILE__);
define('MCO_PLUGIN_PATH', plugin_dir_path(MCO_PLUGIN_FILE));
define('MCO_PLUGIN_URL', plugin_dir_url(MCO_PLUGIN_FILE));
$plugin_data = get_file_data(MCO_PLUGIN_FILE, array('Version' => 'Version'));
define('MCO_PLUGIN_VERSION', $plugin_data['Version']);

// --- INCLUDES ---
// FIX: Corrected the include order to resolve fatal errors from dependency issues.
// API functions must be loaded before admin pages or shortcodes that use them.
require_once MCO_PLUGIN_PATH . 'includes/mco-cpts.php';
require_once MCO_PLUGIN_PATH . 'includes/mco-data.php';
require_once MCO_PLUGIN_PATH . 'includes/mco-api.php';
require_once MCO_PLUGIN_PATH . 'includes/mco-admin.php';
require_once MCO_PLUGIN_PATH . 'includes/mco-shortcodes.php';

// --- MAIN HOOKS ---
add_action('init', 'mco_register_custom_post_types');
add_action('rest_api_init', 'mco_register_rest_routes');
add_action('rest_pre_serve_request', 'mco_add_cors_and_nocache_headers', 10, 4);
add_action('rest_api_init', 'mco_set_api_nocache_constants', 10, 1);
mco_register_admin_hooks();
mco_register_shortcode_hooks();

// --- SINGLE SIGN-ON REDIRECT ---
function mco_sso_login_redirect() {
    // Check if we have the specific trigger from our form handler OR if we're just on the login page and already logged in
    global $post;
    if (is_user_logged_in() && (isset($_GET['mco_sso_trigger']) || (is_a($post, 'WP_Post') && has_shortcode($post->post_content, 'mco_exam_login')))) {
        
        // If we are on the login page and logged in, let's verify the user has a full name first
        $user = wp_get_current_user();
        if (strpos($user->display_name, ' ') === false && !isset($_POST['mco_update_name_action'])) {
            // Name not set, let the shortcode render the name update form instead of redirecting
            return;
        }

        $app_url = mco_get_exam_app_url();
        if (!$app_url) {
            // If no app URL configured, we can't redirect. 
            return; 
        }
        
        $token = mco_generate_exam_jwt(get_current_user_id());
        if (!$token) {
            wp_die('Could not generate authentication token. Please ensure MCO_JWT_SECRET is defined in wp-config.php.');
        }
        
        $redirect_url = add_query_arg('token', $token, rtrim($app_url, '/') . '/auth');
        
        // Prevent caching of this redirect to avoid infinite loops
        nocache_headers();
        
        wp_redirect($redirect_url);
        exit;
    }
}
add_action('template_redirect', 'mco_sso_login_redirect');

?>