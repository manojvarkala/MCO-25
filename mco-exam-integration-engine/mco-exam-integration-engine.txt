<?php
/**
 * Plugin Name:       MCO Exam Integration Engine
 * Plugin URI:        https://annapoornainfo.com
 * Description:       Provides the backend API, user authentication (SSO), and content management for the React-based examination app.
 * Version:           2.8.0
 * Author:            Annapoorna Infotech
 * Author URI:        https://annapoornainfo.com
 * License:           GPL v2 or later
 * License URI:       https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain:       mco-exam-engine
 */
if (!defined('ABSPATH')) exit;

// --- CONSTANTS ---
define('MCO_PLUGIN_FILE', __FILE__);
define('MCO_PLUGIN_PATH', plugin_dir_path(MCO_PLUGIN_FILE));
define('MCO_PLUGIN_URL', plugin_dir_url(MCO_PLUGIN_FILE));
$plugin_data = get_file_data(MCO_PLUGIN_FILE, array('Version' => 'Version'));
define('MCO_PLUGIN_VERSION', $plugin_data['Version']);

// --- INCLUDES ---
require_once MCO_PLUGIN_PATH . 'includes/mco-cpts.php';
require_once MCO_PLUGIN_PATH . 'includes/mco-data.php';
require_once MCO_PLUGIN_PATH . 'includes/mco-api.php';
require_once MCO_PLUGIN_PATH . 'includes/mco-admin.php';
require_once MCO_PLUGIN_PATH . 'includes/mco-shortcodes.php';

// --- MAIN HOOKS ---
add_action('init', 'mco_register_custom_post_types');
add_action('rest_api_init', 'mco_register_rest_routes');
add_action('rest_pre_serve_request', 'mco_add_cors_and_nocache_headers', 10, 4);
add_action('rest_api_init', 'mco_set_api_nocache_constants', 10, 1);
mco_register_admin_hooks();
mco_register_shortcode_hooks();

// --- FORCE REGISTRATION OPTION ---
add_filter('option_users_can_register', 'mco_force_registration_option');
function mco_force_registration_option($value) {
    if (get_option('mco_force_enable_registration')) {
        return 1;
    }
    return $value;
}

// --- SINGLE SIGN-ON & LOGIN REDIRECTS ---
function mco_sso_login_redirect() {
    global $post;
    
    // Detect if we are on the exam login page (via shortcode)
    $is_login_page = is_a($post, 'WP_Post') && has_shortcode($post->post_content, 'mco_exam_login');
    
    // 1. HANDLE LOGGED OUT USERS (Force Redirect to WP Login)
    if ($is_login_page && !is_user_logged_in()) {
        // Prevent caching
        nocache_headers();
        // Redirect to WP Login, set return URL to this page
        $current_url = get_permalink();
        $login_url = wp_login_url($current_url);
        wp_redirect($login_url);
        exit;
    }

    // 2. HANDLE LOGGED IN USERS (SSO Redirect to App)
    if (is_user_logged_in() && (isset($_GET['mco_sso_trigger']) || $is_login_page)) {
        
        $user = wp_get_current_user();
        
        // If user hasn't set a full name yet, stop here.
        // The shortcode will render the "Update Name" form.
        if (strpos($user->display_name, ' ') === false && !isset($_POST['mco_update_name_action'])) {
            return;
        }

        $app_url = mco_get_exam_app_url();
        if (!$app_url) return; // Config missing
        
        $token = mco_generate_exam_jwt(get_current_user_id());
        if (!$token) {
            wp_die('Could not generate authentication token. Ensure MCO_JWT_SECRET is defined in wp-config.php.');
        }
        
        $redirect_url = add_query_arg('token', $token, rtrim($app_url, '/') . '/auth');
        
        nocache_headers();
        wp_redirect($redirect_url);
        exit;
    }
}
add_action('template_redirect', 'mco_sso_login_redirect');

?>