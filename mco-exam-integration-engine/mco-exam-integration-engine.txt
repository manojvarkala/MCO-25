<?php
/**
 * Plugin Name:       Annapoorna Advantage 
 * Plugin URI:        https://annapoornainfo.com
 * Description:       A modular, high-performance backend for the React Examination App.
 * Version:           5.2.4
 * Author:            Annapoorna Infotech
 * License:           GPL v2 or later
 */

if (!defined('ABSPATH')) exit;

// --- CONSTANTS ---
define('MCO_PLUGIN_FILE', __FILE__);
define('MCO_PLUGIN_PATH', plugin_dir_path(MCO_PLUGIN_FILE));
define('MCO_PLUGIN_URL', plugin_dir_url(MCO_PLUGIN_FILE));
define('MCO_VERSION', '5.2.4');

/**
 * 1. SECURITY & CORS (Load First)
 * Handles Preflight and exact-origin handshaking to fix "Connection Blocked" errors.
 */
require_once MCO_PLUGIN_PATH . 'includes/mco-security.php';

/**
 * 2. DATA MODELS & CPTS
 */
require_once MCO_PLUGIN_PATH . 'includes/mco-cpts.php';
require_once MCO_PLUGIN_PATH . 'includes/mco-data.php'; 

/**
 * 3. API ORCHESTRATION
 */
require_once MCO_PLUGIN_PATH . 'includes/mco-api-handlers.php';
require_once MCO_PLUGIN_PATH . 'includes/mco-api-routes.php';

/**
 * 4. COMMERCE INTEGRATION
 */
require_once MCO_PLUGIN_PATH . 'includes/mco-woocommerce.php';

/**
 * 5. WORDPRESS UI INTEGRATION
 */
require_once MCO_PLUGIN_PATH . 'includes/mco-admin.php'; 
require_once MCO_PLUGIN_PATH . 'includes/mco-shortcodes.php'; 

// --- ACTIVATION LOGIC ---
function mco_engine_activate() {
    flush_rewrite_rules();
    if (!get_option('mco_config_version')) {
        update_option('mco_config_version', time());
    }
}
register_activation_hook(__FILE__, 'mco_engine_activate');

// --- REGISTRATION OVERRIDE ---
function mco_force_enable_user_registration($value) {
    // If the plugin setting is active, force the core 'users_can_register' option to true
    $force_enabled = get_option('mco_force_enable_registration', false);
    return (bool)$force_enabled ? 1 : $value;
}
add_filter('option_users_can_register', 'mco_force_enable_user_registration');

/**
 * 6. GLOBAL CACHE INVALIDATION
 * Automatically clears transients when content changes in standard WP admin.
 */
function mco_invalidate_app_cache_on_save($new_status, $old_status, $post) {
    if (!$post || !isset($post->post_type)) {
        return;
    }

    $watched_types = array('mco_exam_program', 'mco_recommended_book', 'product');
    
    if (in_array($post->post_type, $watched_types)) {
        delete_transient('mco_app_config_data');
        delete_transient('mco_app_config_data_full');
        // Update version to force frontend cache refresh
        update_option('mco_config_version', time());
    }
}
add_action('transition_post_status', 'mco_invalidate_app_cache_on_save', 10, 3);
