<?php
/**
 * Plugin Name:       MCO Exam Integration Engine
 * Plugin URI:        https://annapoornainfo.com
 * Description:       Provides the backend API, user authentication (SSO), and content management for the React-based examination app.
 * Version:           2.2.0
 * Author:            Annapoorna Infotech
 * Author URI:        https://annapoornainfo.com
 * License:           GPL v2 or later
 * License URI:       https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain:       mco-exam-engine
 * Update URI:        false
 */
if (!defined('ABSPATH')) exit;

// --- CONSTANTS & INCLUDES ---
define('MCO_PLUGIN_FILE', __FILE__);
define('MCO_PLUGIN_PATH', plugin_dir_path(MCO_PLUGIN_FILE));
define('MCO_PLUGIN_URL', plugin_dir_url(MCO_PLUGIN_FILE));
$plugin_data = get_file_data(MCO_PLUGIN_FILE, array('Version' => 'Version'));
define('MCO_PLUGIN_VERSION', $plugin_data['Version']);

require_once MCO_PLUGIN_PATH . 'includes/mco-cpts.txt';
require_once MCO_PLUGIN_PATH . 'includes/mco-data.txt';
require_once MCO_PLUGIN_PATH . 'includes/mco-api.txt';
require_once MCO_PLUGIN_PATH . 'includes/mco-shortcodes.txt';
require_once MCO_PLUGIN_PATH . 'includes/mco-admin.txt';

// --- INITIALIZATION HOOKS ---
add_action('init', function() {
    mco_register_custom_post_types();
    mco_register_shortcode_hooks();
    if (is_admin()) {
        mco_register_admin_hooks();
    }
});

// Centralized hook for all REST API related setup.
add_action('rest_api_init', 'mco_rest_api_cors_init');

/**
 * Main setup function for the REST API.
 * Registers routes and sets up crucial security filters for CORS.
 */
function mco_rest_api_cors_init() {
    // This is the main hook where all API routes are registered.
    // It's defined within mco-api.php to keep route definitions organized.
    mco_register_api_hooks(); 

    // Add filters to handle CORS headers for both successful responses and authentication errors.
    add_filter('rest_pre_serve_request', 'mco_handle_cors_and_preflight', 15, 4);
    add_filter('rest_authentication_errors', 'mco_handle_auth_errors_cors', 15);
}


// --- ROBUST CORS & PREFLIGHT HANDLING ---

/**
 * Handles CORS headers for all API requests and properly responds to preflight OPTIONS requests.
 */
function mco_handle_cors_and_preflight($served, $result, $request, $server) {
    // Only apply this logic to our custom namespace
    if (strpos($request->get_route(), '/mco-app/v1/') !== false) {
        $origin = get_http_origin();
        $allowed_origins = mco_get_allowed_origins();

        if ($origin && in_array($origin, $allowed_origins, true)) {
            $server->send_header('Access-Control-Allow-Origin', $origin);
            $server->send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, DELETE');
            $server->send_header('Access-Control-Allow-Credentials', 'true');
            $server->send_header('Access-Control-Allow-Headers', 'Authorization, X-WP-Nonce, Content-Type, X-Requested-With');
            $server->send_header('Vary', 'Origin');
        }
        
        // If this is a preflight OPTIONS request, send a 200 OK and exit.
        if ($request->get_method() === 'OPTIONS') {
            // Setting status_header(200) is crucial for the browser to accept the preflight.
            status_header(200);
            // This is "served", so we should exit to prevent WordPress from continuing.
            // Returning true from the filter is not enough for OPTIONS requests.
            exit();
        }
    }
    return $served;
}

/**
 * Ensures that even authentication error responses get the correct CORS headers.
 * This allows the frontend app to properly handle "session expired" errors instead of showing a generic network error.
 */
function mco_handle_auth_errors_cors($result) {
    if (!empty($result) && is_wp_error($result) && !headers_sent()) {
        $origin = get_http_origin();
        $allowed_origins = mco_get_allowed_origins();
        if ($origin && in_array($origin, $allowed_origins, true)) {
            header('Access-Control-Allow-Origin: ' . esc_url_raw($origin));
            header('Access-Control-Allow-Credentials: true');
            header('Vary: Origin');
        }
    }
    return $result;
}


// --- ACTIVATION & DEACTIVATION HOOKS ---

register_activation_hook(MCO_PLUGIN_FILE, function() {
    mco_register_custom_post_types();
    flush_rewrite_rules();
    // Clear the config cache on activation to ensure the latest data structure is loaded.
    delete_transient('mco_app_config_data');
});

register_deactivation_hook(MCO_PLUGIN_FILE, function() {
    flush_rewrite_rules();
});
?>